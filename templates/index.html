<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ í•™ìŠµ í”Œë ˆì´ì–´</title>
    
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            display: flex;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        
        /* VSCode style layout */
        .activity-bar {
            width: 48px;
            background: #333333;
            border-right: 1px solid #444444;
            display: flex;
            flex-direction: column;
            padding: 8px 0;
        }
        
        .activity-item {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888888;
            font-size: 1.2em;
            border: none;
            background: none;
            transition: all 0.2s;
        }
        
        .activity-item:hover {
            background: #444444;
            color: #cccccc;
        }
        
        .activity-item.active {
            background: #0e639c;
            color: #ffffff;
            border-left: 2px solid #ffffff;
        }
        
        /* ë‹¨ì–´ í´ë¦­ ìŠ¤íƒ€ì¼ */
        .interactive-word {
            cursor: pointer;
            border-bottom: 1px dotted rgba(255,255,255,0.2);
            transition: all 0.2s ease;
            padding: 1px 2px;
            border-radius: 2px;
        }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loading-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid #333;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ë‹¨ì–´ì¥ ì¶”ê°€ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        .vocab-added {
            background: rgba(76, 175, 80, 0.2) !important;
            border: 1px solid #4CAF50 !important;
        }
        
        /* ë‚œì´ë„ë³„ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ */
        .difficulty-easy {
            color: #81C784 !important; /* ì—°í•œ ì´ˆë¡ - ì‰¬ìš´ ë‹¨ì–´ */
            border-bottom-color: rgba(129, 199, 132, 0.3) !important;
        }
        
        .difficulty-medium {
            color: #FFB74D !important; /* ì£¼í™© - ì¤‘ê°„ ë‹¨ì–´ */
            border-bottom-color: rgba(255, 183, 77, 0.3) !important;
        }
        
        .difficulty-hard {
            color: #F06292 !important; /* ë¶„í™ - ì–´ë ¤ìš´ ë‹¨ì–´ */
            border-bottom-color: rgba(240, 98, 146, 0.3) !important;
        }
        
        .difficulty-very-hard {
            color: #E57373 !important; /* ë¹¨ê°• - ë§¤ìš° ì–´ë ¤ìš´ ë‹¨ì–´ */
            border-bottom-color: rgba(229, 115, 115, 0.3) !important;
            font-weight: 600;
        }
        
        
        /* ë¬¸ë²• íŒ¨í„´ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        .grammar-conditional {
            background: linear-gradient(90deg, #2196F3, #21CBF3);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(33, 150, 243, 0.3);
        }
        
        .grammar-time {
            background: linear-gradient(90deg, #9C27B0, #E91E63);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(156, 39, 176, 0.3);
        }
        
        .grammar-cause {
            background: linear-gradient(90deg, #FF9800, #FF5722);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(255, 152, 0, 0.3);
        }
        
        .grammar-contrast {
            background: linear-gradient(90deg, #F44336, #E91E63);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(244, 67, 54, 0.3);
        }
        
        .grammar-passive {
            background: linear-gradient(90deg, #607D8B, #455A64);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(96, 125, 139, 0.3);
        }
        
        .grammar-perfect {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(76, 175, 80, 0.3);
        }
        
        .grammar-future {
            background: linear-gradient(90deg, #00BCD4, #03A9F4);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0, 188, 212, 0.3);
        }
        
        .grammar-modal {
            background: linear-gradient(90deg, #795548, #5D4037);
            color: white !important;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(121, 85, 72, 0.3);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .sidebar {
            width: 300px;
            min-width: 200px;
            max-width: 600px;
            background: #252526;
            border-right: 1px solid #444444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            border-right: none;
            overflow: hidden;
        }
        
        .sidebar.collapsed .sidebar-content {
            display: none;
        }
        
        .sidebar.collapsed .sidebar-resizer {
            display: none;
        }
        
        .sidebar-resizer {
            position: absolute;
            right: -5px;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: rgba(14, 99, 156, 0.1);
            z-index: 1001;
            border-right: 2px solid transparent;
        }
        
        .sidebar-resizer:hover {
            background: rgba(14, 99, 156, 0.3) !important;
            border-right: 2px solid #0e639c !important;
        }
        
        .sidebar-header {
            padding: 10px 15px;
            border-bottom: 1px solid #444444;
            font-size: 0.9em;
            font-weight: bold;
            text-transform: uppercase;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .main-content {
            flex: 1;
            background: #1e1e1e;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .right-sidebar {
            width: 400px;
            min-width: 300px;
            max-width: 800px;
            background: #252526;
            border-left: 1px solid #444444;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        .right-sidebar.collapsed {
            width: 0;
            min-width: 0;
            border-left: none;
        }
        
        .right-sidebar-resizer {
            position: absolute;
            left: -15px;
            top: 0;
            bottom: 0;
            width: 30px;
            cursor: ew-resize;
            background: rgba(14, 99, 156, 0.1);
            z-index: 1001;
            border-left: 2px solid transparent;
            pointer-events: auto;
        }
        
        .right-sidebar-resizer:hover {
            background: rgba(14, 99, 156, 0.7) !important;
            border-left: 3px solid #0e639c !important;
        }
        
        .right-sidebar-header {
            padding: 10px 15px;
            border-bottom: 1px solid #444444;
            font-size: 0.9em;
            font-weight: bold;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-toggle {
            background: none;
            border: none;
            color: #888888;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        
        .sidebar-toggle:hover {
            background: #444444;
            color: #cccccc;
        }
        
        .right-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        /* Media player */
        .media-player {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        /* ë¹„ë””ì˜¤ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        video#videoPlayer {
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            max-height: 70vh !important;
            object-fit: contain !important;
            background: #000000;
        }
        
        /* ë©”ì¸ ì½˜í…ì¸  ë°˜ì‘í˜• */
        .main-content {
            transition: width 0.3s ease;
        }
        
        /* Sentences */
        .chapter-section {
            margin: 20px 0;
            border: 1px solid #444444;
            border-radius: 5px;
            background: #252526;
        }
        
        .chapter-header {
            background: #333333;
            padding: 15px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .chapter-header:hover {
            background: #404040;
        }
        
        .chapter-title {
            font-weight: bold;
            color: #cccccc;
        }
        
        .chapter-info {
            font-size: 0.9em;
            color: #858585;
        }
        
        .chapter-content {
            padding: 10px;
        }
        
        .scene-section {
            margin: 15px 0;
            border: 1px solid #555555;
            border-radius: 3px;
            background: #2d2d30;
        }
        
        .scene-header {
            background: #404040;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .scene-header:hover {
            background: #4a4a4a;
        }
        
        .scene-title {
            font-weight: bold;
            color: #cccccc;
            font-size: 0.9em;
        }
        
        .scene-info {
            font-size: 0.8em;
            color: #858585;
        }
        
        .scene-content {
            padding: 10px;
        }
        
        .sentence-item {
            background: #1e1e1e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }
        
        .sentence-item:hover {
            background: #2d2d30;
        }
        
        .sentence-item.bookmarked {
            background: #4e4e2a;
            border-left: 3px solid #ffd700;
        }
        
        .sentence-item.playing {
            background: #2d4a2d;
            border-left: 3px solid #4CAF50;
        }
        
        .collapse-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .sentence-number {
            color: #858585;
            margin-right: 10px;
        }
        
        .sentence-text {
            color: #cccccc;
            line-height: 1.5;
            display: inline;
        }
        
        .sentence-korean {
            color: #858585;
            font-size: 0.9em;
            margin-left: 10px;
            display: inline;
        }
        
        .bookmark-btn {
            position: absolute;
            right: 60px;
            top: 15px;
            background: none;
            border: none;
            color: #858585;
            font-size: 20px;
            cursor: pointer;
        }
        
        .sentence-item.bookmarked .bookmark-btn {
            color: #ffd700;
        }
        
        .extract-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: #0e639c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .extract-btn:hover {
            background: #1177bb;
        }
        
        /* Scene navigation highlight */
        .sentence-item.highlighted {
            background: rgba(14, 99, 156, 0.3);
            border: 2px solid #0e639c;
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .scene-header {
            cursor: pointer;
        }
        
        .scene-title:hover {
            color: #0e639c;
        }
        
        /* Right sidebar panels */
        .extract-panel, .filter-panel, .bookmarked-panel {
            margin-bottom: 25px;
            padding: 15px;
            background: #2d2d30;
            border-radius: 5px;
            border: 1px solid #444444;
        }
        
        .extract-panel h3, .filter-panel h3, .bookmarked-panel h3 {
            margin-bottom: 15px;
            color: #cccccc;
            font-size: 1em;
            border-bottom: 1px solid #444444;
            padding-bottom: 8px;
        }
        
        .extract-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .extract-option-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
            text-align: left;
        }
        
        .extract-option-btn:hover {
            background: #1177bb;
        }
        
        .extract-option-btn:disabled {
            background: #555555;
            cursor: not-allowed;
        }
        
        .extract-status {
            margin-top: 10px;
            padding: 8px;
            background: #1e1e1e;
            border-radius: 3px;
            font-size: 0.8em;
            color: #858585;
            min-height: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333333;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0e639c, #1177bb);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .vad-info {
            font-size: 0.7em !important;
            margin-top: 2px;
            padding: 2px 4px;
            border-radius: 2px;
            display: inline-block;
        }
        
        .filter-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cccccc;
            cursor: pointer;
        }
        
        .filter-details {
            margin-top: 8px;
            padding: 8px;
            background: #1e1e1e;
            border-radius: 3px;
            color: #858585;
        }
        
        /* Chapter and Scene header extract buttons */
        .chapter-extract-btn, .scene-extract-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .chapter-extract-btn:hover, .scene-extract-btn:hover {
            background: #1177bb;
        }
        
        /* Controls */
        .controls {
            margin: 20px 0;
        }
        
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #1177bb;
        }
        
        .btn-export {
            background: #d79921;
        }
        
        .btn-export:hover {
            background: #fabd2f;
        }
        
        /* Upload area */
        .upload-area {
            border: 2px dashed #444444;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s, background-color 0.3s;
        }
        
        .upload-area.drag-over {
            border-color: #0e639c;
            background: rgba(14, 99, 156, 0.1);
        }
        
        .upload-area input[type="file"] {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border: 1px solid #444444;
            background: #2d2d30;
            color: #cccccc;
            border-radius: 3px;
        }
        
        .media-item {
            padding: 8px 30px 8px 8px; /* ì˜¤ë¥¸ìª½ì— ì‚­ì œ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            margin: 5px 0;
            background: #2d2d30;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .media-item:hover {
            background: #37373d;
        }
        
        .media-item.active {
            background: #0e639c;
        }
        
        .chapter-item {
            margin: 5px 0;
            padding: 5px;
            background: #37373d;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .scene-item {
            margin: 2px 0 2px 15px;
            padding: 3px;
            background: #2d2d30;
            border-radius: 2px;
            font-size: 0.8em;
            color: #858585;
        }
        
        /* Bookmarked list */
        .bookmarked-panel {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
        }
        
        .bookmarked-panel h3 {
            margin-bottom: 15px;
            color: #cccccc;
        }
        
        .bookmarked-item {
            padding: 8px;
            margin: 5px 0;
            background: #1e1e1e;
            border-radius: 3px;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: #2d2d30;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #444444;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
            color: #cccccc;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444444;
            padding-bottom: 10px;
        }
        
        .modal-close {
            color: #858585;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: #cccccc;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-form label {
            color: #cccccc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .modal-form select, .modal-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444444;
            background: #1e1e1e;
            color: #cccccc;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .modal-form button {
            width: 100%;
            padding: 12px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .modal-form button:hover {
            background: #1177bb;
        }
        
        .modal-form button.srt-btn {
            background: #4caf50;
        }
        
        .modal-form button.srt-btn:hover {
            background: #66bb6a;
        }
        
        .extract-option-btn.delete-btn {
            background: #d32f2f;
        }
        
        .extract-option-btn.delete-btn:hover {
            background: #f44336;
        }
    </style>
</head>
<body>
    <!-- VSCode Style Activity Bar -->
    <div class="activity-bar">
        <button class="activity-item active" onclick="showPanel('upload')" title="íŒŒì¼ ì—…ë¡œë“œ">
            ğŸ“
        </button>
        <button class="activity-item" onclick="showPanel('media')" title="ë¯¸ë””ì–´ íƒìƒ‰ê¸°">
            ğŸ“š
        </button>
        <button class="activity-item" onclick="showPanel('subtitle')" title="ìë§‰ ìƒì„±">
            ğŸ“
        </button>
        <button class="activity-item" onclick="showPanel('extract')" title="ì¶”ì¶œ">
            ğŸ“¤
        </button>
        <button class="activity-item" onclick="showPanel('translate')" title="ë²ˆì—­ ë° í•„í„°">
            ğŸŒ
        </button>
    </div>
    
    <!-- Left Sidebar -->
    <div class="sidebar" id="leftSidebar">
        <div class="sidebar-header" id="sidebarHeader">
            <span>íŒŒì¼ ì—…ë¡œë“œ</span>
            <button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>
        </div>
        <div class="sidebar-resizer" id="leftSidebarResizer"></div>
        <div class="sidebar-content" id="sidebarContent">
            <!-- ì—…ë¡œë“œ íŒ¨ë„ -->
            <div id="uploadPanel">
                <button onclick="showUploadSection()" style="width: 100%; padding: 10px; margin-bottom: 15px; background: #0e639c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                    â• ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                </button>
            </div>
            
            <!-- ë¯¸ë””ì–´ íŒ¨ë„ -->
            <div id="mediaPanel" style="display: none;">
                <div id="mediaList"></div>
                <div id="chapterList" style="margin-top: 20px; display: none;">
                    <h4>ì±•í„°/ì”¬ êµ¬ì¡°</h4>
                    <div id="chapterContent"></div>
                </div>
            </div>
            
            <!-- ìë§‰ ìƒì„± íŒ¨ë„ -->
            <div id="subtitlePanel" style="display: none;">
                <div class="extract-options">
                    <h4>ğŸ“ ìë§‰ ìƒì„±</h4>
                    <button class="extract-option-btn" onclick="showWhisperOptions()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ¤ Whisper ìƒì„±
                    </button>
                    <button class="extract-option-btn" onclick="showSrtUpload()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ“„ SRT ì—…ë¡œë“œ
                    </button>
                    <button class="extract-option-btn delete-btn" onclick="deleteSubtitles()" style="width: 100%; margin-bottom: 15px;">
                        ğŸ—‘ï¸ ìë§‰ ì‚­ì œ
                    </button>
                    <div id="generationStatus" class="extract-status" style="display: none;"></div>
                </div>
            </div>
            
            <!-- ì¶”ì¶œ íŒ¨ë„ -->
            <div id="extractPanel" style="display: none;">
                <div class="extract-options">
                    <h4>ğŸµ MP3 ì¶”ì¶œ</h4>
                    <button class="extract-option-btn" onclick="extractAllMP3()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ“ ì „ì²´ ë¬¸ì¥ MP3
                    </button>
                    <button class="extract-option-btn" onclick="extractAllChapters()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ“š ì±•í„°ë³„ ì¶”ì¶œ
                    </button>
                    <button class="extract-option-btn" onclick="extractAllScenes()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ¬ ì”¬ë³„ ì¶”ì¶œ
                    </button>
                    <button class="extract-option-btn" onclick="extractBookmarkedOnly()" style="width: 100%; margin-bottom: 15px;">
                        â­ ë¶ë§ˆí¬ë§Œ ì¶”ì¶œ
                    </button>
                    <div id="extractStatus" class="extract-status" style="margin-bottom: 15px;"></div>
                    
                    <h4>ğŸ¬ MP4 ì¶”ì¶œ</h4>
                    <button class="extract-option-btn" onclick="extractAllMP4()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ“ ì „ì²´ ë¬¸ì¥ MP4
                    </button>
                    <button class="extract-option-btn" onclick="extractAllChaptersMP4()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ“š ì±•í„°ë³„ MP4 ì¶”ì¶œ
                    </button>
                    <button class="extract-option-btn" onclick="extractAllScenesMP4()" style="width: 100%; margin-bottom: 8px;">
                        ğŸ¬ ì”¬ë³„ MP4 ì¶”ì¶œ
                    </button>
                    
                    <!-- ë¶ë§ˆí¬ë§Œ MP4 ì¶”ì¶œ ì˜µì…˜ -->
                    <div style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 8px;">
                        <div style="margin-bottom: 8px; font-weight: bold;">â­ ë¶ë§ˆí¬ë§Œ MP4 ì¶”ì¶œ</div>
                        <div style="margin-bottom: 8px;">
                            <label style="display: inline-block; margin-right: 15px;">
                                <input type="checkbox" id="bookmarkSubtitleEnglish" checked style="margin-right: 5px;">
                                ì˜ì–´ ìë§‰
                            </label>
                            <label style="display: inline-block;">
                                <input type="checkbox" id="bookmarkSubtitleKorean" style="margin-right: 5px;">
                                í•œê¸€ ìë§‰
                            </label>
                        </div>
                        <button class="extract-option-btn" onclick="extractBookmarkedOnlyMP4()" style="width: 100%;">
                            â­ ë¶ë§ˆí¬ë§Œ MP4 ìƒì„±
                        </button>
                    </div>
                    
                    <!-- ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì˜µì…˜ -->
                    <div style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="margin-bottom: 8px; font-weight: bold;">ğŸ“ ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4</div>
                        <div style="margin-bottom: 8px;">
                            <label style="display: inline-block; margin-right: 15px;">
                                <input type="checkbox" id="subtitleEnglish" checked style="margin-right: 5px;">
                                ì˜ì–´ ìë§‰
                            </label>
                            <label style="display: inline-block;">
                                <input type="checkbox" id="subtitleKorean" style="margin-right: 5px;">
                                í•œê¸€ ìë§‰
                            </label>
                        </div>
                        <button class="extract-option-btn" onclick="extractAllSentencesMP4()" style="width: 100%;">
                            ğŸ“ ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ìƒì„±
                        </button>
                    </div>
                    <div id="extractStatusMP4" class="extract-status" style="margin-bottom: 15px;"></div>
                </div>
            </div>
            
            <!-- ë²ˆì—­ íŒ¨ë„ -->
            <div id="translatePanel" style="display: none;">
                <div class="extract-options">
                    <h4>ğŸŒ ìë™ ë²ˆì—­</h4>
                    <div id="translationInfo" style="margin-bottom: 10px; font-size: 0.9em; color: #cccccc;">
                        <!-- ë²ˆì—­ ìƒíƒœ ì •ë³´ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
                    </div>
                    <button class="extract-option-btn" onclick="startTranslation()" id="translateBtn" style="width: 100%; margin-bottom: 15px;">
                        ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘
                    </button>
                    <div id="translationStatus" class="extract-status" style="display: none; margin-bottom: 15px;"></div>
                    
                    <h4>ğŸ™ï¸ ì˜¤ë””ì˜¤ í•„í„°</h4>
                    <label style="display: flex; align-items: center; gap: 8px; color: #cccccc; cursor: pointer; margin-bottom: 10px;">
                        <input type="checkbox" id="vadFilter" onchange="toggleVADFilter()">
                        ìŒì„± í™œë™ ê°ì§€ (VAD) í•„í„°
                    </label>
                    <div class="filter-details" id="vadDetails" style="display: none; margin-bottom: 15px;">
                        <div style="margin: 10px 0;">
                            <label>ë¯¼ê°ë„:</label>
                            <input type="range" id="vadThreshold" min="0.1" max="0.9" step="0.1" value="0.3" onchange="updateVADThreshold()">
                            <span id="vadThresholdValue">0.3</span>
                        </div>
                        <button class="extract-option-btn" onclick="applyVADFilter()" style="width: 100%; margin: 5px 0;">
                            ğŸ¯ VAD í•„í„° ì ìš©
                        </button>
                        <button class="extract-option-btn" onclick="createVADAudio()" style="width: 100%; margin: 5px 0;">
                            ğŸµ ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„±
                        </button>
                        <div id="vadStatus" style="font-size: 0.8em; color: #858585; margin-top: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main-content">
        <div id="uploadSection" class="upload-area">
            <h3>ğŸ“ ë¯¸ë””ì–´ íŒŒì¼ ì—…ë¡œë“œ</h3>
            
            <div style="margin-bottom: 15px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.2em; color: #cccccc; margin-bottom: 10px;">
                        ğŸ“ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                    </div>
                    <input type="file" id="fileInput" accept="audio/mp3,audio/mpeg,audio/wav,audio/mp4,audio/m4a,audio/ogg,video/mp4,video/avi,video/mov,video/mkv,video/webm,video/x-flv">
                </div>
                <div style="font-size: 0.8em; color: #858585; text-align: center;">
                    <div><strong>ğŸµ ì˜¤ë””ì˜¤:</strong> MP3, WAV, M4A, OGG</div>
                    <div><strong>ğŸ¬ ì˜ìƒ:</strong> MP4, AVI, MOV, MKV, WebM, FLV</div>
                    <div style="margin-top: 5px; color: #606060;">â€» ì˜ìƒ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ì˜¤ë””ì˜¤ê°€ ì¶”ì¶œë©ë‹ˆë‹¤</div>
                    <div style="margin-top: 5px; color: #606060;">â€» íŒŒì¼ í¬ê¸° ì œí•œ ì—†ìŒ</div>
                </div>
            </div>
            
            <div id="uploadStatus" style="margin-top: 10px; color: #858585;"></div>
            
            <!-- ì²˜ë¦¬ ì˜µì…˜ (ì—…ë¡œë“œ í›„ í‘œì‹œ) -->
            <div id="processingOptions" style="display: none; margin-top: 20px; padding: 15px; background: #2d2d30; border-radius: 5px;">
                <h4 style="color: #cccccc; margin-bottom: 15px;">ğŸ“ ë¬¸ì¥ ìƒì„± ë°©ë²• ì„ íƒ</h4>
                
                <!-- Whisper ì˜µì…˜ -->
                <div class="processing-option" style="margin-bottom: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px;">
                    <h5 style="color: #cccccc; margin-bottom: 10px;">ğŸ¤ Whisper AIë¡œ ë¬¸ì¥ ìƒì„±</h5>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">ëª¨ë¸ ì„ íƒ:</label>
                        <select id="modelSelect" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                            <option value="tiny">âš¡ Tiny (ë¹ ë¦„, ë‚®ì€ ì •í™•ë„)</option>
                            <option value="small">ğŸ”¹ Small (ë³´í†µ ì†ë„, ë³´í†µ ì •í™•ë„)</option>
                            <option value="medium" selected>ğŸ”¸ Medium (ëŠë¦¼, ë†’ì€ ì •í™•ë„)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">êµ¬ì¡° í…œí”Œë¦¿:</label>
                        <select id="templateSelect" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                            <option value="auto">ğŸ¤– ìë™ ê°ì§€</option>
                            <option value="toeic_lc" selected>ğŸ“š TOEIC LC (Part 1-4)</option>
                            <option value="toeic_rc">ğŸ“– TOEIC RC (Part 5-7)</option>
                            <option value="general">ğŸ“ ì¼ë°˜ ê°•ì˜</option>
                            <option value="conversation">ğŸ’¬ ëŒ€í™”/ì¸í„°ë·°</option>
                            <option value="audiobook">ğŸ“š ì˜¤ë””ì˜¤ë¶</option>
                            <option value="manual">âš™ï¸ ìˆ˜ë™ ì„¤ì •</option>
                        </select>
                    </div>
                    
                    <button onclick="processWithWhisper()" style="width: 100%; padding: 10px; background: #0e639c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ¤ Whisperë¡œ ë¬¸ì¥ ìƒì„± ì‹œì‘
                    </button>
                </div>
                
                <!-- ë¬¸ì¥ ì—…ë¡œë“œ ì˜µì…˜ -->
                <div class="processing-option" style="margin-bottom: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px;">
                    <h5 style="color: #cccccc; margin-bottom: 10px;">ğŸ“„ ë¬¸ì¥ ë°ì´í„° ì§ì ‘ ì—…ë¡œë“œ</h5>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">SRT íŒŒì¼ ì—…ë¡œë“œ:</label>
                        <input type="file" id="srtFileInput" accept=".srt" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                        <div style="font-size: 0.8em; color: #858585; margin-top: 3px;">
                            ìë§‰ íŒŒì¼ (.srt) í˜•ì‹ìœ¼ë¡œ ì‹œê°„ ì •ë³´ì™€ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <button onclick="uploadSentences()" style="width: 100%; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ“„ SRT íŒŒì¼ë¡œ ë¬¸ì¥ ìƒì„±
                    </button>
                </div>
                
                <div id="processingStatus" style="margin-top: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px; display: none;"></div>
            </div>
        </div>
        

        <div class="media-player" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="mediaTitle" style="margin: 0;">ë¯¸ë””ì–´ ì œëª©</h3>
            </div>
            <audio id="audioPlayer" controls preload="auto" style="display:none;">
                ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>
            
            <!-- HTML5 Video Player with Overlay Container -->
            <div id="videoContainer" style="position: relative; display: none; width: 100%;">
                <video
                    id="videoPlayer"
                    controls
                    preload="auto"
                    style="width: 100%; max-width: 100%; height: auto; max-height: 70vh; object-fit: contain; display: block;">
                    ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </video>
                
                <!-- Video Overlay Subtitles -->
                <div id="videoOverlaySubtitles" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; color: white; text-align: center; max-width: 90%; display: none; font-family: 'Noto Sans KR', 'Segoe UI', sans-serif; font-size: 3.5em; font-weight: 700; line-height: 1.3; text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9), 1px 1px 2px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.8);">
                    ì˜¤ë²„ë ˆì´ ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                </div>
            </div>
            
            <!-- ì˜¤ë²„ë ˆì´ ìë§‰ ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
            <div id="overlayControlPanel" style="margin-top: 15px; padding: 12px; background: #2a2a2a; border-radius: 8px; border: 1px solid #444444; display: block;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <!-- ì–¸ì–´ ì„ íƒ -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #cccccc; font-size: 0.9em; min-width: 60px;">ğŸ—£ï¸ ì–¸ì–´:</span>
                        <button id="subtitleEngBtn" onclick="setSubtitleLanguage('english')" style="padding: 4px 8px; background: #0e639c; color: #ffffff; border: 1px solid #0e639c; border-radius: 4px; cursor: pointer; font-size: 0.9em;">EN</button>
                        <button id="subtitleKorBtn" onclick="setSubtitleLanguage('korean')" style="padding: 4px 8px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;">í•œ</button>
                        <button id="subtitleBothBtn" onclick="setSubtitleLanguage('both')" style="padding: 4px 8px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;">ë‘˜ë‹¤</button>
                        <button id="verbHighlightBtn" onclick="toggleVerbHighlight()" style="padding: 4px 8px; background: #ffeb3b; color: #333; border: 1px solid #ffeb3b; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 8px;">ğŸ’›ON</button>
                        <button id="verbModeBtn" onclick="toggleVerbMode()" style="padding: 4px 8px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;" title="í•˜ì´ë¼ì´íŠ¸ ëª¨ë“œ (í´ë¦­í•˜ë©´ ë¹ˆì¹¸ ëª¨ë“œ)">ğŸ”†</button>
                    </div>
                    
                    <!-- í¬ê¸° ì¡°ì ˆ -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #cccccc; font-size: 0.9em; min-width: 60px;">ğŸ“ í¬ê¸°:</span>
                        <button onclick="adjustOverlaySize(-0.2)" style="padding: 4px 8px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;">ï¼</button>
                        <span id="overlaySizeDisplay" style="color: #ffffff; font-size: 0.9em; min-width: 40px; text-align: center;">120%</span>
                        <button onclick="adjustOverlaySize(0.2)" style="padding: 4px 8px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;">ï¼‹</button>
                        <button onclick="resetOverlaySize()" style="padding: 4px 10px; background: #444444; color: #cccccc; border: 1px solid #666666; border-radius: 4px; cursor: pointer; font-size: 0.8em; margin-left: 5px;">ì´ˆê¸°í™”</button>
                    </div>
                    
                    <!-- ìœ„ì¹˜ ì¡°ì ˆ -->
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="color: #cccccc; font-size: 0.9em; min-width: 60px;">ğŸ“ ìœ„ì¹˜:</span>
                        <button id="positionCenterBtn" onclick="setOverlayPosition('center')" style="padding: 4px 12px; background: #0e639c; color: #ffffff; border: 1px solid #0e639c; border-radius: 4px; cursor: pointer; font-size: 0.9em;">ì¤‘ì•™</button>
                        <button id="positionBottomBtn" onclick="setOverlayPosition('bottom')" style="padding: 4px 12px; background: #333333; color: #cccccc; border: 1px solid #555555; border-radius: 4px; cursor: pointer; font-size: 0.9em;">í•˜ë‹¨</button>
                    </div>
                </div>
            </div>
            
            <!-- Language Reactor ìŠ¤íƒ€ì¼ ìë§‰ í‘œì‹œ ì˜ì—­ -->
            <div id="videoSubtitlesContainer" style="margin-top: 20px; min-height: 200px; position: relative;">
                <!-- ìë§‰ í† ê¸€ ë²„íŠ¼ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div style="color: #888888; font-size: 0.9em;">ğŸ¬ ì‹¤ì‹œê°„ ìë§‰</div>
                    <div style="display: flex; gap: 8px;">
                        <button id="subtitleToggleBtn" onclick="toggleSubtitleDisplay()" style="padding: 5px 10px; background: #333333; color: #cccccc; border: 1px solid #444444; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                            ğŸ”½ ìˆ¨ê¸°ê¸°
                        </button>
                    </div>
                </div>
                
                <div id="videoSubtitles" style="background: #1e1e1e; border-radius: 10px; padding: 20px; border: 2px solid #333333; height: 180px; min-height: 180px; max-height: 180px; display: flex; flex-direction: column; justify-content: center; overflow: hidden;">
                    <!-- ì´ì „ ìë§‰ -->
                    <div id="previousSubtitle" style="text-align: center; padding: 8px 15px; color: #888888; font-size: 0.9em; line-height: 1.4; margin-bottom: 10px; opacity: 0.6; min-height: 20px;">
                    </div>
                    
                    <!-- í˜„ì¬ ìë§‰ -->
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <div id="currentSubtitle" style="flex: 1; text-align: center; font-size: 1.4em; color: #ffffff; line-height: 1.6; padding: 15px 20px; background: #2d2d30; border-radius: 8px; border: 2px solid #0e639c; font-weight: 500; font-family: 'Segoe UI', 'Noto Sans KR', sans-serif; min-height: 60px; display: flex; align-items: center; justify-content: center;">
                            ìë§‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤
                        </div>
                        <button id="subtitleBookmarkBtn" onclick="toggleSubtitleBookmark()" style="padding: 10px 14px; background: #333333; color: #cccccc; border: 1px solid #444444; border-radius: 8px; cursor: pointer; font-size: 1em; white-space: nowrap; transition: all 0.2s;" title="ë¶ë§ˆí¬ ì¶”ê°€/ì œê±°">
                            â˜†
                        </button>
                    </div>
                    
                    <!-- í˜„ì¬ ìë§‰ ë²ˆì—­ -->
                    <div id="currentSubtitleKorean" style="text-align: center; color: #cccccc; font-size: 1.1em; line-height: 1.5; margin-bottom: 15px; font-family: 'Noto Sans KR', sans-serif; min-height: 20px;">
                    </div>
                    
                    <!-- ë‹¤ìŒ ìë§‰ -->
                    <div id="nextSubtitle" style="text-align: center; padding: 8px 15px; color: #888888; font-size: 0.9em; line-height: 1.4; opacity: 0.6; min-height: 20px;">
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 0.9em; color: #858585;">
                ë¬¸ì¥ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ì´ ì¬ìƒë©ë‹ˆë‹¤.
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="repeatCurrent()">êµ¬ê°„ ë°˜ë³µ</button>
            <button class="btn" onclick="playBookmarked()">ë¶ë§ˆí¬ ì¬ìƒ</button>
            <button class="btn btn-export" onclick="exportBookmarks()">ë¶ë§ˆí¬ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
    </main>
    
    <!-- Right Sidebar -->
    <div class="right-sidebar" id="rightSidebar">
        <div class="right-sidebar-header">
            <span>ë¬¸ì¥ ëª©ë¡</span>
            <button class="sidebar-toggle" onclick="toggleRightSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>
        </div>
        <div class="right-sidebar-resizer" id="rightSidebarResizer"></div>
        <div class="right-sidebar-content">
        
            <!-- ë¬¸ì¥ ê²€ìƒ‰ -->
            <div class="search-area" style="margin-bottom: 20px;">
                <h3>ë¬¸ì¥ ê²€ìƒ‰</h3>
                <input type="text" id="searchInput" placeholder="3ê¸€ì ì´ìƒ ì…ë ¥í•˜ë©´ ìë™ ê²€ìƒ‰..." 
                       style="width: 100%; padding: 10px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px;">
                <div id="searchResults" style="margin-top: 10px; color: #858585;"></div>
            </div>
            
            <!-- ë¬¸ì¥ ëª©ë¡ -->
            <div id="sentenceList"></div>
            
            <!-- ë¶ë§ˆí¬ëœ ë¬¸ì¥ -->
            <div class="bookmarked-panel">
                <h3>â­ ë¶ë§ˆí¬ëœ ë¬¸ì¥</h3>
                <div id="bookmarkedList"></div>
            </div>
        </div>
    </div>
    
    <!-- Whisper ëª¨ë‹¬ -->
    <div id="whisperModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¤ Whisper ìë§‰ ìƒì„±</h3>
                <button class="modal-close" onclick="closeModal('whisperModal')">&times;</button>
            </div>
            <div class="modal-form">
                <div>
                    <label>ëª¨ë¸ ì„ íƒ:</label>
                    <select id="modalModelSelect">
                        <option value="tiny">âš¡ Tiny (ë¹ ë¦„, ë‚®ì€ ì •í™•ë„)</option>
                        <option value="small">ğŸ”¹ Small (ë³´í†µ ì†ë„, ë³´í†µ ì •í™•ë„)</option>
                        <option value="medium" selected>ğŸ”¸ Medium (ëŠë¦¼, ë†’ì€ ì •í™•ë„)</option>
                    </select>
                </div>
                <div>
                    <label>êµ¬ì¡° í…œí”Œë¦¿:</label>
                    <select id="modalTemplateSelect">
                        <option value="auto">ğŸ¤– ìë™ ê°ì§€</option>
                        <option value="toeic_lc" selected>ğŸ“š TOEIC LC (Part 1-4)</option>
                        <option value="toeic_rc">ğŸ“– TOEIC RC (Part 5-7)</option>
                        <option value="general">ğŸ“ ì¼ë°˜ ê°•ì˜</option>
                        <option value="conversation">ğŸ’¬ ëŒ€í™”/ì¸í„°ë·°</option>
                        <option value="audiobook">ğŸ“š ì˜¤ë””ì˜¤ë¶</option>
                        <option value="manual">âš™ï¸ ìˆ˜ë™ ì„¤ì •</option>
                    </select>
                </div>
                <button onclick="startModalWhisper()">ğŸ¤ Whisper ìƒì„± ì‹œì‘</button>
            </div>
        </div>
    </div>
    
    <!-- SRT ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="srtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“„ SRT ìë§‰ ì—…ë¡œë“œ</h3>
                <button class="modal-close" onclick="closeModal('srtModal')">&times;</button>
            </div>
            <div class="modal-form">
                <div>
                    <label>SRT íŒŒì¼ ì„ íƒ:</label>
                    <input type="file" id="modalSrtFileInput" accept=".srt">
                    <div style="font-size: 0.8em; color: #858585; margin-top: 5px;">
                        ìë§‰ íŒŒì¼ (.srt) í˜•ì‹ìœ¼ë¡œ ì‹œê°„ ì •ë³´ì™€ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤
                    </div>
                </div>
                <button class="srt-btn" onclick="startModalSrtUpload()">ğŸ“„ SRT ì—…ë¡œë“œ ì‹œì‘</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentMedia = null;
        let sentences = [];
        let audioPlayer = null;
        let videoPlayer = null;
        let currentPlayer = null; // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í”Œë ˆì´ì–´
        let currentSentenceIndex = -1;
        let currentSubtitleSentence = null; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ìë§‰ì˜ ë¬¸ì¥ ì •ë³´
        let subtitleDisplayVisible = true; // ìë§‰ í‘œì‹œ ìƒíƒœ
        let translationInterval = null;
        let uploadedMediaId = null;
        
        // VSCode ìŠ¤íƒ€ì¼ íŒ¨ë„ ì „í™˜ í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„ì—ì„œ ì •ì˜)
        window.showPanel = function(panelType) {
            // ëª¨ë“  activity itemì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.activity-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // í´ë¦­ëœ ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€ (ì´ë²¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
            if (typeof window.event !== 'undefined' && window.event && window.event.target) {
                window.event.target.classList.add('active');
            } else {
                // í”„ë¡œê·¸ë˜ë°ì ìœ¼ë¡œ í˜¸ì¶œëœ ê²½ìš° í•´ë‹¹ íŒ¨ë„ ë²„íŠ¼ ì°¾ì•„ì„œ í™œì„±í™”
                const buttons = document.querySelectorAll('.activity-item');
                if (panelType === 'upload') buttons[0]?.classList.add('active');
                if (panelType === 'media') buttons[1]?.classList.add('active');
                if (panelType === 'subtitle') buttons[2]?.classList.add('active');
                if (panelType === 'extract') buttons[3]?.classList.add('active');
                if (panelType === 'translate') buttons[4]?.classList.add('active');
            }
            
            // ëª¨ë“  íŒ¨ë„ ìˆ¨ê¸°ê¸°
            const panels = ['uploadPanel', 'mediaPanel', 'subtitlePanel', 'extractPanel', 'translatePanel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (panel) panel.style.display = 'none';
            });
            
            // ì„ íƒëœ íŒ¨ë„ í‘œì‹œ
            const headerEl = document.getElementById('sidebarHeader');
            switch(panelType) {
                case 'upload':
                    const uploadPanel = document.getElementById('uploadPanel');
                    if (uploadPanel) uploadPanel.style.display = 'block';
                    if (headerEl) headerEl.innerHTML = '<span>íŒŒì¼ ì—…ë¡œë“œ</span><button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>';
                    break;
                case 'media':
                    const mediaPanel = document.getElementById('mediaPanel');
                    if (mediaPanel) mediaPanel.style.display = 'block';
                    if (headerEl) headerEl.innerHTML = '<span>ë¯¸ë””ì–´ íƒìƒ‰ê¸°</span><button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>';
                    loadMediaList(); // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    break;
                case 'subtitle':
                    const subtitlePanel = document.getElementById('subtitlePanel');
                    if (subtitlePanel) subtitlePanel.style.display = 'block';
                    if (headerEl) headerEl.innerHTML = '<span>ìë§‰ ìƒì„±</span><button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>';
                    break;
                case 'extract':
                    const extractPanel = document.getElementById('extractPanel');
                    if (extractPanel) extractPanel.style.display = 'block';
                    if (headerEl) headerEl.innerHTML = '<span>ì¶”ì¶œ</span><button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>';
                    break;
                case 'translate':
                    const translatePanel = document.getElementById('translatePanel');
                    if (translatePanel) translatePanel.style.display = 'block';
                    if (headerEl) headerEl.innerHTML = '<span>ë²ˆì—­ ë° í•„í„°</span><button class="sidebar-toggle" onclick="toggleLeftSidebar()" title="ì‚¬ì´ë“œë°” ìˆ¨ê¹€/ë³´ì´ê¸°">Ã—</button>';
                    break;
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            audioPlayer = document.getElementById('audioPlayer');
            videoPlayer = document.getElementById('videoPlayer');
            
            // HTML5 ë¹„ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            videoPlayer.addEventListener('timeupdate', updateVideoSubtitles);
            
            // HTML5 ì˜¤ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            audioPlayer.addEventListener('timeupdate', updateAudioSubtitles);
            
            // ë²„íŠ¼ ì´ˆê¸°í™”
            updateVerbHighlightButton();
            updateVerbModeButton();
            
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('keydown', handleKeyboardControls);
            
            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            setupDragAndDrop();
            
            // ê²€ìƒ‰ ì…ë ¥ ì²˜ë¦¬
            document.getElementById('searchInput').addEventListener('input', handleSearchInput);
            
            // ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ
            loadMediaList();
            
            // ê¸°ë³¸ì ìœ¼ë¡œ ë¯¸ë””ì–´ íŒ¨ë„ í‘œì‹œ (ë¯¸ë””ì–´ê°€ ìˆëŠ” ê²½ìš°)
            setTimeout(() => {
                const mediaListEl = document.getElementById('mediaList');
                if (mediaListEl && !mediaListEl.innerHTML.includes('ì—…ë¡œë“œëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤')) {
                    showPanel('media');
                }
            }, 500);
            
            // ì´ˆê¸° ìƒíƒœ: ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ, ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¹€
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processingOptions').style.display = 'none';
            // document.getElementById('searchSection').style.display = 'none'; // ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
            
            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ë¡œë“œ (ê°œë°œìš©)
            // loadSimulationData();
            
            // ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥ ì´ˆê¸°í™”
            initSidebarResize();
            
            // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
            window.addEventListener('resize', updateVideoSize);
        });
        
        function setupDragAndDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì²˜ë¦¬
                    const file = files[0];
                    const supportedFormats = /\.(mp3|wav|m4a|ogg|mp4|avi|mov|mkv|webm|flv)$/i;
                    
                    if (supportedFormats.test(file.name)) {
                        handleFileUpload({ target: { files: [file] } });
                    } else {
                        const statusEl = document.getElementById('uploadStatus');
                        statusEl.innerHTML = `âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: ${file.name}`;
                    }
                }
            }
        }
        
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const statusEl = document.getElementById('uploadStatus');
            const file = files[0];
            
            // íŒŒì¼ íƒ€ì… í™•ì¸
            const isVideo = /\.(mp4|avi|mov|mkv|webm|flv)$/i.test(file.name);
            const isAudio = /\.(mp3|wav|m4a|ogg)$/i.test(file.name);
            
            if (isVideo) {
                statusEl.innerHTML = `ğŸ¬ ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            } else if (isAudio) {
                statusEl.innerHTML = `ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            } else {
                statusEl.innerHTML = `ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // íŒŒì¼ í¬ê¸° í‘œì‹œë§Œ (ì œí•œ ì—†ìŒ)
            // if (file.size > 500 * 1024 * 1024) {
            //     statusEl.innerHTML = `âŒ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (${Math.round(file.size / 1024 / 1024)}MB). ìµœëŒ€ 500MBê¹Œì§€ ì§€ì›ë©ë‹ˆë‹¤.`;
            //     return;
            // }
            
            statusEl.innerHTML += ` (${Math.round(file.size / 1024 / 1024)}MB)`;
            
            // AbortControllerë¡œ íƒ€ì„ì•„ì›ƒ ì œì–´
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                statusEl.innerHTML = `âŒ ì—…ë¡œë“œ íƒ€ì„ì•„ì›ƒ (10ë¶„ ì œí•œ): ${file.name}`;
            }, 10 * 60 * 1000); // 10ë¶„ íƒ€ì„ì•„ì›ƒ
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                console.log('Upload response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('Upload server error response:', errorData);
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (isVideo) {
                        statusEl.innerHTML = `âœ… ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ (ì˜¤ë””ì˜¤ ì¶”ì¶œë¨): ${file.name}`;
                    } else {
                        statusEl.innerHTML = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${file.name}`;
                    }
                    
                    // ì—…ë¡œë“œëœ ë¯¸ë””ì–´ ID ì €ì¥
                    uploadedMediaId = data.media_id;
                    
                    // í”Œë ˆì´ì–´ì— íŒŒì¼ ë¡œë“œ (ì˜ìƒ/ì˜¤ë””ì˜¤ êµ¬ë¶„)
                    const mediaTitle = document.getElementById('mediaTitle');
                    const mediaPlayerDiv = document.querySelector('.media-player');
                    
                    // ì˜ìƒ íŒŒì¼ í™•ì¸
                    const videoExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm', 'flv'];
                    const fileExt = data.filename.toLowerCase().split('.').pop();
                    const isVideo = videoExtensions.includes(fileExt);
                    
                    if (isVideo) {
                        // HTML5 ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                        const videoSrc = `/api/audio/${data.filename}`;
                        console.log('Loading uploaded video:', videoSrc);
                        
                        videoPlayer.src = videoSrc;
                        videoPlayer.load();
                        
                        document.getElementById('videoContainer').style.display = 'block';
                        audioPlayer.style.display = 'none';
                        document.getElementById('videoSubtitlesContainer').style.display = 'block';
                        currentPlayer = videoPlayer;
                        
                        // ë¹„ë””ì˜¤ ë¡œë“œ í›„ í¬ê¸° ì—…ë°ì´íŠ¸
                        videoPlayer.addEventListener('loadedmetadata', updateVideoSize, { once: true });
                    } else {
                        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                        audioPlayer.src = `/api/audio/${data.filename}`;
                        audioPlayer.style.display = 'block';
                        document.getElementById('videoContainer').style.display = 'none';
                        document.getElementById('videoSubtitlesContainer').style.display = 'none';
                        currentPlayer = audioPlayer;
                    }
                    
                    mediaTitle.textContent = data.original_filename;
                    mediaPlayerDiv.style.display = 'block';
                    
                    console.log(`Media loaded: ${data.original_filename}`);
                    
                    // ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ
                    document.getElementById('processingOptions').style.display = 'block';
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                } else {
                    if (isVideo && data.error.includes('extract audio')) {
                        statusEl.innerHTML = `âŒ ì˜ìƒì—ì„œ ì˜¤ë””ì˜¤ ì¶”ì¶œ ì‹¤íŒ¨: ${file.name}`;
                    } else {
                        statusEl.innerHTML = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name} - ${data.error}`;
                    }
                    console.error('Upload error:', data.error);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Upload error:', error);
                
                if (error.name === 'AbortError') {
                    statusEl.innerHTML = `âŒ ì—…ë¡œë“œ íƒ€ì„ì•„ì›ƒ: ${file.name}`;
                } else if (error.message.includes('Failed to fetch')) {
                    statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì—°ê²° ì¤‘ë‹¨): ${file.name}. íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì„œë²„ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                } else {
                    statusEl.innerHTML = `âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
            });
        }
        
        // ìƒˆë¡œìš´ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        function processWithWhisper() {
            if (!uploadedMediaId) {
                const statusEl = document.getElementById('processingStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ ë¨¼ì € ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.';
                return;
            }
            
            const model = document.getElementById('modelSelect').value;
            const template = document.getElementById('templateSelect').value;
            const statusEl = document.getElementById('processingStatus');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ¤ Whisper ì²˜ë¦¬ ì‹œì‘ ì¤‘... (ëª¨ë¸: ${model}, í…œí”Œë¦¿: ${template})`;
            
            fetch(`/api/media/${uploadedMediaId}/process-whisper`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: model,
                    template: template
                })
            })
            .then(response => {
                console.log('Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('Server error response:', errorData);
                        
                        // ì²˜ë¦¬ ì¤‘ì¸ ë¯¸ë””ì–´ì¸ ê²½ìš° ê°•ì œ ì¬ì‹œì‘ ì˜µì…˜ ì œê³µ
                        if (errorData.can_force_restart) {
                            if (confirm('ë¯¸ë””ì–´ê°€ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ê°•ì œë¡œ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                // ê°•ì œ ì¬ì‹œì‘ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì²­
                                return fetch(`/api/media/${uploadedMediaId}/process-whisper`, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                        model: model,
                                        template: template,
                                        force_restart: true
                                    })
                                }).then(response => response.json());
                            } else {
                                throw new Error('ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                        
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    currentMedia = uploadedMediaId;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ìë§‰ íŒ¨ë„ë¡œ ì „í™˜
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `ğŸ¤ Whisper ì²˜ë¦¬ ì¤‘... ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.`;
                    }
                    showPanel('subtitle');
                    
                    // ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    monitorProcessingStatus();
                } else {
                    statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${data.error}`;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `âŒ ìë§‰ ìƒì„± ì‹¤íŒ¨: ${data.error}`;
                    }
                }
            })
            .catch(error => {
                console.error('Whisper processing error:', error);
                statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                
                // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                const generationStatusEl = document.getElementById('generationStatus');
                if (generationStatusEl) {
                    generationStatusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
            });
        }
        
        function uploadSentences() {
            if (!uploadedMediaId) {
                const statusEl = document.getElementById('processingStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ ë¨¼ì € ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.';
                return;
            }
            
            const srtFile = document.getElementById('srtFileInput').files[0];
            if (!srtFile) {
                const statusEl = document.getElementById('processingStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ SRT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.';
                return;
            }
            
            const statusEl = document.getElementById('processingStatus');
            const formData = new FormData();
            formData.append('file', srtFile);
            formData.append('template', 'manual');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì²˜ë¦¬ ì¤‘...`;
            
            fetch(`/api/media/${uploadedMediaId}/upload-sentences`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('SRT Upload Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('SRT Upload Server error response:', errorData);
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    currentMedia = uploadedMediaId;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ`;
                    }
                    
                    // ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    monitorProcessingStatus();
                } else {
                    statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${data.error}`;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `âŒ SRT ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`;
                    }
                }
            })
            .catch(error => {
                console.error('Sentence upload error:', error);
                statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                
                // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                const generationStatusEl = document.getElementById('generationStatus');
                if (generationStatusEl) {
                    generationStatusEl.innerHTML = `âŒ SRT ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`;
                }
            });
        }
        
        function monitorProcessingStatus() {
            const statusEl = document.getElementById('processingStatus');
            
            const interval = setInterval(() => {
                fetch(`/api/media/${uploadedMediaId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.processed && data.sentence_count > 0) {
                            clearInterval(interval);
                            statusEl.innerHTML = `âœ… ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥ ìƒì„±ë¨`;
                            
                            // ë¬¸ì¥ ë¡œë“œ ë° í‘œì‹œ
                            loadGroupedSentences(uploadedMediaId);
                            checkTranslationStatus();
                            
                            // ì²˜ë¦¬ ì˜µì…˜ ìˆ¨ê¸°ê¸°
                            document.getElementById('processingOptions').style.display = 'none';
                        } else if (data.status === 'processing' && data.current_sentence) {
                            statusEl.innerHTML = `ğŸ”„ ${data.current_sentence}`;
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì˜¤ë¥˜: ${data.current_sentence}`;
                        }
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                    });
            }, 2000);
        }
        
        function checkProcessingStatus(mediaId, filename) {
            const statusEl = document.getElementById('uploadStatus');
            let checkCount = 0;
            let lastSentenceCount = 0;
            
            const interval = setInterval(() => {
                checkCount++;
                
                fetch(`/api/media/${mediaId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.processed && data.sentence_count > 0) {
                            clearInterval(interval);
                            
                            // ìµœì¢… ë¬¸ì¥ ë¡œë“œ
                            if (mediaId === currentMedia) {
                                loadMediaSentences(mediaId);
                            }
                            
                            console.log(`${filename}: ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥ ì¶”ì¶œ`);
                            
                            if (statusEl) {
                                statusEl.innerHTML = `${filename}: ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥`;
                            }
                        } else {
                            // ì‹¤ì‹œê°„ ë¬¸ì¥ ì—…ë°ì´íŠ¸
                            if (data.sentence_count > lastSentenceCount) {
                                lastSentenceCount = data.sentence_count;
                                
                                // ìƒˆë¡œìš´ ë¬¸ì¥ì´ ì¶”ê°€ë˜ë©´ ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
                                if (mediaId === currentMedia) {
                                    loadMediaSentences(mediaId);
                                }
                            }
                            
                            // ì²˜ë¦¬ ì¤‘ ìƒíƒœ í‘œì‹œ (í˜„ì¬ ë¬¸ì¥ í¬í•¨)
                            if (statusEl) {
                                const dots = '.'.repeat((checkCount % 3) + 1);
                                
                                // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë¬¸ì¥ í‘œì‹œ
                                if (data.current_sentence && data.current_sentence.trim()) {
                                    statusEl.innerHTML = `
                                        <div>${filename} (${data.status || 'ì²˜ë¦¬ ì¤‘'})${dots}</div>
                                        <div style="font-size: 0.85em; color: #aaa; margin-top: 3px;">${data.current_sentence}</div>
                                        <div style="font-size: 0.8em; color: #888;">${data.sentence_count}ê°œ ë¬¸ì¥ ì™„ë£Œ</div>
                                    `;
                                } else if (data.sentence_count > 0) {
                                    statusEl.innerHTML = `${filename}: ${data.sentence_count}ê°œ ë¬¸ì¥ ì¶”ì¶œë¨${dots}`;
                                } else {
                                    statusEl.innerHTML = `${filename} ì²˜ë¦¬ ì¤‘${dots}`;
                                }
                            }
                            
                            // 30ë¶„ í›„ íƒ€ì„ì•„ì›ƒ (ëŒ€ìš©ëŸ‰ íŒŒì¼ ê³ ë ¤)
                            if (checkCount > 1800) {  // 30ë¶„
                                clearInterval(interval);
                                if (statusEl) {
                                    statusEl.innerHTML = `${filename}: ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼ (30ë¶„)`;
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                        if (statusEl) {
                            statusEl.innerHTML = `${filename}: ìƒíƒœ í™•ì¸ ì˜¤ë¥˜`;
                        }
                        clearInterval(interval);
                    });
            }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸ (ë” ë¹ ë¥¸ ì—…ë°ì´íŠ¸)
        }
        
        function loadMediaList() {
            console.log('Loading media list...');
            fetch('/api/media')
                .then(response => {
                    console.log('Media API response:', response.status);
                    return response.json();
                })
                .then(media => {
                    console.log('Media data:', media);
                    const listEl = document.getElementById('mediaList');
                    if (!listEl) {
                        console.error('mediaList element not found!');
                        return;
                    }
                    
                    if (media.length === 0) {
                        listEl.innerHTML = '<div style="color: #858585; padding: 10px;">ì—…ë¡œë“œëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    } else {
                        listEl.innerHTML = media.map(m => {
                            // UUID ì œê±°: UUIDëŠ” 36ìë¦¬ (8-4-4-4-12) í˜•íƒœì´ë¯€ë¡œ ì²« 37ì(UUID + _)ë¥¼ ì œê±°
                            const displayName = m.filename.includes('_') ? 
                                m.filename.substring(m.filename.indexOf('_') + 1) : 
                                m.filename;
                            
                            return `
                            <div class="media-item" onclick="loadMediaSentences('${m.id}')" data-media-id="${m.id}">
                                <div style="font-weight: bold;" title="${displayName}">${displayName}</div>
                                <div style="font-size: 0.8em; color: #858585;">
                                    ${m.createdAt ? new Date(m.createdAt).toLocaleDateString() : ''}
                                </div>
                                <button class="delete-btn" onclick="deleteMedia('${m.id}', event)" 
                                        style="position: absolute; right: 5px; top: 5px; background: #d32f2f; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                    âœ•
                                </button>
                            </div>
                            `;
                        }).join('');
                    }
                    console.log(`Media list updated: ${media.length} items`);
                })
                .catch(error => {
                    console.error('Failed to load media list:', error);
                    const listEl = document.getElementById('mediaList');
                    if (listEl) {
                        listEl.innerHTML = '<div style="color: #ff6b6b;">ë¯¸ë””ì–´ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</div>';
                    }
                });
        }
        
        // ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜ë“¤
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            sidebar.classList.toggle('collapsed');
            
            // í† ê¸€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const toggleBtn = sidebar.querySelector('.sidebar-toggle');
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.innerHTML = 'â–¶';
                toggleBtn.style.position = 'fixed';
                toggleBtn.style.left = '10px';
                toggleBtn.style.top = '10px';
                toggleBtn.style.zIndex = '1001';
                toggleBtn.style.background = '#252526';
                toggleBtn.style.border = '1px solid #444444';
            } else {
                toggleBtn.innerHTML = 'Ã—';
                toggleBtn.style.position = 'static';
                toggleBtn.style.background = 'none';
                toggleBtn.style.border = 'none';
            }
        }
        
        function toggleRightSidebar() {
            const sidebar = document.getElementById('rightSidebar');
            sidebar.classList.toggle('collapsed');
            
            // í† ê¸€ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const toggleBtn = sidebar.querySelector('.sidebar-toggle');
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.innerHTML = 'â—€';
                toggleBtn.style.position = 'fixed';
                toggleBtn.style.right = '10px';
                toggleBtn.style.top = '10px';
                toggleBtn.style.zIndex = '1001';
                toggleBtn.style.background = '#252526';
                toggleBtn.style.border = '1px solid #444444';
            } else {
                toggleBtn.innerHTML = 'Ã—';
                toggleBtn.style.position = 'static';
                toggleBtn.style.background = 'none';
                toggleBtn.style.border = 'none';
            }
        }
        
        // ë””ë²„ê¹…ìš© ì „ì—­ í•¨ìˆ˜
        window.testRightSidebarResizer = function() {
            const rightResizer = document.getElementById('rightSidebarResizer');
            const rightSidebar = document.getElementById('rightSidebar');
            
            console.log('=== Right Sidebar Resizer Debug ===');
            console.log('Resizer element:', rightResizer);
            console.log('Sidebar element:', rightSidebar);
            
            if (rightResizer) {
                console.log('Resizer bounding rect:', rightResizer.getBoundingClientRect());
                console.log('Resizer computed style:', getComputedStyle(rightResizer));
                console.log('Resizer parent:', rightResizer.parentElement);
                console.log('Resizer z-index:', getComputedStyle(rightResizer).zIndex);
                console.log('Resizer display:', getComputedStyle(rightResizer).display);
                console.log('Resizer position:', getComputedStyle(rightResizer).position);
                
                // ê°•ì œë¡œ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
                rightResizer.style.background = 'yellow';
                rightResizer.style.border = '5px solid purple';
                console.log('Resizer styled with yellow background and purple border');
            } else {
                console.error('Right resizer not found!');
            }
            
            if (rightSidebar) {
                console.log('Sidebar bounding rect:', rightSidebar.getBoundingClientRect());
                console.log('Sidebar computed style position:', getComputedStyle(rightSidebar).position);
            }
        };
        
        // ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
        function initSidebarResize() {
            console.log('Initializing sidebar resize...');
            let isResizing = false;
            let currentSidebar = null;
            
            // DOM ìƒíƒœ í™•ì¸
            console.log('DOM ready state:', document.readyState);
            console.log('All elements:', {
                'leftSidebarResizer': document.getElementById('leftSidebarResizer'),
                'leftSidebar': document.getElementById('leftSidebar'),
                'rightSidebarResizer': document.getElementById('rightSidebarResizer'),
                'rightSidebar': document.getElementById('rightSidebar')
            });
            
            // ì™¼ìª½ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì €
            const leftResizer = document.getElementById('leftSidebarResizer');
            const leftSidebar = document.getElementById('leftSidebar');
            
            console.log('Left resizer:', leftResizer);
            console.log('Left sidebar:', leftSidebar);
            
            if (leftResizer && leftSidebar) {
                leftResizer.addEventListener('mousedown', (e) => {
                    console.log('Left resizer mousedown');
                    isResizing = true;
                    currentSidebar = leftSidebar;
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            }
            
            // ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì €
            const rightResizer = document.getElementById('rightSidebarResizer');
            const rightSidebar = document.getElementById('rightSidebar');
            
            console.log('Right resizer:', rightResizer);
            console.log('Right sidebar:', rightSidebar);
            console.log('Right resizer computed style:', rightResizer ? getComputedStyle(rightResizer) : 'null');
            
            if (rightResizer && rightSidebar) {
                // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¡œê¹…ì„ ìœ„í•œ ì¶”ê°€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                rightResizer.addEventListener('mouseenter', () => {
                    console.log('Right resizer mouse enter');
                });
                
                rightResizer.addEventListener('mouseleave', () => {
                    console.log('Right resizer mouse leave');
                });
                
                rightResizer.addEventListener('mousedown', (e) => {
                    console.log('Right resizer mousedown event fired!', e);
                    isResizing = true;
                    currentSidebar = rightSidebar;
                    document.body.style.cursor = 'ew-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                });
            } else {
                console.error('Right sidebar resizer not found! Resizer:', rightResizer, 'Sidebar:', rightSidebar);
            }
            
            // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
            document.addEventListener('mousemove', (e) => {
                if (!isResizing || !currentSidebar) return;
                
                if (currentSidebar === leftSidebar) {
                    // ì™¼ìª½ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ
                    const newWidth = e.clientX - 48; // ì•¡í‹°ë¹„í‹° ë°” í­ ì œì™¸
                    if (newWidth >= 200 && newWidth <= 600) {
                        leftSidebar.style.width = newWidth + 'px';
                        console.log('Left sidebar resized to:', newWidth);
                        // ë¹„ë””ì˜¤ í¬ê¸° ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
                        updateVideoSize();
                    }
                } else if (currentSidebar === rightSidebar) {
                    // ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ë¦¬ì‚¬ì´ì¦ˆ
                    const newWidth = window.innerWidth - e.clientX;
                    console.log('Right sidebar resize attempt:', {
                        'clientX': e.clientX,
                        'windowWidth': window.innerWidth,
                        'newWidth': newWidth,
                        'currentWidth': rightSidebar.style.width
                    });
                    if (newWidth >= 300 && newWidth <= 800) {
                        rightSidebar.style.width = newWidth + 'px';
                        console.log('Right sidebar successfully resized to:', newWidth);
                        // ë¹„ë””ì˜¤ í¬ê¸° ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±°
                        updateVideoSize();
                    } else {
                        console.log('Right sidebar resize rejected - out of bounds:', newWidth);
                    }
                }
            });
            
            // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    console.log('Resize ended');
                    isResizing = false;
                    currentSidebar = null;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }
        
        // ë¹„ë””ì˜¤ í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateVideoSize() {
            const videoPlayer = document.getElementById('videoPlayer');
            if (videoPlayer && videoPlayer.style.display !== 'none') {
                // ê°•ì œë¡œ ë¹„ë””ì˜¤ í¬ê¸° ì¬ê³„ì‚°
                videoPlayer.style.width = '100%';
                videoPlayer.style.maxWidth = '100%';
                
                // ë¬´í•œ ë£¨í”„ ë°©ì§€: resize ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° ì œê±°
                // ë¹„ë””ì˜¤ í¬ê¸° ì¡°ì •ë§Œìœ¼ë¡œ ì¶©ë¶„í•¨
            }
        }
        
        
        function showUploadSection() {
            // ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('uploadSection').style.display = 'block';
            
            // ì²˜ë¦¬ ì˜µì…˜, ê²€ìƒ‰ ì„¹ì…˜, ìë§‰ ìƒì„± ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.getElementById('processingOptions').style.display = 'none';
            document.getElementById('searchSection').style.display = 'none';
            
            // ë¯¸ë””ì–´ í”Œë ˆì´ì–´ ìˆ¨ê¸°ê¸°
            document.querySelector('.media-player').style.display = 'none';
            
            // ë¬¸ì¥ ëª©ë¡ ìˆ¨ê¸°ê¸°
            document.getElementById('sentenceList').innerHTML = '';
            document.getElementById('bookmarkedList').innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            // ë¯¸ë””ì–´ ì„ íƒ í•´ì œ
            document.querySelectorAll('.media-item').forEach(item => {
                item.classList.remove('active');
            });
            
            currentMedia = null;
            console.log('Upload section shown');
        }
        
        function showWhisperOptions() {
            // Whisper ëª¨ë‹¬ ë„ìš°ê¸°
            document.getElementById('whisperModal').style.display = 'block';
        }
        
        function showSrtUpload() {
            // SRT ì—…ë¡œë“œ ëª¨ë‹¬ ë„ìš°ê¸°
            document.getElementById('srtModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function startModalWhisper() {
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!currentMedia) {
                const statusEl = document.getElementById('generationStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ëª¨ë‹¬ì—ì„œ ì„ íƒëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
            const model = document.getElementById('modalModelSelect').value;
            const template = document.getElementById('modalTemplateSelect').value;
            
            // uploadedMediaId ì„¤ì •
            uploadedMediaId = currentMedia;
            
            // ê¸°ì¡´ í”„ë¡œì„¸ì‹± ì˜µì…˜ì˜ select ê°’ë“¤ ì„¤ì •
            document.getElementById('modelSelect').value = model;
            document.getElementById('templateSelect').value = template;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('whisperModal');
            
            // ìë§‰ ìƒì„± ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ¤ Whisper ìë§‰ ìƒì„± ì¤‘... (ëª¨ë¸: ${model})`;
            
            // ê¸°ì¡´ Whisper ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            processWithWhisper();
        }
        
        function startModalSrtUpload() {
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!currentMedia) {
                const statusEl = document.getElementById('generationStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ëª¨ë‹¬ì—ì„œ ì„ íƒëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            const fileInput = document.getElementById('modalSrtFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                const statusEl = document.getElementById('generationStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ SRT íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                return;
            }
            
            // uploadedMediaId ì„¤ì •
            uploadedMediaId = currentMedia;
            
            // ê¸°ì¡´ SRT íŒŒì¼ inputì— íŒŒì¼ ì„¤ì •
            const originalFileInput = document.getElementById('srtFileInput');
            originalFileInput.files = fileInput.files;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('srtModal');
            
            // ìë§‰ ìƒì„± ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì—…ë¡œë“œ ì¤‘...`;
            
            // ê¸°ì¡´ SRT ì—…ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
            uploadSentences();
        }
        
        // ë¹„ë””ì˜¤ ìë§‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateVideoSubtitles() {
            const videoSubtitlesDiv = document.getElementById('videoSubtitles');
            const currentSubtitleDiv = document.getElementById('currentSubtitle');
            
            if (videoPlayer.style.display === 'none' || !sentences || sentences.length === 0) {
                return;
            }
            
            const currentTime = videoPlayer.currentTime;
            const previousSubtitleDiv = document.getElementById('previousSubtitle');
            const currentSubtitleKoreanDiv = document.getElementById('currentSubtitleKorean');
            const nextSubtitleDiv = document.getElementById('nextSubtitle');
            let currentIndex = -1;
            
            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì¥ ì¸ë±ìŠ¤ ì°¾ê¸°
            for (let i = 0; i < sentences.length; i++) {
                if (currentTime >= sentences[i].startTime && currentTime <= sentences[i].endTime) {
                    currentIndex = i;
                    currentSubtitleSentence = sentences[i];
                    break;
                }
            }
            
            if (currentIndex >= 0 && subtitleDisplayVisible) {
                
                // ì´ì „ ìë§‰
                if (currentIndex > 0) {
                    previousSubtitleDiv.innerHTML = formatSpeakerText(sentences[currentIndex - 1].english, sentences[currentIndex - 1].id);
                    previousSubtitleDiv.style.display = 'block';
                } else {
                    previousSubtitleDiv.style.display = 'none';
                }
                
                // í˜„ì¬ ìë§‰
                const currentSentence = sentences[currentIndex];
                currentSubtitleDiv.innerHTML = formatSpeakerText(currentSentence.english, currentSentence.id);
                
                // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ë¥¼ ë‚˜ì¤‘ì— ì ìš© (ë¹„ë™ê¸°ë¡œ)
                if (highlightVerbs) {
                    applyVerbHighlightToElement(currentSubtitleDiv, currentSentence.english, currentSentence.id);
                }
                
                // í˜„ì¬ ìë§‰ ë²ˆì—­
                if (currentSentence.korean && currentSentence.korean.trim() !== '') {
                    currentSubtitleKoreanDiv.innerHTML = formatSpeakerText(currentSentence.korean);
                    currentSubtitleKoreanDiv.style.display = 'block';
                } else {
                    currentSubtitleKoreanDiv.style.display = 'none';
                }
                
                // ë‹¤ìŒ ìë§‰
                if (currentIndex < sentences.length - 1) {
                    nextSubtitleDiv.innerHTML = formatSpeakerText(sentences[currentIndex + 1].english, sentences[currentIndex + 1].id);
                    nextSubtitleDiv.style.display = 'block';
                } else {
                    nextSubtitleDiv.style.display = 'none';
                }
                
                // ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ìë™ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸
                updateSidebarHighlight(currentIndex);
                
                // ì˜¤ë²„ë ˆì´ ìë§‰ ì—…ë°ì´íŠ¸
                updateOverlaySubtitles(currentSentence);
                
                // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateSubtitleBookmarkButton();
            } else {
                // ì¬ìƒ ì¤‘ì¸ ìë§‰ì´ ì—†ì„ ë•Œ ëª¨ë“  ìë§‰ ìˆ¨ê¹€
                if (previousSubtitleDiv) previousSubtitleDiv.style.display = 'none';
                currentSubtitleDiv.innerHTML = '';
                if (currentSubtitleKoreanDiv) currentSubtitleKoreanDiv.style.display = 'none';
                if (nextSubtitleDiv) nextSubtitleDiv.style.display = 'none';
                currentSubtitleSentence = null;
                
                // ì˜¤ë²„ë ˆì´ ìë§‰ë„ ìˆ¨ê¹€
                updateOverlaySubtitles(null);
            }
        }
        
        // ì˜¤ë””ì˜¤ ìë§‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAudioSubtitles() {
            const videoSubtitlesDiv = document.getElementById('videoSubtitles');
            const currentSubtitleDiv = document.getElementById('currentSubtitle');
            
            if (audioPlayer.style.display === 'none' || !sentences || sentences.length === 0) {
                return;
            }
            
            const currentTime = audioPlayer.currentTime;
            const previousSubtitleDiv = document.getElementById('previousSubtitle');
            const currentSubtitleKoreanDiv = document.getElementById('currentSubtitleKorean');
            const nextSubtitleDiv = document.getElementById('nextSubtitle');
            let currentIndex = -1;
            
            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì¥ ì¸ë±ìŠ¤ ì°¾ê¸°
            for (let i = 0; i < sentences.length; i++) {
                if (currentTime >= sentences[i].startTime && currentTime <= sentences[i].endTime) {
                    currentIndex = i;
                    currentSubtitleSentence = sentences[i];
                    break;
                }
            }
            
            if (currentIndex >= 0 && subtitleDisplayVisible) {
                
                // ì´ì „ ìë§‰
                if (currentIndex > 0) {
                    previousSubtitleDiv.innerHTML = formatSpeakerText(sentences[currentIndex - 1].english, sentences[currentIndex - 1].id);
                    previousSubtitleDiv.style.display = 'block';
                } else {
                    previousSubtitleDiv.style.display = 'none';
                }
                
                // í˜„ì¬ ìë§‰
                const currentSentence = sentences[currentIndex];
                currentSubtitleDiv.innerHTML = formatSpeakerText(currentSentence.english, currentSentence.id);
                
                // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ë¥¼ ë‚˜ì¤‘ì— ì ìš© (ë¹„ë™ê¸°ë¡œ)
                if (highlightVerbs) {
                    applyVerbHighlightToElement(currentSubtitleDiv, currentSentence.english, currentSentence.id);
                }
                
                // í˜„ì¬ ìë§‰ ë²ˆì—­
                if (currentSentence.korean && currentSentence.korean.trim() !== '') {
                    currentSubtitleKoreanDiv.innerHTML = formatSpeakerText(currentSentence.korean);
                    currentSubtitleKoreanDiv.style.display = 'block';
                } else {
                    currentSubtitleKoreanDiv.style.display = 'none';
                }
                
                // ë‹¤ìŒ ìë§‰
                if (currentIndex < sentences.length - 1) {
                    nextSubtitleDiv.innerHTML = formatSpeakerText(sentences[currentIndex + 1].english, sentences[currentIndex + 1].id);
                    nextSubtitleDiv.style.display = 'block';
                } else {
                    nextSubtitleDiv.style.display = 'none';
                }
                
                // ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” ìë™ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸
                updateSidebarHighlight(currentIndex);
                
                // ì˜¤ë²„ë ˆì´ ìë§‰ ì—…ë°ì´íŠ¸
                updateOverlaySubtitles(currentSentence);
                
                // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateSubtitleBookmarkButton();
            } else {
                // ì¬ìƒ ì¤‘ì¸ ìë§‰ì´ ì—†ì„ ë•Œ ëª¨ë“  ìë§‰ ìˆ¨ê¹€
                if (previousSubtitleDiv) previousSubtitleDiv.style.display = 'none';
                currentSubtitleDiv.innerHTML = '';
                if (currentSubtitleKoreanDiv) currentSubtitleKoreanDiv.style.display = 'none';
                if (nextSubtitleDiv) nextSubtitleDiv.style.display = 'none';
                currentSubtitleSentence = null;
                
                // ì˜¤ë²„ë ˆì´ ìë§‰ë„ ìˆ¨ê¹€
                updateOverlaySubtitles(null);
            }
        }
        
        // ì‚¬ì´ë“œë°” í•˜ì´ë¼ì´íŠ¸ ë° ìë™ ìŠ¤í¬ë¡¤ í•¨ìˆ˜
        function updateSidebarHighlight(currentIndex) {
            // ì´ì „ì— ì¬ìƒ ì¤‘ì´ë˜ ë¬¸ì¥ê³¼ ê°™ìœ¼ë©´ ìŠ¤í¬ë¡¤ ì•ˆ í•¨ (ì„±ëŠ¥ ìµœì í™”)
            if (window.lastHighlightedIndex === currentIndex) {
                return;
            }
            window.lastHighlightedIndex = currentIndex;
            
            // ëª¨ë“  ë¬¸ì¥ì—ì„œ playing í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë¬¸ì¥ì— playing í´ë˜ìŠ¤ ì¶”ê°€ ë° ìŠ¤í¬ë¡¤
            const currentSentenceEl = document.querySelector(`[data-index="${currentIndex}"]`);
            if (currentSentenceEl) {
                currentSentenceEl.classList.add('playing');
                
                // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ë¡œ í˜„ì¬ ë¬¸ì¥ì„ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™
                currentSentenceEl.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }
        
        // ì˜¤ë²„ë ˆì´ ìë§‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOverlaySubtitles(currentSentence) {
            if (!overlaySubtitlesVisible) {
                return;
            }
            
            const overlaySubtitle = document.getElementById('videoOverlaySubtitles');
            
            if (currentSentence) {
                let subtitleText = '';
                
                // ì–¸ì–´ ì„ íƒì— ë”°ë¥¸ í…ìŠ¤íŠ¸ ì„¤ì • (ë™ê¸° ì²˜ë¦¬)
                switch(subtitleLanguage) {
                    case 'english':
                        subtitleText = formatSpeakerText(currentSentence.english || '', currentSentence.id);
                        break;
                    case 'korean':
                        subtitleText = formatSpeakerText(currentSentence.korean || '');
                        break;
                    case 'both':
                        const englishText = formatSpeakerText(currentSentence.english || '', currentSentence.id);
                        const koreanText = currentSentence.korean ? 
                            formatSpeakerText(currentSentence.korean) : '';
                        if (englishText && koreanText) {
                            subtitleText = englishText + '<br><br>' + koreanText;
                        } else {
                            subtitleText = englishText || koreanText;
                        }
                        break;
                }
                
                overlaySubtitle.innerHTML = subtitleText;
                overlaySubtitle.style.display = 'block';
                
                // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ë¥¼ ë‚˜ì¤‘ì— ì ìš© (ë¹„ë™ê¸°ë¡œ)
                if (highlightVerbs && subtitleLanguage !== 'korean') {
                    applyVerbHighlightToElement(overlaySubtitle, currentSentence.english, currentSentence.id);
                }
            } else {
                overlaySubtitle.style.display = 'none';
            }
        }
        
        // ì˜¤ë²„ë ˆì´ ìë§‰ ìƒíƒœ ë³€ìˆ˜ (í•­ìƒ í‘œì‹œ)
        let overlaySubtitlesVisible = true;
        
        // ì˜¤ë²„ë ˆì´ ìë§‰ ì„¤ì • ë³€ìˆ˜
        let overlayFontSizeScale = 1.2; // ê¸°ë³¸ í¬ê¸° (120%)
        let overlayPosition = 'center'; // ê¸°ë³¸ ìœ„ì¹˜ (ì¤‘ì•™)
        let subtitleLanguage = 'english'; // ê¸°ë³¸ ì–¸ì–´ (ì˜ì–´ë§Œ)
        let highlightVerbs = true; // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ ê¸°ë³¸ê°’
        let verbHighlightMode = 'highlight'; // 'highlight' or 'blank'
        let verbCache = new Map(); // ë™ì‚¬ ê°ì§€ ê²°ê³¼ ìºì‹œ
        let showBlanks = true; // ë¹ˆì¹¸ í‘œì‹œ ì—¬ë¶€ (Cí‚¤ë¡œ í† ê¸€)
        
        // spaCy APIë¥¼ í†µí•œ ì •í™•í•œ ë™ì‚¬ ê°ì§€ (DB ìºì‹œ ìš°ì„ )
        async function detectVerbs(text, sentenceId = null) {
            if (!text) return [];
            
            // ë¡œì»¬ ìºì‹œ í™•ì¸
            if (verbCache.has(text)) {
                return verbCache.get(text);
            }
            
            try {
                const requestBody = { text: text };
                if (sentenceId) {
                    requestBody.sentence_id = sentenceId;
                }
                
                const response = await fetch('/api/detect-verbs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                const verbs = data.verbs || [];
                
                // ìºì‹œì— ì €ì¥ (DB ìºì‹œë“  ì‹¤ì‹œê°„ì´ë“ )
                verbCache.set(text, verbs);
                
                if (data.cached) {
                    console.log('Using cached verbs from DB:', verbs);
                } else {
                    console.log('Real-time verb analysis:', verbs);
                }
                
                return verbs;
            } catch (error) {
                console.warn('spaCy API í˜¸ì¶œ ì‹¤íŒ¨, í´ë°± ì‚¬ìš©:', error);
                
                // í´ë°±: ê°„ë‹¨í•œ íŒ¨í„´ ë§¤ì¹­
                const fallbackVerbs = _detectVerbsFallback(text);
                verbCache.set(text, fallbackVerbs);
                return fallbackVerbs;
            }
        }
        
        // í´ë°± ë™ì‚¬ ê°ì§€ (API ì‹¤íŒ¨ì‹œ)
        function _detectVerbsFallback(text) {
            const commonVerbs = ['am', 'is', 'are', 'was', 'were', 'have', 'has', 'had', 'do', 'does', 'did', 
                               'go', 'went', 'come', 'came', 'get', 'got', 'make', 'made', 'take', 'took', 
                               'work', 'works', 'play', 'plays', 'run', 'runs', 'walk', 'walks', 'talk', 'talks'];
            
            const words = text.toLowerCase().match(/\b\w+\b/g) || [];
            const found = words.filter(word => commonVerbs.includes(word));
            
            return [...new Set(found)].slice(0, 3);
        }
        
        // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ ì ìš© í•¨ìˆ˜ (ë¹„ë™ê¸°)
        async function applyVerbHighlight(text, sentenceId = null) {
            if (!text || !highlightVerbs) return text;
            
            const verbs = await detectVerbs(text, sentenceId);
            let processedText = text;
            
            verbs.forEach(verb => {
                const regex = new RegExp(`\\b(${verb})\\b`, 'gi');
                
                if (verbHighlightMode === 'highlight') {
                    // ë‹¨ìˆœ ì»¬ëŸ¬ ë³€ê²½ (ë°°ê²½ ì œê±°)
                    processedText = processedText.replace(regex, 
                        '<span style="color: #ff6b35; font-weight: 600;">$1</span>'
                    );
                } else if (verbHighlightMode === 'blank') {
                    if (showBlanks) {
                        // ë¹ˆì¹¸ìœ¼ë¡œ ëŒ€ì²´ (í°ìƒ‰ ë°‘ì¤„)
                        processedText = processedText.replace(regex, 
                            '<span style="color: #ffffff; border-bottom: 1px solid #ffffff; display: inline-block; min-width: ' + (verb.length * 8) + 'px; text-align: center;">____</span>'
                        );
                    } else {
                        // ë¹ˆì¹¸ ìˆ¨ê¹€ (ì›ë˜ ë‹¨ì–´ í‘œì‹œí•˜ì§€ë§Œ íˆ¬ëª…í•˜ê²Œ)
                        processedText = processedText.replace(regex, 
                            '<span style="color: transparent; background: none;">$1</span>'
                        );
                    }
                }
            });
            
            return processedText;
        }
        
        // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ í† ê¸€ í•¨ìˆ˜
        function toggleVerbHighlight() {
            highlightVerbs = !highlightVerbs;
            updateVerbHighlightButton();
            updateCurrentSubtitles();
        }
        
        // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜ í•¨ìˆ˜
        function toggleVerbMode() {
            verbHighlightMode = verbHighlightMode === 'highlight' ? 'blank' : 'highlight';
            updateVerbModeButton();
            updateCurrentSubtitles();
        }
        
        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateVerbHighlightButton() {
            const btn = document.getElementById('verbHighlightBtn');
            if (highlightVerbs) {
                btn.innerHTML = 'ğŸ’›ON';
                btn.style.background = '#ffeb3b';
                btn.style.borderColor = '#ffeb3b';
                btn.style.color = '#333';
            } else {
                btn.innerHTML = 'âšªOFF';
                btn.style.background = '#333333';
                btn.style.borderColor = '#555555';
                btn.style.color = '#cccccc';
            }
        }
        
        function updateVerbModeButton() {
            const btn = document.getElementById('verbModeBtn');
            if (verbHighlightMode === 'highlight') {
                btn.innerHTML = 'ğŸ”†';
                btn.title = 'í•˜ì´ë¼ì´íŠ¸ ëª¨ë“œ (í´ë¦­í•˜ë©´ ë¹ˆì¹¸ ëª¨ë“œ)';
            } else {
                btn.innerHTML = 'ğŸ“';
                btn.title = 'ë¹ˆì¹¸ ëª¨ë“œ (í´ë¦­í•˜ë©´ í•˜ì´ë¼ì´íŠ¸ ëª¨ë“œ)';
            }
        }
        
        // í˜„ì¬ ìë§‰ ì—…ë°ì´íŠ¸
        function updateCurrentSubtitles() {
            if (currentSubtitleSentence) {
                updateVideoSubtitles();
                updateOverlaySubtitles(currentSubtitleSentence);
            }
        }
        
        // í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤ í•¸ë“¤ëŸ¬
        function handleKeyboardControls(event) {
            // ì…ë ¥ í•„ë“œì—ì„œ íƒ€ì´í•‘ ì¤‘ì¼ ë•ŒëŠ” í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤ ë¬´ì‹œ
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.contentEditable === 'true') {
                return;
            }
            
            const player = currentPlayer;
            if (!player || !sentences || sentences.length === 0) {
                return;
            }
            
            switch(event.code) {
                case 'ArrowLeft':
                    event.preventDefault();
                    goToPreviousSubtitle();
                    break;
                    
                case 'ArrowRight':
                    event.preventDefault();
                    goToNextSubtitle();
                    break;
                    
                case 'Space':
                    event.preventDefault();
                    togglePlayPause();
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    adjustVolume(0.1);
                    break;
                    
                case 'ArrowDown':
                    event.preventDefault();
                    adjustVolume(-0.1);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    toggleCurrentSubtitleBookmark();
                    break;
                    
                case 'KeyC':
                    event.preventDefault();
                    toggleBlankVisibility();
                    break;
            }
        }
        
        // ì´ì „ ìë§‰ìœ¼ë¡œ ì´ë™
        function goToPreviousSubtitle() {
            if (!sentences || sentences.length === 0) return;
            
            let targetIndex = -1;
            
            if (currentSentenceIndex >= 0 && currentSentenceIndex > 0) {
                targetIndex = currentSentenceIndex - 1;
            } else {
                // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìë§‰ì„ ì°¾ì•„ì„œ ì´ì „ìœ¼ë¡œ
                const currentTime = currentPlayer.currentTime;
                for (let i = sentences.length - 1; i >= 0; i--) {
                    if (currentTime >= sentences[i].startTime) {
                        targetIndex = Math.max(0, i - 1);
                        break;
                    }
                }
            }
            
            if (targetIndex >= 0) {
                playSentence(targetIndex);
            }
        }
        
        // ë‹¤ìŒ ìë§‰ìœ¼ë¡œ ì´ë™
        function goToNextSubtitle() {
            if (!sentences || sentences.length === 0) return;
            
            let targetIndex = -1;
            
            if (currentSentenceIndex >= 0 && currentSentenceIndex < sentences.length - 1) {
                targetIndex = currentSentenceIndex + 1;
            } else {
                // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìë§‰ì„ ì°¾ì•„ì„œ ë‹¤ìŒìœ¼ë¡œ
                const currentTime = currentPlayer.currentTime;
                for (let i = 0; i < sentences.length; i++) {
                    if (currentTime < sentences[i].endTime) {
                        targetIndex = Math.min(sentences.length - 1, i + 1);
                        break;
                    }
                }
            }
            
            if (targetIndex >= 0 && targetIndex < sentences.length) {
                playSentence(targetIndex);
            }
        }
        
        // ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€
        function togglePlayPause() {
            if (!currentPlayer) return;
            
            if (currentPlayer.paused) {
                currentPlayer.play().catch(error => {
                    console.error('Play error:', error);
                });
            } else {
                currentPlayer.pause();
            }
        }
        
        // ë³¼ë¥¨ ì¡°ì ˆ
        function adjustVolume(delta) {
            if (!currentPlayer) return;
            
            const newVolume = Math.max(0, Math.min(1, currentPlayer.volume + delta));
            currentPlayer.volume = newVolume;
            
            // ë³¼ë¥¨ í‘œì‹œ (ì„ì‹œ)
            showVolumeIndicator(Math.round(newVolume * 100));
        }
        
        // ë³¼ë¥¨ í‘œì‹œê¸°
        function showVolumeIndicator(volumePercent) {
            // ê¸°ì¡´ ì¸ë””ì¼€ì´í„° ì œê±°
            const existingIndicator = document.getElementById('volumeIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // ìƒˆ ë³¼ë¥¨ ì¸ë””ì¼€ì´í„° ìƒì„±
            const indicator = document.createElement('div');
            indicator.id = 'volumeIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-size: 18px;
                z-index: 10000;
                pointer-events: none;
            `;
            indicator.innerHTML = `ğŸ”Š ë³¼ë¥¨: ${volumePercent}%`;
            
            document.body.appendChild(indicator);
            
            // 2ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 2000);
        }
        
        // í˜„ì¬ ìë§‰ ì¦ê²¨ì°¾ê¸° í† ê¸€
        function toggleCurrentSubtitleBookmark() {
            if (currentSentenceIndex >= 0 && currentSentenceIndex < sentences.length) {
                toggleBookmark(currentSentenceIndex);
            }
        }
        
        // ë¹ˆì¹¸ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€ (Cí‚¤)
        function toggleBlankVisibility() {
            showBlanks = !showBlanks;
            
            // ë¹ˆì¹¸ ìƒíƒœ í‘œì‹œ
            showBlankToggleIndicator(showBlanks);
            
            // í˜„ì¬ í‘œì‹œëœ ìë§‰ë“¤ì„ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
            updateCurrentSubtitles();
        }
        
        // ë¹ˆì¹¸ í† ê¸€ ìƒíƒœ í‘œì‹œê¸°
        function showBlankToggleIndicator(isVisible) {
            // ê¸°ì¡´ ì¸ë””ì¼€ì´í„° ì œê±°
            const existingIndicator = document.getElementById('blankToggleIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // ìƒˆ ìƒíƒœ ì¸ë””ì¼€ì´í„° ìƒì„±
            const indicator = document.createElement('div');
            indicator.id = 'blankToggleIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-size: 18px;
                z-index: 10000;
                pointer-events: none;
            `;
            indicator.innerHTML = isVisible ? 'ğŸ‘ï¸ ë¹ˆì¹¸ ë³´ì´ê¸°' : 'ğŸ™ˆ ë¹ˆì¹¸ ìˆ¨ê¸°ê¸°';
            
            document.body.appendChild(indicator);
            
            // 2ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 2000);
        }
        
        // í™”ì êµ¬ë¶„ì„ ìœ„í•œ í…ìŠ¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜ (ë™ê¸°)
        function formatSpeakerText(text, sentenceId = null) {
            if (!text) return '';
            // ' - ' ë¥¼ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜ (í™”ì êµ¬ë¶„)
            let formattedText = text.replace(/\s*-\s*/g, '<br>');
            
            // ë¬¸ë²• íŒ¨í„´ í•˜ì´ë¼ì´íŠ¸ ë¨¼ì € ì ìš©
            if (grammarHighlightEnabled && sentenceId) {
                formattedText = applyGrammarHighlight(formattedText);
            }
            
            // ë‹¨ì–´ë¥¼ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸° (sentenceIdê°€ ìˆì„ ë•Œë§Œ)
            if (sentenceId) {
                formattedText = makeWordsInteractive(formattedText, sentenceId, text);
            }
            
            return formattedText;
        }
        
        // ë¬¸ë²• íŒ¨í„´ í•˜ì´ë¼ì´íŠ¸ ì ìš©
        function applyGrammarHighlight(text) {
            let highlightedText = text;
            
            // 1. ì¡°ê±´ë¬¸ íŒ¨í„´ (if, unless, provided that ë“±)
            highlightedText = highlightedText.replace(
                /\b(if|unless|provided that|as long as|in case)\b/gi,
                '<span class="grammar-conditional">$1</span>'
            );
            
            // 2. ì‹œê°„ í‘œí˜„ (when, while, before, after ë“±)
            highlightedText = highlightedText.replace(
                /\b(when|while|before|after|during|since|until|as soon as)\b/gi,
                '<span class="grammar-time">$1</span>'
            );
            
            // 3. ì›ì¸/ê²°ê³¼ (because, so, therefore ë“±)
            highlightedText = highlightedText.replace(
                /\b(because|since|as|so|therefore|thus|consequently|as a result)\b/gi,
                '<span class="grammar-cause">$1</span>'
            );
            
            // 4. ëŒ€ì¡°/ì–‘ë³´ (but, however, although ë“±)
            highlightedText = highlightedText.replace(
                /\b(but|however|although|though|despite|in spite of|nevertheless|nonetheless)\b/gi,
                '<span class="grammar-contrast">$1</span>'
            );
            
            // 5. ìˆ˜ë™íƒœ íŒ¨í„´ (be + past participle)
            highlightedText = highlightedText.replace(
                /\b(am|is|are|was|were|been|being)\s+([\w]+ed|[\w]+en)\b/gi,
                '<span class="grammar-passive">$1 $2</span>'
            );
            
            // 6. ì™„ë£Œì‹œì œ (have/has + past participle)
            highlightedText = highlightedText.replace(
                /\b(have|has|had)\s+([\w]+ed|[\w]+en)\b/gi,
                '<span class="grammar-perfect">$1 $2</span>'
            );
            
            // 7. ë¯¸ë˜ì‹œì œ (will, going to)
            highlightedText = highlightedText.replace(
                /\b(will|shall|going to)\s+(\w+)/gi,
                '<span class="grammar-future">$1 $2</span>'
            );
            
            // 8. ëª¨ë‹¬ë™ì‚¬ (can, could, should ë“±)
            highlightedText = highlightedText.replace(
                /\b(can|could|should|would|might|may|must|ought to)\s+(\w+)/gi,
                '<span class="grammar-modal">$1 $2</span>'
            );
            
            return highlightedText;
        }
        
        // ë‹¨ì–´ ìºì‹œ (ë¶ë§ˆí¬ ê¸°ëŠ¥ìš©)
        let wordDefinitionCache = new Map(); // ë‹¨ì–´ ì •ë³´ ìºì‹œ
        let difficultyHighlightEnabled = true; // ë‚œì´ë„ í•˜ì´ë¼ì´íŠ¸ í™œì„±í™”
        let difficultyHighlightCache = new Map(); // ë‚œì´ë„ ìºì‹œ
        let grammarHighlightEnabled = true; // ë¬¸ë²• íŒ¨í„´ í•˜ì´ë¼ì´íŠ¸ í™œì„±í™”
        
        // í…ìŠ¤íŠ¸ì˜ ë‹¨ì–´ë“¤ì„ ì¸í„°ë™í‹°ë¸Œí•˜ê²Œ ë§Œë“¤ê¸°
        function makeWordsInteractive(text, sentenceId, originalText) {
            // HTML íƒœê·¸ ë‚´ë¶€ëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³ , ì¼ë°˜ í…ìŠ¤íŠ¸ë§Œ ì²˜ë¦¬
            return text.replace(/([^<>]+)(?=<|$)/g, function(match) {
                // ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¶„í• í•˜ì—¬ spanìœ¼ë¡œ ê°ì‹¸ê¸°
                return match.replace(/\b([a-zA-Z]+(?:'[a-zA-Z]+)?)\b/g, function(word) {
                    const wordLower = word.toLowerCase();
                    
                    // ì¼ë‹¨ ê¸°ë³¸ í´ë˜ìŠ¤ë¡œ span ìƒì„±
                    const spanHtml = `<span class="interactive-word" 
                                  data-word="${wordLower}" 
                                  data-sentence-id="${sentenceId}"
                                  data-context="${originalText}"
                                  onclick="bookmarkWord(this)">
                                ${word}
                            </span>`;
                    
                    // ë‚œì´ë„ í´ë˜ìŠ¤ë¥¼ ë¹„ë™ê¸°ë¡œ ì ìš©
                    if (difficultyHighlightEnabled) {
                        setTimeout(async () => {
                            try {
                                const difficultyClass = await getDifficultyClass(wordLower);
                                if (difficultyClass) {
                                    // ê°™ì€ ë‹¨ì–´ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— í´ë˜ìŠ¤ ì ìš©
                                    const elements = document.querySelectorAll(`[data-word="${wordLower}"]`);
                                    elements.forEach(el => el.classList.add(difficultyClass));
                                }
                            } catch (error) {
                                console.warn('Failed to apply difficulty class:', error);
                            }
                        }, 0);
                    }
                    
                    return spanHtml;
                });
            });
        }
        
        // ë‹¨ì–´ ë‚œì´ë„ì— ë”°ë¥¸ CSS í´ë˜ìŠ¤ ë°˜í™˜
        async function getDifficultyClass(word) {
            // ìºì‹œì—ì„œ í™•ì¸
            if (difficultyHighlightCache.has(word)) {
                return difficultyHighlightCache.get(word);
            }
            
            try {
                // APIë¥¼ í†µí•´ ì‹¤ì œ CEFR ë°ì´í„° í™•ì¸
                const response = await fetch(`/api/word/difficulty/${encodeURIComponent(word)}`);
                const data = await response.json();
                
                const className = data.difficulty === 'hard' ? 'difficulty-hard' : '';
                
                // ìºì‹œì— ì €ì¥
                difficultyHighlightCache.set(word, className);
                
                return className;
            } catch (error) {
                // API ì˜¤ë¥˜ ì‹œ ë¹ˆ í´ë˜ìŠ¤ ë°˜í™˜
                console.warn('Difficulty API error:', error);
                difficultyHighlightCache.set(word, '');
                return '';
            }
        }
        
        
        
        // ë‹¨ì–´ ë¶ë§ˆí¬ (í´ë¦­ ì‹œ)
        async function bookmarkWord(element) {
            const word = element.dataset.word;
            const sentenceId = element.dataset.sentenceId;
            const context = element.dataset.context;
            
            console.log('Adding word to vocabulary:', word);
            
            // ì‹œê°ì  í”¼ë“œë°± - ë¡œë”©
            element.style.background = 'rgba(255, 193, 7, 0.3)';
            element.style.transition = 'all 0.3s ease';
            
            try {
                // ê°œì¸ ë‹¨ì–´ì¥ì— ì¶”ê°€ (ë‹¨ìˆœí™”ëœ ë²„ì „)
                const addResponse = await fetch('/api/vocabulary/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word: word,
                        context_sentence: context,
                        sentence_id: sentenceId
                    })
                });
                
                if (addResponse.ok) {
                    // ì„±ê³µ í”¼ë“œë°±
                    element.style.background = 'rgba(76, 175, 80, 0.4)';
                    element.style.border = '1px solid #4CAF50';
                    element.classList.add('vocab-added');
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showVocabMessage('ğŸ“š ë‹¨ì–´ì¥ì— ì¶”ê°€ë¨!', '#4CAF50');
                    
                    // ê°œì¸ ë‹¨ì–´ì¥ í†µê³„ ì—…ë°ì´íŠ¸
                    updateVocabularyStats();
                    
                } else {
                    throw new Error('Failed to add word to vocabulary');
                }
                
            } catch (error) {
                console.error('Error adding word to vocabulary:', error);
                
                // ì˜¤ë¥˜ í”¼ë“œë°±
                element.style.background = 'rgba(244, 67, 54, 0.3)';
                showVocabMessage('âŒ ë‹¨ì–´ì¥ ì¶”ê°€ ì‹¤íŒ¨', '#F44336');
            }
            
            // 2ì´ˆ í›„ ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì› (vocab-added í´ë˜ìŠ¤ëŠ” ìœ ì§€)
            setTimeout(() => {
                if (!element.classList.contains('vocab-added')) {
                    element.style.background = '';
                    element.style.border = '';
                }
            }, 2000);
        }
        
        // ë‹¨ì–´ì¥ ë©”ì‹œì§€ í‘œì‹œ
        function showVocabMessage(message, color) {
            const existingMsg = document.getElementById('vocabMessage');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.id = 'vocabMessage';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 10002;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease;
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => messageDiv.remove(), 300);
                }
            }, 3000);
        }
        
        // ê°œì¸ ë‹¨ì–´ì¥ í†µê³„ ì—…ë°ì´íŠ¸
        async function updateVocabularyStats() {
            try {
                const response = await fetch('/api/vocabulary/statistics');
                if (response.ok) {
                    const stats = await response.json();
                    
                    // í†µê³„ í‘œì‹œ (í•„ìš”ì‹œ UI ì—…ë°ì´íŠ¸)
                    console.log('Vocabulary stats:', stats);
                    
                    // TODO: í†µê³„ë¥¼ UIì— í‘œì‹œí•˜ëŠ” ê¸°ëŠ¥ êµ¬í˜„
                }
            } catch (error) {
                console.error('Error updating vocabulary stats:', error);
            }
        }
        
        // ë™ì‚¬ í•˜ì´ë¼ì´íŠ¸ë¥¼ ë‚˜ì¤‘ì— ì ìš©í•˜ëŠ” í•¨ìˆ˜
        async function applyVerbHighlightToElement(element, text, sentenceId = null) {
            if (!text || !highlightVerbs) return;
            
            try {
                const highlightedText = await applyVerbHighlight(text, sentenceId);
                if (element && element.innerHTML !== highlightedText) {
                    element.innerHTML = highlightedText;
                }
            } catch (error) {
                console.warn('Error applying verb highlight:', error);
            }
        }
        
        // ìë§‰ ì–¸ì–´ ì„ íƒ í•¨ìˆ˜
        function setSubtitleLanguage(language) {
            subtitleLanguage = language;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const engBtn = document.getElementById('subtitleEngBtn');
            const korBtn = document.getElementById('subtitleKorBtn');
            const bothBtn = document.getElementById('subtitleBothBtn');
            
            // ëª¨ë“  ë²„íŠ¼ ì´ˆê¸°í™”
            [engBtn, korBtn, bothBtn].forEach(btn => {
                btn.style.background = '#333333';
                btn.style.color = '#cccccc';
                btn.style.borderColor = '#555555';
            });
            
            // ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
            let activeBtn;
            switch(language) {
                case 'english':
                    activeBtn = engBtn;
                    break;
                case 'korean':
                    activeBtn = korBtn;
                    break;
                case 'both':
                    activeBtn = bothBtn;
                    break;
            }
            
            if (activeBtn) {
                activeBtn.style.background = '#0e639c';
                activeBtn.style.color = '#ffffff';
                activeBtn.style.borderColor = '#0e639c';
            }
            
            // í˜„ì¬ ìë§‰ ì—…ë°ì´íŠ¸
            if (currentSubtitleSentence) {
                updateVideoSubtitles();
                updateOverlaySubtitles(currentSubtitleSentence);
            }
        }
        
        // ì˜¤ë²„ë ˆì´ í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
        function adjustOverlaySize(delta) {
            overlayFontSizeScale += delta;
            
            // ìµœì†Œ 0.5 (50%), ìµœëŒ€ 3.0 (300%)
            if (overlayFontSizeScale < 0.5) overlayFontSizeScale = 0.5;
            if (overlayFontSizeScale > 3.0) overlayFontSizeScale = 3.0;
            
            updateOverlayStyles();
        }
        
        // ì˜¤ë²„ë ˆì´ í¬ê¸° ì´ˆê¸°í™”
        function resetOverlaySize() {
            overlayFontSizeScale = 1.2;
            updateOverlayStyles();
        }
        
        // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì„¤ì •
        function setOverlayPosition(position) {
            overlayPosition = position;
            updateOverlayStyles();
            updatePositionButtons();
        }
        
        // ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        function updateOverlayStyles() {
            const overlaySubtitle = document.getElementById('videoOverlaySubtitles');
            const sizeDisplay = document.getElementById('overlaySizeDisplay');
            
            // ê¸°ë³¸ í°íŠ¸ í¬ê¸° 3.5emì— ìŠ¤ì¼€ì¼ ì ìš©
            const fontSize = 3.5 * overlayFontSizeScale;
            overlaySubtitle.style.fontSize = fontSize + 'em';
            
            // ìœ„ì¹˜ ì„¤ì •
            if (overlayPosition === 'center') {
                overlaySubtitle.style.top = '50%';
                overlaySubtitle.style.bottom = 'auto';
                overlaySubtitle.style.transform = 'translate(-50%, -50%)';
            } else { // bottom
                overlaySubtitle.style.top = 'auto';
                overlaySubtitle.style.bottom = '15%';
                overlaySubtitle.style.transform = 'translateX(-50%)';
            }
            
            // í¬ê¸° í‘œì‹œ ì—…ë°ì´íŠ¸
            const percentage = Math.round(overlayFontSizeScale * 100);
            sizeDisplay.textContent = percentage + '%';
        }
        
        // ìœ„ì¹˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updatePositionButtons() {
            const centerBtn = document.getElementById('positionCenterBtn');
            const bottomBtn = document.getElementById('positionBottomBtn');
            
            if (overlayPosition === 'center') {
                centerBtn.style.background = '#0e639c';
                centerBtn.style.borderColor = '#0e639c';
                centerBtn.style.color = '#ffffff';
                
                bottomBtn.style.background = '#333333';
                bottomBtn.style.borderColor = '#555555';
                bottomBtn.style.color = '#cccccc';
            } else {
                centerBtn.style.background = '#333333';
                centerBtn.style.borderColor = '#555555';
                centerBtn.style.color = '#cccccc';
                
                bottomBtn.style.background = '#0e639c';
                bottomBtn.style.borderColor = '#0e639c';
                bottomBtn.style.color = '#ffffff';
            }
        }
        
        // ìë§‰ í‘œì‹œ í† ê¸€ í•¨ìˆ˜
        function toggleSubtitleDisplay() {
            const videoSubtitlesDiv = document.getElementById('videoSubtitles');
            const toggleBtn = document.getElementById('subtitleToggleBtn');
            
            subtitleDisplayVisible = !subtitleDisplayVisible;
            
            if (subtitleDisplayVisible) {
                videoSubtitlesDiv.style.display = 'flex';
                toggleBtn.innerHTML = 'ğŸ”½ ìˆ¨ê¸°ê¸°';
            } else {
                videoSubtitlesDiv.style.display = 'none';
                toggleBtn.innerHTML = 'ğŸ”¼ ë³´ì´ê¸°';
            }
        }
        
        // ìë§‰ ë¶ë§ˆí¬ í† ê¸€ í•¨ìˆ˜
        function toggleSubtitleBookmark() {
            if (!currentSubtitleSentence) {
                console.log('No current subtitle sentence');
                return;
            }
            
            // í˜„ì¬ ìë§‰ ë¬¸ì¥ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
            const sentenceIndex = sentences.findIndex(s => s.id === currentSubtitleSentence.id);
            if (sentenceIndex === -1) {
                console.log('Sentence not found in sentences array');
                return;
            }
            
            // ë¶ë§ˆí¬ ìƒíƒœ í† ê¸€
            const sentence = sentences[sentenceIndex];
            const newBookmarkState = !sentence.bookmark;
            
            console.log('Toggling bookmark for sentence:', sentence.id, 'to:', newBookmarkState);
            
            // ì„œë²„ì— ë¶ë§ˆí¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            fetch(`/api/media/${currentMedia}/sentences/${sentence.id}/bookmark`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bookmark: newBookmarkState })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
                    sentence.bookmark = newBookmarkState;
                    
                    // UI ì—…ë°ì´íŠ¸
                    updateSubtitleBookmarkButton();
                    
                    // ë¬¸ì¥ ëª©ë¡ì˜ í•´ë‹¹ í•­ëª©ë„ ì—…ë°ì´íŠ¸
                    const sentenceElement = document.querySelector(`[data-index="${sentenceIndex}"]`);
                    if (sentenceElement) {
                        if (newBookmarkState) {
                            sentenceElement.classList.add('bookmarked');
                        } else {
                            sentenceElement.classList.remove('bookmarked');
                        }
                    }
                    
                    // ë¶ë§ˆí¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                    updateBookmarkedList();
                    
                    console.log('Bookmark updated successfully');
                } else {
                    console.error('Failed to update bookmark:', data.error);
                }
            })
            .catch(error => {
                console.error('Bookmark update error:', error);
            });
        }
        
        // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateSubtitleBookmarkButton() {
            const btn = document.getElementById('subtitleBookmarkBtn');
            if (!btn || !currentSubtitleSentence) return;
            
            const sentenceElement = document.querySelector(`[data-sentence-id="${currentSubtitleSentence.id}"]`);
            if (sentenceElement && sentenceElement.classList.contains('bookmarked')) {
                btn.innerHTML = 'â˜…';
                btn.style.background = '#ff9800';
                btn.style.color = '#ffffff';
            } else {
                btn.innerHTML = 'â˜†';
                btn.style.background = '#333333';
                btn.style.color = '#cccccc';
            }
        }
        
        // ìë§‰ ì‚­ì œ í•¨ìˆ˜
        function deleteSubtitles() {
            if (!currentMedia) {
                const statusEl = document.getElementById('generationStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = 'âŒ ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ì‚­ì œ í™•ì¸ì„ ìœ„í•´ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
            const deleteBtn = event.target;
            if (deleteBtn.textContent === 'ğŸ—‘ï¸ ìë§‰ ì‚­ì œ') {
                deleteBtn.textContent = 'â— ì •ë§ ì‚­ì œ?';
                deleteBtn.style.background = '#ff4444';
                setTimeout(() => {
                    deleteBtn.textContent = 'ğŸ—‘ï¸ ìë§‰ ì‚­ì œ';
                    deleteBtn.style.background = '#d32f2f';
                }, 3000);
                return;
            }
            
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = 'ğŸ—‘ï¸ ìë§‰ ì‚­ì œ ì¤‘...';
            
            fetch(`/api/media/${currentMedia}/subtitles`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = 'âœ… ìë§‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ìë§‰ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    
                    // ë¬¸ì¥ ëª©ë¡ ì´ˆê¸°í™”
                    document.getElementById('sentenceList').innerHTML = '';
                    sentences = [];
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                    
                    // 5ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                } else {
                    statusEl.innerHTML = `âŒ ìë§‰ ì‚­ì œ ì‹¤íŒ¨: ${data.error}`;
                }
            })
            .catch(error => {
                console.error('Delete subtitles error:', error);
                statusEl.innerHTML = `âŒ ìë§‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            });
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const whisperModal = document.getElementById('whisperModal');
            const srtModal = document.getElementById('srtModal');
            
            if (event.target == whisperModal) {
                whisperModal.style.display = 'none';
            }
            if (event.target == srtModal) {
                srtModal.style.display = 'none';
            }
        }
        
        function loadMediaSentences(mediaId) {
            console.log('loadMediaSentences called with mediaId:', mediaId);
            currentMedia = mediaId;
            
            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('uploadSection').style.display = 'none';
            
            // ì˜ìƒ ì¬ìƒí™”ë©´ì´ í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì • (ìë§‰ íŒ¨ë„ë¡œ ì „í™˜í•˜ì§€ ì•ŠìŒ)
            // showPanel('subtitle'); // ì´ ì¤„ì„ ì œê±°í•˜ì—¬ í˜„ì¬ íŒ¨ë„ ìœ ì§€
            
            // ë¯¸ë””ì–´ í”Œë ˆì´ì–´ì™€ ìë§‰ ì»¨í…Œì´ë„ˆê°€ ë³´ì´ë„ë¡ í™•ì¸
            const mediaPlayerDiv = document.querySelector('.media-player');
            if (mediaPlayerDiv) {
                mediaPlayerDiv.style.display = 'block';
            }
            
            // ìë§‰ ì»¨í…Œì´ë„ˆë„ í•­ìƒ ë³´ì´ë„ë¡ ì„¤ì •
            const videoSubtitlesContainer = document.getElementById('videoSubtitlesContainer');
            if (videoSubtitlesContainer) {
                videoSubtitlesContainer.style.display = 'block';
            }
            
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ ê°•ì¡°
            document.querySelectorAll('.media-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.mediaId == mediaId) {
                    item.classList.add('active');
                }
            });
            
            // ë¯¸ë””ì–´ ì •ë³´ ë¡œë“œ (íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸°)
            fetch('/api/media')
                .then(response => response.json())
                .then(mediaList => {
                    const media = mediaList.find(m => m.id == mediaId);
                    if (media) {
                        // í”Œë ˆì´ì–´ì— íŒŒì¼ ë¡œë“œ (ì˜ìƒ/ì˜¤ë””ì˜¤ êµ¬ë¶„)
                        const mediaTitle = document.getElementById('mediaTitle');
                        const mediaPlayerDiv = document.querySelector('.media-player');
                        
                        // ì˜ìƒ íŒŒì¼ í™•ì¸
                        const videoExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm', 'flv'];
                        const fileExt = media.filename.toLowerCase().split('.').pop();
                        const isVideoFile = videoExtensions.includes(fileExt);
                        
                        if (isVideoFile) {
                            // HTML5 ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                            const videoSrc = `/api/audio/${media.filename}`;
                            console.log('Loading video:', videoSrc);
                            
                            videoPlayer.src = videoSrc;
                            videoPlayer.load();
                            
                            document.getElementById('videoContainer').style.display = 'block';
                            audioPlayer.style.display = 'none';
                            document.getElementById('videoSubtitlesContainer').style.display = 'block';
                            currentPlayer = videoPlayer;
                            
                            // ë¹„ë””ì˜¤ ë¡œë“œ í›„ í¬ê¸° ì—…ë°ì´íŠ¸
                            videoPlayer.addEventListener('loadedmetadata', updateVideoSize, { once: true });
                        } else {
                            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                            audioPlayer.src = `/api/audio/${media.filename}`;
                            audioPlayer.style.display = 'block';
                            document.getElementById('videoContainer').style.display = 'none';  // .el() ì œê±°
                            videoPlayer.src = '';  // ë¹„ë””ì˜¤ ì†ŒìŠ¤ ì œê±°
                            videoPlayer.load();     // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ë¦¬ì…‹
                            document.getElementById('videoSubtitlesContainer').style.display = 'block';  // ì˜¤ë””ì˜¤ì—ë„ ìë§‰ í‘œì‹œ
                            currentPlayer = audioPlayer;
                        }
                        
                        mediaTitle.textContent = media.filename;
                        mediaPlayerDiv.style.display = 'block';
                        
                        // ë¯¸ë””ì–´ ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ ì—¬ë¶€ ê²°ì •
                        const processingOptions = document.getElementById('processingOptions');
                        
                        if (media.status === 'uploaded' || media.status === 'error' || (isVideoFile && media.status === 'completed')) {
                            // ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë¯¸ë””ì–´ ë˜ëŠ” ì˜ìƒ íŒŒì¼ì€ ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ
                            processingOptions.style.display = 'block';
                            uploadedMediaId = media.id; // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
                        } else {
                            // ì´ë¯¸ ì²˜ë¦¬ëœ ì˜¤ë””ì˜¤ íŒŒì¼ì€ ì²˜ë¦¬ ì˜µì…˜ ìˆ¨ê¹€
                            processingOptions.style.display = 'none';
                        }
                        
                        console.log(`Loaded audio: ${media.filename}, status: ${media.status}`);
                    }
                })
                .catch(error => {
                    console.error('Failed to load media info:', error);
                });
            
            // ì±•í„° êµ¬ì¡° ë¡œë“œ
            fetch(`/api/media/${mediaId}/chapters`)
                .then(response => response.json())
                .then(chapters => {
                    displayChapters(chapters);
                })
                .catch(error => {
                    console.error('Failed to load chapters:', error);
                });
            
            // ê·¸ë£¹í™”ëœ ë¬¸ì¥ ë¡œë“œ
            console.log('Fetching grouped sentences for mediaId:', mediaId);
            fetch(`/api/media/${mediaId}/sentences-grouped`)
                .then(response => {
                    console.log('Sentences API response status:', response.status);
                    return response.json();
                })
                .then(chapters => {
                    console.log('Received chapters data:', chapters);
                    displayGroupedSentences(chapters);
                    console.log(`Loaded ${chapters.length} chapters with scenes and sentences`);
                })
                .catch(error => {
                    console.error('Failed to load grouped sentences:', error);
                });
            
            // ë²ˆì—­ ìƒíƒœ í™•ì¸
            checkTranslationStatus();
            
            // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë™ì‚¬ ë¶„ì„ ì‹œì‘
            startVerbAnalysis(mediaId);
            
            // ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” í‘œì‹œ (ë¬¸ì¥ ëª©ë¡ì´ ìˆëŠ” ê²½ìš°)
            const rightSidebar = document.getElementById('rightSidebar');
            if (rightSidebar.classList.contains('collapsed')) {
                toggleRightSidebar();
            }
        }
        
        // ë°±ê·¸ë¼ìš´ë“œ ë™ì‚¬ ë¶„ì„ ì‹œì‘
        function startVerbAnalysis(mediaId) {
            console.log('Starting background verb analysis for media:', mediaId);
            
            fetch(`/api/media/${mediaId}/analyze-verbs`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('âœ“ Background verb analysis started:', data.message);
                } else {
                    console.warn('Failed to start verb analysis:', data.error);
                }
            })
            .catch(error => {
                console.warn('Error starting verb analysis:', error);
            });
        }
        
        function loadGroupedSentences(mediaId) {
            // ê·¸ë£¹í™”ëœ ë¬¸ì¥ ë¡œë“œ
            fetch(`/api/media/${mediaId}/sentences-grouped`)
                .then(response => response.json())
                .then(chapters => {
                    displayGroupedSentences(chapters);
                    console.log(`Loaded ${chapters.length} chapters with scenes and sentences`);
                })
                .catch(error => {
                    console.error('Failed to load grouped sentences:', error);
                });
        }
        
        function displayChapters(chapters) {
            const chapterListEl = document.getElementById('chapterList');
            const chapterContentEl = document.getElementById('chapterContent');
            
            if (chapters.length === 0) {
                chapterListEl.style.display = 'none';
                return;
            }
            
            chapterListEl.style.display = 'block';
            
            let html = '';
            chapters.forEach(chapter => {
                html += `<div class="chapter-item">
                    <strong>${chapter.title}</strong> (${chapter.startTime.toFixed(1)}s - ${chapter.endTime.toFixed(1)}s)
                    <div>${chapter.scene_count}ê°œ ì”¬</div>
                `;
                
                chapter.scenes.forEach(scene => {
                    html += `<div class="scene-item">
                        ${scene.title} (${scene.sentence_count}ê°œ ë¬¸ì¥)
                    </div>`;
                });
                
                html += '</div>';
            });
            
            chapterContentEl.innerHTML = html;
        }
        
        function loadSimulationData() {
            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
            sentences = [
                {
                    id: 1,
                    english: "What are you doing?",
                    korean: "ë­ í•˜ê³  ìˆì–´?",
                    start_time: 0,
                    end_time: 2,
                    bookmark: false
                },
                {
                    id: 2,
                    english: "I'm learning English with this amazing tool.",
                    korean: "ì´ ë©‹ì§„ ë„êµ¬ë¡œ ì˜ì–´ë¥¼ ê³µë¶€í•˜ê³  ìˆì–´ìš”.",
                    start_time: 2,
                    end_time: 5,
                    bookmark: false
                },
                {
                    id: 3,
                    english: "Can you help me with my pronunciation?",
                    korean: "ë°œìŒ ë„ì™€ì¤„ ìˆ˜ ìˆì–´?",
                    start_time: 5,
                    end_time: 8,
                    bookmark: false
                }
            ];
            
            displaySentences();
        }
        
        function generateSentences() {
            // ì‹¤ì œë¡œëŠ” Whisper API í˜¸ì¶œ
            loadSimulationData();
        }
        
        function displayGroupedSentences(chapters) {
            const listEl = document.getElementById('sentenceList');
            if (!listEl) {
                console.error('sentenceList element not found!');
                return;
            }
            
            listEl.innerHTML = '';
            
            // ì „ì—­ sentences ë°°ì—´ ì´ˆê¸°í™”
            sentences = [];
            let globalIndex = 0;
            
            console.log('displayGroupedSentences called with:', chapters);
            console.log('sentenceList element:', listEl);

            chapters.forEach((chapter, chapterIndex) => {
                // ì±•í„° ì„¹ì…˜ ìƒì„±
                const chapterSection = document.createElement('div');
                chapterSection.className = 'chapter-section';
                chapterSection.dataset.chapterId = chapter.id;
                
                // ì±•í„° í—¤ë”
                const chapterHeader = document.createElement('div');
                chapterHeader.className = 'chapter-header';
                chapterHeader.innerHTML = `
                    <div>
                        <div class="chapter-title">ğŸ“š ${chapter.title}</div>
                        <div class="chapter-info">${chapter.startTime?.toFixed(1) || 0}s - ${chapter.endTime?.toFixed(1) || 0}s</div>
                    </div>
                    <div class="chapter-info">
                        ${chapter.scenes?.length || 0}ê°œ ì”¬
                        <button class="chapter-extract-btn" onclick="extractChapter(${chapter.id}, event)">MP3</button>
                        <button class="chapter-extract-btn" onclick="extractChapterMP4(${chapter.id}, event)" style="background: #2563eb;">MP4</button>
                        <span class="collapse-icon">â–¼</span>
                    </div>
                `;
                
                // ì±•í„° ì ‘ê¸°/í¼ì¹˜ê¸°
                chapterHeader.onclick = function(e) {
                    // MP3 ì¶”ì¶œ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° ë¬´ì‹œ
                    if (e.target.classList.contains('chapter-extract-btn')) {
                        return;
                    }
                    
                    const content = chapterSection.querySelector('.chapter-content');
                    const icon = chapterHeader.querySelector('.collapse-icon');
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.textContent = 'â–¼';
                        chapterSection.classList.remove('collapsed');
                    } else {
                        content.style.display = 'none';
                        icon.textContent = 'â–¶';
                        chapterSection.classList.add('collapsed');
                    }
                };
                
                chapterSection.appendChild(chapterHeader);
                
                // ì±•í„° ë‚´ìš©
                const chapterContent = document.createElement('div');
                chapterContent.className = 'chapter-content';
                
                // ì”¬ë“¤ ì²˜ë¦¬
                chapter.scenes?.forEach((scene, sceneIndex) => {
                    const sceneStartIndex = globalIndex; // ì´ ì”¬ì˜ ì‹œì‘ ì¸ë±ìŠ¤ ì €ì¥
                    
                    const sceneSection = document.createElement('div');
                    sceneSection.className = 'scene-section';
                    sceneSection.dataset.sceneId = scene.id;
                    
                    // ì”¬ í—¤ë”
                    const sceneHeader = document.createElement('div');
                    sceneHeader.className = 'scene-header';
                    sceneHeader.innerHTML = `
                        <div>
                            <div class="scene-title">ğŸ¬ ${scene.title}</div>
                            <div class="scene-info">${scene.startTime?.toFixed(1) || 0}s - ${scene.endTime?.toFixed(1) || 0}s</div>
                        </div>
                        <div class="scene-info">
                            ${scene.sentences?.length || 0}ê°œ ë¬¸ì¥
                            <button class="scene-extract-btn" onclick="extractScene(${scene.id}, event)">MP3</button>
                            <button class="scene-extract-btn" onclick="extractSceneMP4(${scene.id}, event)" style="background: #2563eb;">MP4</button>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                    `;
                    
                    // ì”¬ ì ‘ê¸°/í¼ì¹˜ê¸° ë° ì”¬ìœ¼ë¡œ ì´ë™
                    sceneHeader.onclick = function(e) {
                        // MP3 ì¶”ì¶œ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° ë¬´ì‹œ
                        if (e.target.classList.contains('scene-extract-btn')) {
                            return;
                        }
                        
                        // ì ‘ê¸°/í¼ì¹˜ê¸° ì•„ì´ì½˜ì„ í´ë¦­í•œ ê²½ìš°
                        if (e.target.classList.contains('collapse-icon') || e.target.closest('.collapse-icon')) {
                            const content = sceneSection.querySelector('.scene-content');
                            const icon = sceneHeader.querySelector('.collapse-icon');
                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                icon.textContent = 'â–¼';
                                sceneSection.classList.remove('collapsed');
                            } else {
                                content.style.display = 'none';
                                icon.textContent = 'â–¶';
                                sceneSection.classList.add('collapsed');
                            }
                        } else {
                            // ì”¬ ì œëª©ì„ í´ë¦­í•œ ê²½ìš° - í•´ë‹¹ ì”¬ìœ¼ë¡œ ì´ë™
                            jumpToScene(scene, sceneStartIndex);
                        }
                    };
                    
                    sceneSection.appendChild(sceneHeader);
                    
                    // ì”¬ ë‚´ìš© (ë¬¸ì¥ë“¤)
                    const sceneContent = document.createElement('div');
                    sceneContent.className = 'scene-content';
                    
                    scene.sentences?.forEach((sentence, sentenceIndex) => {
                        // ë¬¸ì¥ ë°ì´í„° ì •ê·œí™” (startTime/endTime í•„ë“œ í†µì¼)
                        const normalizedSentence = {
                            ...sentence,
                            startTime: sentence.startTime || sentence.start_time || 0,
                            endTime: sentence.endTime || sentence.end_time || 0
                        };
                        
                        // ì „ì—­ sentences ë°°ì—´ì— ì¶”ê°€
                        sentences.push(normalizedSentence);
                        
                        const sentenceEl = document.createElement('div');
                        sentenceEl.className = 'sentence-item' + (sentence.bookmark ? ' bookmarked' : '');
                        sentenceEl.dataset.index = globalIndex;
                        sentenceEl.dataset.sentenceId = sentence.id;
                        
                        sentenceEl.innerHTML = `
                            <span class="sentence-number">${sentence.order}.</span>
                            <span class="sentence-text">${formatSpeakerText(sentence.english, sentence.id)}</span>
                            <span class="sentence-korean">${formatSpeakerText(sentence.korean || '')}</span>
                            <div style="font-size: 0.7em; color: #666; margin-top: 3px;">
                                ${sentence.startTime?.toFixed(1) || 0}s - ${sentence.endTime?.toFixed(1) || 0}s
                            </div>
                            <button class="bookmark-btn" onclick="toggleBookmark(${globalIndex}, event)">â˜…</button>
                            <button class="extract-btn" onclick="extractMP3(${globalIndex}, event)">MP3</button>
                            <button class="extract-btn" onclick="extractMP4(${globalIndex}, event)" style="background: #2563eb;">MP4</button>
                        `;

                        sentenceEl.onclick = (function(index, sentenceData) {
                            return function(e) {
                                if (!e.target.classList.contains('bookmark-btn') && 
                                    !e.target.classList.contains('extract-btn')) {
                                    console.log('Sentence clicked:', index, sentenceData.english);
                                    playSentence(index);
                                }
                            };
                        })(globalIndex, normalizedSentence);
                        
                        // í˜¸ë²„ íš¨ê³¼ ê°œì„ 
                        sentenceEl.addEventListener('mouseenter', function() {
                            this.style.cursor = 'pointer';
                        });

                        sceneContent.appendChild(sentenceEl);
                        globalIndex++;
                    });
                    
                    sceneSection.appendChild(sceneContent);
                    chapterContent.appendChild(sceneSection);
                });
                
                chapterSection.appendChild(chapterContent);
                listEl.appendChild(chapterSection);
            });

            console.log(`Loaded ${sentences.length} sentences`);
            updateBookmarkedList();
        }
        
        function displaySentences() {
            const listEl = document.getElementById('sentenceList');
            listEl.innerHTML = '';
            
            sentences.forEach((sentence, index) => {
                const el = document.createElement('div');
                el.className = 'sentence-item' + (sentence.bookmark ? ' bookmarked' : '');
                el.dataset.index = index;
                
                el.innerHTML = `
                    <span class="sentence-number">${sentence.id || sentence.order}.</span>
                    <span class="sentence-text">${sentence.english}</span>
                    <span class="sentence-korean">${sentence.korean || ''}</span>
                    <div style="font-size: 0.7em; color: #666; margin-top: 3px;">
                        ${sentence.chapter_title || ''} > ${sentence.scene_title || ''} 
                        (${sentence.startTime?.toFixed(1) || 0}s - ${sentence.endTime?.toFixed(1) || 0}s)
                    </div>
                    <button class="bookmark-btn" onclick="toggleBookmark(${index}, event)">â˜…</button>
                    <button class="extract-btn" onclick="extractMP3(${index}, event)">MP3</button>
                    <button class="extract-btn" onclick="extractMP4(${index}, event)" style="background: #2563eb;">MP4</button>
                `;
                
                el.onclick = function(e) {
                    if (!e.target.classList.contains('bookmark-btn') && 
                        !e.target.classList.contains('extract-btn')) {
                        playSentence(index);
                    }
                };
                
                listEl.appendChild(el);
            });
            
            updateBookmarkedList();
        }
        
        function playSentence(index) {
            const sentence = sentences[index];
            console.log('playSentence called:', index, sentence);
            
            if (currentPlayer && sentence) {
                const startTime = sentence.startTime || sentence.start_time || 0;
                
                console.log('Playing sequentially from sentence:', index, 'start time:', startTime);
                
                // HTML5 í”Œë ˆì´ì–´ (ë¹„ë””ì˜¤/ì˜¤ë””ì˜¤ ê³µí†µ)
                currentPlayer.currentTime = startTime;
                currentPlayer.play().then(() => {
                    console.log('Media started playing sequentially from sentence', index);
                }).catch(error => {
                    console.error('Media play error:', error);
                });
                
                currentSentenceIndex = index;
                
                // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë¬¸ì¥ ê°•ì¡° ë° ìŠ¤í¬ë¡¤
                updateSidebarHighlight(index);
            } else {
                console.error('Cannot play:', {currentPlayer, sentence});
            }
        }
        
        function jumpToScene(scene, startingIndex) {
            console.log('jumpToScene called:', scene.title, startingIndex);
            
            if (!scene.sentences || scene.sentences.length === 0) {
                console.log('No sentences in scene');
                return;
            }
            
            // í•´ë‹¹ ì”¬ì˜ ì²« ë²ˆì§¸ ë¬¸ì¥ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            const firstSentenceEl = document.querySelector(`[data-index="${startingIndex}"]`);
            if (firstSentenceEl) {
                firstSentenceEl.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // ì ì‹œ ê°•ì¡° í‘œì‹œ
                firstSentenceEl.classList.add('highlighted');
                setTimeout(() => {
                    firstSentenceEl.classList.remove('highlighted');
                }, 2000);
            }
            
            // ì”¬ì˜ ì²« ë²ˆì§¸ ë¬¸ì¥ ì¬ìƒ
            if (currentPlayer && scene.sentences[0]) {
                const firstSentence = scene.sentences[0];
                const startTime = firstSentence.startTime || firstSentence.start_time || 0;
                
                currentPlayer.currentTime = startTime;
                console.log(`Jumped to scene "${scene.title}" at ${startTime}s`);
            }
        }
        
        // MP3 ì¶”ì¶œ ê¸°ëŠ¥ë“¤
        function extractChapter(chapterId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting chapter:', chapterId);
            updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/chapter/${chapterId}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì±•í„° MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractScene(sceneId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting scene:', sceneId);
            updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/scene/${sceneId}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì”¬ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractChapterMP4(chapterId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting chapter MP4:', chapterId);
            updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/chapter/${chapterId}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì±•í„° MP4 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractSceneMP4(sceneId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting scene MP4:', sceneId);
            updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/scene/${sceneId}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì”¬ MP4 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllChapters() {
            if (!currentMedia) return;
            
            console.log('Extracting all chapters');
            updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-chapters`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllScenes() {
            if (!currentMedia) return;
            
            console.log('Extracting all scenes');
            updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-scenes`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractBookmarkedOnly() {
            if (!currentMedia) return;
            
            console.log('Extracting bookmarked sentences');
            updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-bookmarked`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        // MP4 ì¶”ì¶œ í•¨ìˆ˜ë“¤
        function extractAllMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all sentences as MP4');
            updateExtractStatusMP4('ëª¨ë“  ë¬¸ì¥ MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract_all_mp4`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateExtractStatusMP4(`âœ… ${data.message || 'ëª¨ë“  ë¬¸ì¥ MP4 ì¶”ì¶œ ì™„ë£Œ'}`);
                    } else {
                        updateExtractStatusMP4(`âŒ ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Extract all MP4 error:', error);
                    updateExtractStatusMP4('âŒ MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
        
        function extractAllChaptersMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all chapters as MP4');
            updateExtractStatusMP4('ëª¨ë“  ì±•í„° MP4 ì¶”ì¶œ ì¤‘...');
            
            // ê° ì±•í„°ë³„ë¡œ ìˆœì°¨ ì²˜ë¦¬
            fetch(`/api/media/${currentMedia}/chapters`)
            .then(response => response.json())
            .then(chapters => {
                if (chapters.length === 0) {
                    updateExtractStatusMP4('ì¶”ì¶œí•  ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                Promise.all(chapters.map(chapter => 
                    fetch(`/api/media/${currentMedia}/chapter/${chapter.id}/extract-mp4`, {
                        method: 'POST'
                    }).then(response => response.json())
                )).then(results => {
                    const successCount = results.filter(r => r.success).length;
                    updateExtractStatusMP4(`ì±•í„° MP4 ì¶”ì¶œ ì™„ë£Œ: ${successCount}/${chapters.length}ê°œ`);
                }).catch(error => {
                    console.error('Extract error:', error);
                    updateExtractStatusMP4('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                });
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllScenesMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all scenes as MP4');
            updateExtractStatusMP4('ëª¨ë“  ì”¬ MP4 ì¶”ì¶œ ì¤‘...');
            
            // ê° ì”¬ë³„ë¡œ ìˆœì°¨ ì²˜ë¦¬ - êµ¬í˜„ í•„ìš”ì‹œ ì¶”ê°€
            updateExtractStatusMP4('ì”¬ MP4 ì¶”ì¶œ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘...');
        }
        
        function extractBookmarkedOnlyMP4() {
            if (!currentMedia) return;
            
            const englishChecked = document.getElementById('bookmarkSubtitleEnglish').checked;
            const koreanChecked = document.getElementById('bookmarkSubtitleKorean').checked;
            
            console.log('Extracting bookmarked sentences as MP4', {englishChecked, koreanChecked});
            updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-bookmarked-mp4`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subtitle_english: englishChecked,
                    subtitle_korean: koreanChecked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatusMP4(`ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                } else {
                    updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllSentencesMP4() {
            if (!currentMedia) return;
            
            const englishChecked = document.getElementById('subtitleEnglish').checked;
            const koreanChecked = document.getElementById('subtitleKorean').checked;
            
            console.log('Extracting all sentences as MP4', {englishChecked, koreanChecked});
            updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-sentences-mp4`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    subtitle_english: englishChecked,
                    subtitle_korean: koreanChecked
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatusMP4(`ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                } else {
                    updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function updateExtractStatusMP4(message, progress = null) {
            const statusEl = document.getElementById('extractStatusMP4');
            if (statusEl) {
                statusEl.innerHTML = message;
                
                // ì§„í–‰ë¥  ë°” í‘œì‹œ
                if (progress !== null) {
                    const progressBar = `
                        <div style="width: 100%; background-color: #333; border-radius: 5px; margin-top: 5px;">
                            <div style="width: ${progress}%; background-color: #007acc; height: 5px; border-radius: 5px;"></div>
                        </div>
                    `;
                    statusEl.innerHTML += progressBar;
                }
            }
        }
        
        function updateExtractStatus(message, progress = null) {
            const statusEl = document.getElementById('extractStatus');
            if (statusEl) {
                statusEl.innerHTML = message;
                
                // ì§„í–‰ë¥  ë°” í‘œì‹œ
                if (progress !== null) {
                    let progressBar = statusEl.querySelector('.progress-bar');
                    if (!progressBar && progress >= 0) {
                        progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        const progressFill = document.createElement('div');
                        progressFill.className = 'progress-fill';
                        progressBar.appendChild(progressFill);
                        statusEl.appendChild(progressBar);
                    }
                    
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-fill');
                        if (progressFill) {
                            progressFill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
                        }
                        
                        // ì™„ë£Œì‹œ ì§„í–‰ë¥  ë°” ì œê±°
                        if (progress >= 100) {
                            setTimeout(() => {
                                if (progressBar) progressBar.remove();
                            }, 1000);
                        }
                    }
                }
            }
        }
        
        function simulateProgress(statusMessage, duration = 3000) {
            let progress = 0;
            const interval = 100;
            const increment = (100 / duration) * interval;
            
            const progressInterval = setInterval(() => {
                progress += increment;
                updateExtractStatus(statusMessage, progress);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, interval);
            
            return progressInterval;
        }
        
        // VAD í•„í„° ê¸°ëŠ¥
        let vadFilterData = null;
        
        function toggleVADFilter() {
            const vadFilter = document.getElementById('vadFilter');
            const vadDetails = document.getElementById('vadDetails');
            
            if (vadFilter.checked) {
                vadDetails.style.display = 'block';
                console.log('VAD filter enabled');
            } else {
                vadDetails.style.display = 'none';
                console.log('VAD filter disabled');
                vadFilterData = null;
                // ì›ë³¸ ë¬¸ì¥ í‘œì‹œë¡œ ë³µì›
                if (currentMedia) {
                    loadGroupedSentences(currentMedia);
                }
            }
        }
        
        function updateVADThreshold() {
            const threshold = document.getElementById('vadThreshold').value;
            document.getElementById('vadThresholdValue').textContent = threshold;
        }
        
        function applyVADFilter() {
            if (!currentMedia) return;
            
            const threshold = parseFloat(document.getElementById('vadThreshold').value);
            updateVADStatus('VAD í•„í„° ë¶„ì„ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/vad-filter`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold: threshold})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    vadFilterData = data;
                    updateVADStatus(`ë¶„ì„ ì™„ë£Œ: ìŒì„± ${data.voice_sentences}ê°œ, ë¬´ìŒ ${data.silence_sentences}ê°œ`);
                    console.log('VAD filter applied:', data);
                    
                    // ë¬¸ì¥ í‘œì‹œ ì—…ë°ì´íŠ¸ (VAD ê²°ê³¼ ë°˜ì˜)
                    applyVADVisualization();
                } else {
                    updateVADStatus('VAD í•„í„° ì ìš© ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('VAD filter error:', error);
                updateVADStatus('VAD í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function createVADAudio() {
            if (!currentMedia) return;
            
            updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/create-vad-audio`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateVADStatus(`ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('VAD audio creation error:', error);
                updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function updateVADStatus(message) {
            const statusEl = document.getElementById('vadStatus');
            if (statusEl) {
                statusEl.innerHTML = message;
            }
        }
        
        // ë²ˆì—­ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function checkTranslationStatus() {
            if (!currentMedia) return;
            
            fetch(`/api/media/${currentMedia}/translation-status`)
                .then(response => response.json())
                .then(data => {
                    const infoEl = document.getElementById('translationInfo');
                    const btnEl = document.getElementById('translateBtn');
                    
                    if (data.total === 0) {
                        infoEl.innerHTML = 'ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                        btnEl.disabled = true;
                        return;
                    }
                    
                    const percentage = Math.round((data.translated / data.total) * 100);
                    infoEl.innerHTML = `
                        <div>ì „ì²´: ${data.total}ê°œ ë¬¸ì¥</div>
                        <div>ë²ˆì—­ë¨: ${data.translated}ê°œ (${percentage}%)</div>
                        <div>ë¯¸ë²ˆì—­: ${data.untranslated}ê°œ</div>
                    `;
                    
                    if (data.untranslated === 0) {
                        btnEl.textContent = 'âœ… ë²ˆì—­ ì™„ë£Œ';
                        btnEl.disabled = true;
                    } else if (data.status === 'translating') {
                        btnEl.textContent = 'ğŸ”„ ë²ˆì—­ ì¤‘...';
                        btnEl.disabled = true;
                        document.getElementById('translationStatus').style.display = 'block';
                        document.getElementById('translationStatus').innerHTML = data.current || 'ë²ˆì—­ ì§„í–‰ ì¤‘...';
                    } else {
                        btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
                        btnEl.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Translation status error:', error);
                });
        }
        
        function startTranslation() {
            if (!currentMedia) return;
            
            const btnEl = document.getElementById('translateBtn');
            const statusEl = document.getElementById('translationStatus');
            
            btnEl.disabled = true;
            btnEl.textContent = 'ğŸ”„ ë²ˆì—­ ì‹œì‘ ì¤‘...';
            statusEl.style.display = 'block';
            statusEl.innerHTML = 'ë²ˆì—­ì„ ì‹œì‘í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
            
            fetch(`/api/media/${currentMedia}/translate`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    
                    // ë²ˆì—­ ì§„í–‰ ìƒíƒœ ëª¨ë‹ˆí„°ë§
                    translationInterval = setInterval(checkTranslationProgress, 2000);
                    
                    // ë¬¸ì¥ ë‹¤ì‹œ ë¡œë“œ
                    setTimeout(() => {
                        loadGroupedSentences(currentMedia);
                    }, 1000);
                } else {
                    statusEl.innerHTML = `âŒ ë²ˆì—­ ì‹¤íŒ¨: ${data.error}`;
                    btnEl.disabled = false;
                    btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
                }
            })
            .catch(error => {
                console.error('Translation error:', error);
                statusEl.innerHTML = 'âŒ ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                btnEl.disabled = false;
                btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
            });
        }
        
        function checkTranslationProgress() {
            if (!currentMedia) {
                clearInterval(translationInterval);
                return;
            }
            
            fetch(`/api/media/${currentMedia}/translation-status`)
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('translationStatus');
                    
                    if (data.status === 'translating' && data.current) {
                        statusEl.innerHTML = data.current;
                    } else if (data.untranslated === 0) {
                        clearInterval(translationInterval);
                        statusEl.innerHTML = 'âœ… ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        checkTranslationStatus();
                        
                        // ë¬¸ì¥ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë²ˆì—­ í‘œì‹œ
                        loadGroupedSentences(currentMedia);
                    }
                })
                .catch(error => {
                    console.error('Progress check error:', error);
                    clearInterval(translationInterval);
                });
        }
        
        function applyVADVisualization() {
            if (!vadFilterData) return;
            
            // ë¬¸ì¥ ìš”ì†Œë“¤ì— VAD ê²°ê³¼ ì‹œê°í™”
            document.querySelectorAll('.sentence-item').forEach(sentenceEl => {
                const index = parseInt(sentenceEl.dataset.index);
                const sentence = sentences[index];
                
                if (sentence && sentence.vad_ratio !== undefined) {
                    if (sentence.vad_filtered) {
                        // ìŒì„± êµ¬ê°„ - ê°•ì¡° í‘œì‹œ
                        sentenceEl.style.borderLeft = '3px solid #4CAF50';
                        sentenceEl.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                    } else {
                        // ë¬´ìŒ êµ¬ê°„ - íë¦¬ê²Œ í‘œì‹œ
                        sentenceEl.style.borderLeft = '3px solid #757575';
                        sentenceEl.style.backgroundColor = 'rgba(117, 117, 117, 0.1)';
                        sentenceEl.style.opacity = '0.6';
                    }
                    
                    // VAD ë¹„ìœ¨ í‘œì‹œ
                    const vadInfo = document.createElement('div');
                    vadInfo.className = 'vad-info';
                    vadInfo.style.fontSize = '0.7em';
                    vadInfo.style.color = sentence.vad_filtered ? '#4CAF50' : '#757575';
                    vadInfo.textContent = `ìŒì„±: ${(sentence.vad_ratio * 100).toFixed(0)}%`;
                    sentenceEl.appendChild(vadInfo);
                }
            });
        }
        
        function toggleBookmark(index, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            const sentence = sentences[index];
            console.log('toggleBookmark called:', index, sentence);
            
            if (!sentence || !sentence.id) {
                console.error('No sentence ID found:', sentence);
                return;
            }
            
            fetch(`/api/media/${currentMedia}/sentences/${sentence.id}/bookmark`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sentences[index].bookmark = data.bookmark ? 1 : 0;
                    
                    // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                    const sentenceEl = document.querySelector(`[data-index="${index}"]`);
                    if (sentenceEl) {
                        if (data.bookmark) {
                            sentenceEl.classList.add('bookmarked');
                        } else {
                            sentenceEl.classList.remove('bookmarked');
                        }
                    }
                    
                    updateBookmarkedList();
                }
            })
            .catch(error => {
                console.error('Bookmark toggle error:', error);
            });
        }
        
        function updateBookmarkedList() {
            const bookmarkedEl = document.getElementById('bookmarkedList');
            const bookmarked = sentences.filter(s => s.bookmark);
            
            if (bookmarked.length === 0) {
                bookmarkedEl.innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                bookmarkedEl.innerHTML = bookmarked.map(s => 
                    `<div class="bookmarked-item">${s.id}. ${s.english}</div>`
                ).join('');
            }
        }
        
        function repeatCurrent() {
            if (currentSentenceIndex >= 0) {
                playSentence(currentSentenceIndex);
            }
        }
        
        function playBookmarked() {
            const bookmarked = sentences.filter(s => s.bookmark);
            if (bookmarked.length > 0) {
                let index = 0;
                
                function playNext() {
                    if (index < bookmarked.length) {
                        const sentenceIndex = sentences.findIndex(s => s.id === bookmarked[index].id);
                        playSentence(sentenceIndex);
                        index++;
                        setTimeout(playNext, 3000); // 3ì´ˆ ê°„ê²©
                    }
                }
                
                playNext();
            }
        }
        
        function extractMP3(index, event) {
            event.stopPropagation();
            const sentence = sentences[index];
            
            if (!currentMedia || !sentence.id) {
                const btn = event.target;
                btn.textContent = 'âŒ ì˜¤ë¥˜';
                btn.style.background = '#ff4444';
                setTimeout(() => {
                    btn.textContent = 'MP3';
                    btn.style.background = '#0e639c';
                }, 2000);
                return;
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ì¶”ì¶œì¤‘...';
            btn.disabled = true;
            
            fetch(`/api/sentence/${currentMedia}/${sentence.id}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                    const a = document.createElement('a');
                    a.href = data.download_url;
                    a.download = data.filename;
                    a.click();
                    
                    console.log(`MP3 ì¶”ì¶œ ì™„ë£Œ: ${data.filename}`);
                } else {
                    console.error('MP3 ì¶”ì¶œ ì‹¤íŒ¨:', data.error);
                }
            })
            .catch(error => {
                console.error('MP3 ì¶”ì¶œ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
        
        function extractMP4(index, event) {
            event.stopPropagation();
            const sentence = sentences[index];
            
            if (!currentMedia || !sentence.id) {
                const btn = event.target;
                btn.textContent = 'âŒ ì˜¤ë¥˜';
                btn.style.background = '#ff4444';
                setTimeout(() => {
                    btn.textContent = 'MP4';
                    btn.style.background = '#2563eb';
                }, 2000);
                return;
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ì¶”ì¶œì¤‘...';
            btn.disabled = true;
            
            fetch(`/api/sentence/${currentMedia}/${sentence.id}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                    btn.textContent = 'âœ… ì™„ë£Œ';
                    btn.style.background = '#4caf50';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#2563eb';
                    }, 3000);
                } else {
                    console.error('MP4 ì¶”ì¶œ ì‹¤íŒ¨:', data.error);
                    btn.textContent = 'âŒ ì‹¤íŒ¨';
                    btn.style.background = '#ff4444';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '#2563eb';
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('MP4 ì¶”ì¶œ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
        
        function exportBookmarks() {
            const bookmarked = sentences.filter(s => s.bookmark);
            if (bookmarked.length === 0) {
                // ë²„íŠ¼ì— í”¼ë“œë°± í‘œì‹œ
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âŒ ë¶ë§ˆí¬ ì—†ìŒ';
                btn.style.background = '#ff4444';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#d79921';
                }, 2000);
                return;
            }
            
            const content = bookmarked.map(s => `${s.id}. ${s.english}\n${s.korean}`).join('\n\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bookmarked_sentences.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        let searchTimeout = null;
        
        function handleSearchInput(event) {
            const query = event.target.value.trim();
            const resultsEl = document.getElementById('searchResults');
            
            // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (query.length < 3) {
                resultsEl.innerHTML = '';
                showAllSentences();
                return;
            }
            
            // 300ms ì§€ì—° í›„ ê²€ìƒ‰ ì‹¤í–‰
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }
        
        function performSearch(query) {
            const resultsEl = document.getElementById('searchResults');
            
            if (!sentences || sentences.length === 0) {
                resultsEl.innerHTML = 'ê²€ìƒ‰í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ì˜ì–´ì™€ í•œêµ­ì–´ì—ì„œ ê²€ìƒ‰
            const matches = sentences.filter(sentence => {
                const englishMatch = sentence.english && sentence.english.toLowerCase().includes(query.toLowerCase());
                const koreanMatch = sentence.korean && sentence.korean.includes(query);
                return englishMatch || koreanMatch;
            });
            
            if (matches.length === 0) {
                resultsEl.innerHTML = `"${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                hideAllSentences();
                return;
            }
            
            resultsEl.innerHTML = `${matches.length}ê°œ ë¬¸ì¥ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            // ë§¤ì¹­ëœ ë¬¸ì¥ë§Œ í‘œì‹œ
            highlightSearchResults(matches, query);
        }
        
        function highlightSearchResults(matches, query) {
            // ëª¨ë“  ë¬¸ì¥ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.style.display = 'none';
            });
            
            // ë§¤ì¹­ëœ ë¬¸ì¥ë§Œ í‘œì‹œí•˜ê³  í•˜ì´ë¼ì´íŠ¸
            matches.forEach(match => {
                const sentenceEl = document.querySelector(`[data-sentence-id="${match.id}"]`);
                if (sentenceEl) {
                    sentenceEl.style.display = 'block';
                    
                    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
                    const englishEl = sentenceEl.querySelector('.sentence-text');
                    const koreanEl = sentenceEl.querySelector('.sentence-korean');
                    
                    if (englishEl) {
                        const highlightedEnglish = highlightText(match.english, query);
                        englishEl.innerHTML = highlightedEnglish;
                    }
                    
                    if (koreanEl && match.korean) {
                        const highlightedKorean = highlightText(match.korean, query);
                        koreanEl.innerHTML = highlightedKorean;
                    }
                    
                    // ë¶€ëª¨ ì±•í„°/ì”¬ë„ í‘œì‹œ
                    let parent = sentenceEl.closest('.scene-section');
                    while (parent) {
                        parent.style.display = 'block';
                        const content = parent.querySelector('.scene-content, .chapter-content');
                        if (content) content.style.display = 'block';
                        parent = parent.closest('.chapter-section');
                    }
                }
            });
        }
        
        function highlightText(text, query) {
            if (!text || !query) return text;
            
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffd700; color: #000;">$1</mark>');
        }
        
        function showAllSentences() {
            document.querySelectorAll('.sentence-item, .scene-section, .chapter-section').forEach(item => {
                item.style.display = 'block';
            });
            
            // ì›ë³¸ í…ìŠ¤íŠ¸ ë³µì›
            sentences.forEach(sentence => {
                const sentenceEl = document.querySelector(`[data-sentence-id="${sentence.id}"]`);
                if (sentenceEl) {
                    const englishEl = sentenceEl.querySelector('.sentence-text');
                    const koreanEl = sentenceEl.querySelector('.sentence-korean');
                    
                    if (englishEl) englishEl.innerHTML = sentence.english;
                    if (koreanEl) koreanEl.innerHTML = sentence.korean || '';
                }
            });
        }
        
        function hideAllSentences() {
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.style.display = 'none';
            });
        }
        
        function deleteMedia(mediaId, event) {
            event.stopPropagation();
            
            if (!confirm('ì •ë§ë¡œ ì´ ë¯¸ë””ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë¬¸ì¥ê³¼ ë¶ë§ˆí¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }
            
            fetch(`/api/media/${mediaId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ì¸ ê²½ìš° ì´ˆê¸°í™”
                    if (currentMedia === mediaId) {
                        currentMedia = null;
                        document.querySelector('.media-player').style.display = 'none';
                        document.getElementById('sentenceList').innerHTML = '';
                        document.getElementById('bookmarkedList').innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        document.getElementById('processingOptions').style.display = 'none';
                        document.getElementById('searchSection').style.display = 'none';
                                    document.getElementById('uploadSection').style.display = 'block';
                    }
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                    
                    console.log('Media deleted successfully');
                } else {
                    console.error('ì‚­ì œ ì‹¤íŒ¨:', data.error);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
            });
        }
    </script>
    
    <!-- Video.js JavaScript -->
</body>
</html>