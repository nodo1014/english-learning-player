<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ í•™ìŠµ í”Œë ˆì´ì–´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #cccccc;
            display: flex;
            height: 100vh;
        }
        
        /* VSCode style layout */
        .sidebar {
            width: 48px;
            background: #333333;
            border-right: 1px solid #444444;
        }
        
        .media-list {
            width: 250px;
            background: #252526;
            border-right: 1px solid #444444;
            padding: 10px;
        }
        
        .main-content {
            flex: 1;
            background: #1e1e1e;
            padding: 20px;
            overflow-y: auto;
        }
        
        .right-bar {
            width: 300px;
            background: #252526;
            border-left: 1px solid #444444;
            padding: 20px;
        }
        
        /* Media player */
        .media-player {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
        }
        
        /* Sentences */
        .chapter-section {
            margin: 20px 0;
            border: 1px solid #444444;
            border-radius: 5px;
            background: #252526;
        }
        
        .chapter-header {
            background: #333333;
            padding: 15px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .chapter-header:hover {
            background: #404040;
        }
        
        .chapter-title {
            font-weight: bold;
            color: #cccccc;
        }
        
        .chapter-info {
            font-size: 0.9em;
            color: #858585;
        }
        
        .chapter-content {
            padding: 10px;
        }
        
        .scene-section {
            margin: 15px 0;
            border: 1px solid #555555;
            border-radius: 3px;
            background: #2d2d30;
        }
        
        .scene-header {
            background: #404040;
            padding: 10px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        
        .scene-header:hover {
            background: #4a4a4a;
        }
        
        .scene-title {
            font-weight: bold;
            color: #cccccc;
            font-size: 0.9em;
        }
        
        .scene-info {
            font-size: 0.8em;
            color: #858585;
        }
        
        .scene-content {
            padding: 10px;
        }
        
        .sentence-item {
            background: #1e1e1e;
            padding: 12px;
            margin: 8px 0;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }
        
        .sentence-item:hover {
            background: #2d2d30;
        }
        
        .sentence-item.bookmarked {
            background: #4e4e2a;
            border-left: 3px solid #ffd700;
        }
        
        .sentence-item.playing {
            background: #2d4a2d;
            border-left: 3px solid #4CAF50;
        }
        
        .collapse-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .sentence-number {
            color: #858585;
            margin-right: 10px;
        }
        
        .sentence-text {
            color: #cccccc;
            line-height: 1.5;
            display: inline;
        }
        
        .sentence-korean {
            color: #858585;
            font-size: 0.9em;
            margin-left: 10px;
            display: inline;
        }
        
        .bookmark-btn {
            position: absolute;
            right: 60px;
            top: 15px;
            background: none;
            border: none;
            color: #858585;
            font-size: 20px;
            cursor: pointer;
        }
        
        .sentence-item.bookmarked .bookmark-btn {
            color: #ffd700;
        }
        
        .extract-btn {
            position: absolute;
            right: 15px;
            top: 15px;
            background: #0e639c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .extract-btn:hover {
            background: #1177bb;
        }
        
        /* Scene navigation highlight */
        .sentence-item.highlighted {
            background: rgba(14, 99, 156, 0.3);
            border: 2px solid #0e639c;
            animation: pulse 0.5s ease-in-out;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .scene-header {
            cursor: pointer;
        }
        
        .scene-title:hover {
            color: #0e639c;
        }
        
        /* Right sidebar panels */
        .extract-panel, .filter-panel, .bookmarked-panel {
            margin-bottom: 25px;
            padding: 15px;
            background: #2d2d30;
            border-radius: 5px;
            border: 1px solid #444444;
        }
        
        .extract-panel h3, .filter-panel h3, .bookmarked-panel h3 {
            margin-bottom: 15px;
            color: #cccccc;
            font-size: 1em;
            border-bottom: 1px solid #444444;
            padding-bottom: 8px;
        }
        
        .extract-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .extract-option-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s;
            text-align: left;
        }
        
        .extract-option-btn:hover {
            background: #1177bb;
        }
        
        .extract-option-btn:disabled {
            background: #555555;
            cursor: not-allowed;
        }
        
        .extract-status {
            margin-top: 10px;
            padding: 8px;
            background: #1e1e1e;
            border-radius: 3px;
            font-size: 0.8em;
            color: #858585;
            min-height: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #333333;
            border-radius: 2px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0e639c, #1177bb);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .vad-info {
            font-size: 0.7em !important;
            margin-top: 2px;
            padding: 2px 4px;
            border-radius: 2px;
            display: inline-block;
        }
        
        .filter-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #cccccc;
            cursor: pointer;
        }
        
        .filter-details {
            margin-top: 8px;
            padding: 8px;
            background: #1e1e1e;
            border-radius: 3px;
            color: #858585;
        }
        
        /* Chapter and Scene header extract buttons */
        .chapter-extract-btn, .scene-extract-btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .chapter-extract-btn:hover, .scene-extract-btn:hover {
            background: #1177bb;
        }
        
        /* Controls */
        .controls {
            margin: 20px 0;
        }
        
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #1177bb;
        }
        
        .btn-export {
            background: #d79921;
        }
        
        .btn-export:hover {
            background: #fabd2f;
        }
        
        /* Upload area */
        .upload-area {
            border: 2px dashed #444444;
            border-radius: 5px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s, background-color 0.3s;
        }
        
        .upload-area.drag-over {
            border-color: #0e639c;
            background: rgba(14, 99, 156, 0.1);
        }
        
        .upload-area input[type="file"] {
            margin-top: 10px;
            width: 100%;
            padding: 10px;
            border: 1px solid #444444;
            background: #2d2d30;
            color: #cccccc;
            border-radius: 3px;
        }
        
        .media-item {
            padding: 8px 30px 8px 8px; /* ì˜¤ë¥¸ìª½ì— ì‚­ì œ ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            margin: 5px 0;
            background: #2d2d30;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            word-wrap: break-word;
            word-break: break-word;
        }
        
        .media-item:hover {
            background: #37373d;
        }
        
        .media-item.active {
            background: #0e639c;
        }
        
        .chapter-item {
            margin: 5px 0;
            padding: 5px;
            background: #37373d;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .scene-item {
            margin: 2px 0 2px 15px;
            padding: 3px;
            background: #2d2d30;
            border-radius: 2px;
            font-size: 0.8em;
            color: #858585;
        }
        
        /* Bookmarked list */
        .bookmarked-panel {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
        }
        
        .bookmarked-panel h3 {
            margin-bottom: 15px;
            color: #cccccc;
        }
        
        .bookmarked-item {
            padding: 8px;
            margin: 5px 0;
            background: #1e1e1e;
            border-radius: 3px;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: #2d2d30;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #444444;
            border-radius: 5px;
            width: 400px;
            max-width: 90%;
            color: #cccccc;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444444;
            padding-bottom: 10px;
        }
        
        .modal-close {
            color: #858585;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: #cccccc;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-form label {
            color: #cccccc;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .modal-form select, .modal-form input {
            width: 100%;
            padding: 8px;
            border: 1px solid #444444;
            background: #1e1e1e;
            color: #cccccc;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .modal-form button {
            width: 100%;
            padding: 12px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        
        .modal-form button:hover {
            background: #1177bb;
        }
        
        .modal-form button.srt-btn {
            background: #4caf50;
        }
        
        .modal-form button.srt-btn:hover {
            background: #66bb6a;
        }
        
        .extract-option-btn.delete-btn {
            background: #d32f2f;
        }
        
        .extract-option-btn.delete-btn:hover {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="sidebar"></div>
    
    <div class="media-list">
        <h3>ë¯¸ë””ì–´ ëª©ë¡</h3>
        <button onclick="showUploadSection()" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #0e639c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
            â• ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
        </button>
        <div id="mediaList"></div>
        
        <div id="chapterList" style="margin-top: 20px; display: none;">
            <h4>ì±•í„°/ì”¬ êµ¬ì¡°</h4>
            <div id="chapterContent"></div>
        </div>
    </div>
    
    <main class="main-content">
        <div id="uploadSection" class="upload-area">
            <h3>ğŸ“ ë¯¸ë””ì–´ íŒŒì¼ ì—…ë¡œë“œ</h3>
            
            <div style="margin-bottom: 15px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 1.2em; color: #cccccc; margin-bottom: 10px;">
                        ğŸ“ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                    </div>
                    <input type="file" id="fileInput" accept="audio/mp3,audio/mpeg,audio/wav,audio/mp4,audio/m4a,audio/ogg,video/mp4,video/avi,video/mov,video/mkv,video/webm,video/x-flv">
                </div>
                <div style="font-size: 0.8em; color: #858585; text-align: center;">
                    <div><strong>ğŸµ ì˜¤ë””ì˜¤:</strong> MP3, WAV, M4A, OGG</div>
                    <div><strong>ğŸ¬ ì˜ìƒ:</strong> MP4, AVI, MOV, MKV, WebM, FLV</div>
                    <div style="margin-top: 5px; color: #606060;">â€» ì˜ìƒ íŒŒì¼ì€ ìë™ìœ¼ë¡œ ì˜¤ë””ì˜¤ê°€ ì¶”ì¶œë©ë‹ˆë‹¤</div>
                    <div style="margin-top: 5px; color: #606060;">â€» íŒŒì¼ í¬ê¸° ì œí•œ ì—†ìŒ</div>
                </div>
            </div>
            
            <div id="uploadStatus" style="margin-top: 10px; color: #858585;"></div>
            
            <!-- ì²˜ë¦¬ ì˜µì…˜ (ì—…ë¡œë“œ í›„ í‘œì‹œ) -->
            <div id="processingOptions" style="display: none; margin-top: 20px; padding: 15px; background: #2d2d30; border-radius: 5px;">
                <h4 style="color: #cccccc; margin-bottom: 15px;">ğŸ“ ë¬¸ì¥ ìƒì„± ë°©ë²• ì„ íƒ</h4>
                
                <!-- Whisper ì˜µì…˜ -->
                <div class="processing-option" style="margin-bottom: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px;">
                    <h5 style="color: #cccccc; margin-bottom: 10px;">ğŸ¤ Whisper AIë¡œ ë¬¸ì¥ ìƒì„±</h5>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">ëª¨ë¸ ì„ íƒ:</label>
                        <select id="modelSelect" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                            <option value="tiny">âš¡ Tiny (ë¹ ë¦„, ë‚®ì€ ì •í™•ë„)</option>
                            <option value="small">ğŸ”¹ Small (ë³´í†µ ì†ë„, ë³´í†µ ì •í™•ë„)</option>
                            <option value="medium" selected>ğŸ”¸ Medium (ëŠë¦¼, ë†’ì€ ì •í™•ë„)</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">êµ¬ì¡° í…œí”Œë¦¿:</label>
                        <select id="templateSelect" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                            <option value="auto">ğŸ¤– ìë™ ê°ì§€</option>
                            <option value="toeic_lc" selected>ğŸ“š TOEIC LC (Part 1-4)</option>
                            <option value="toeic_rc">ğŸ“– TOEIC RC (Part 5-7)</option>
                            <option value="general">ğŸ“ ì¼ë°˜ ê°•ì˜</option>
                            <option value="conversation">ğŸ’¬ ëŒ€í™”/ì¸í„°ë·°</option>
                            <option value="audiobook">ğŸ“š ì˜¤ë””ì˜¤ë¶</option>
                            <option value="manual">âš™ï¸ ìˆ˜ë™ ì„¤ì •</option>
                        </select>
                    </div>
                    
                    <button onclick="processWithWhisper()" style="width: 100%; padding: 10px; background: #0e639c; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ¤ Whisperë¡œ ë¬¸ì¥ ìƒì„± ì‹œì‘
                    </button>
                </div>
                
                <!-- ë¬¸ì¥ ì—…ë¡œë“œ ì˜µì…˜ -->
                <div class="processing-option" style="margin-bottom: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px;">
                    <h5 style="color: #cccccc; margin-bottom: 10px;">ğŸ“„ ë¬¸ì¥ ë°ì´í„° ì§ì ‘ ì—…ë¡œë“œ</h5>
                    
                    <div style="margin-bottom: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #cccccc; font-size: 0.9em;">SRT íŒŒì¼ ì—…ë¡œë“œ:</label>
                        <input type="file" id="srtFileInput" accept=".srt" style="width: 100%; padding: 6px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px; font-size: 0.9em;">
                        <div style="font-size: 0.8em; color: #858585; margin-top: 3px;">
                            ìë§‰ íŒŒì¼ (.srt) í˜•ì‹ìœ¼ë¡œ ì‹œê°„ ì •ë³´ì™€ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <button onclick="uploadSentences()" style="width: 100%; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ğŸ“„ SRT íŒŒì¼ë¡œ ë¬¸ì¥ ìƒì„±
                    </button>
                </div>
                
                <div id="processingStatus" style="margin-top: 15px; padding: 10px; background: #1e1e1e; border-radius: 5px; display: none;"></div>
            </div>
        </div>
        

        <div class="media-player" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 id="mediaTitle" style="margin: 0;">ë¯¸ë””ì–´ ì œëª©</h3>
            </div>
            <audio id="audioPlayer" controls preload="auto" style="display:none;">
                ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>
            <video id="videoPlayer" controls preload="auto" style="display:none; width:100%; max-height:400px;">
                ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ íƒœê·¸ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </video>
            
            <!-- ë¹„ë””ì˜¤ ìë§‰ í‘œì‹œ ì˜ì—­ -->
            <div id="videoSubtitles" style="display:none; margin-top: 15px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div id="currentSubtitle" style="flex: 1; font-size: 1.2em; color: #ffffff; line-height: 1.5; padding: 10px 15px; background: #2d2d30; border-radius: 5px; border: 1px solid #444444;">
                    </div>
                    <button id="subtitleBookmarkBtn" onclick="toggleSubtitleBookmark()" style="padding: 8px 12px; background: #333333; color: #cccccc; border: 1px solid #444444; border-radius: 5px; cursor: pointer; font-size: 0.9em; white-space: nowrap;" title="ë¶ë§ˆí¬ ì¶”ê°€/ì œê±°">
                        â˜†
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 0.9em; color: #858585;">
                ë¬¸ì¥ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ¬ê°„ì´ ì¬ìƒë©ë‹ˆë‹¤.
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="repeatCurrent()">êµ¬ê°„ ë°˜ë³µ</button>
            <button class="btn" onclick="playBookmarked()">ë¶ë§ˆí¬ ì¬ìƒ</button>
            <button class="btn btn-export" onclick="exportBookmarks()">ë¶ë§ˆí¬ ë‚´ë³´ë‚´ê¸°</button>
        </div>
        
        <!-- ê²€ìƒ‰ ì„¹ì…˜ (ë¬¸ì¥ ëª©ë¡ ìœ„ì— ìœ„ì¹˜) -->
        <div id="searchSection" class="search-area" style="display:none; margin-bottom: 20px;">
            <h3>ë¬¸ì¥ ê²€ìƒ‰</h3>
            <input type="text" id="searchInput" placeholder="3ê¸€ì ì´ìƒ ì…ë ¥í•˜ë©´ ìë™ ê²€ìƒ‰..." 
                   style="width: 100%; padding: 10px; border: 1px solid #444444; background: #2d2d30; color: #cccccc; border-radius: 3px;">
            <div id="searchResults" style="margin-top: 10px; color: #858585;"></div>
        </div>
        
        <div id="sentenceList"></div>
    </main>
    
    <div class="right-bar">
        <!-- ìë§‰ ìƒì„± ë©”ë‰´ -->
        <div id="subtitleGenerationMenu" class="extract-panel" style="display:none;">
            <h3>ğŸ“ ìë§‰ ìƒì„±</h3>
            <div class="extract-options">
                <button class="extract-option-btn" onclick="showWhisperOptions()">
                    ğŸ¤ Whisper ìƒì„±
                </button>
                <button class="extract-option-btn" onclick="showSrtUpload()">
                    ğŸ“„ SRT ì—…ë¡œë“œ
                </button>
                <button class="extract-option-btn delete-btn" onclick="deleteSubtitles()">
                    ğŸ—‘ï¸ ìë§‰ ì‚­ì œ
                </button>
            </div>
            <div id="generationStatus" class="extract-status" style="display: none;"></div>
        </div>

        <!-- MP3 ì¶”ì¶œ ë©”ë‰´ -->
        <div class="extract-panel">
            <h3>ğŸµ MP3 ì¶”ì¶œ</h3>
            <div class="extract-options">
                <button class="extract-option-btn" onclick="extractAllChapters()">
                    ğŸ“š ì±•í„°ë³„ ì¶”ì¶œ
                </button>
                <button class="extract-option-btn" onclick="extractAllScenes()">
                    ğŸ¬ ì”¬ë³„ ì¶”ì¶œ
                </button>
                <button class="extract-option-btn" onclick="extractBookmarkedOnly()">
                    â­ ë¶ë§ˆí¬ë§Œ ì¶”ì¶œ
                </button>
            </div>
            <div id="extractStatus" class="extract-status"></div>
        </div>

        <!-- MP4 ì¶”ì¶œ ë©”ë‰´ -->
        <div class="extract-panel">
            <h3>ğŸ¬ MP4 ì¶”ì¶œ</h3>
            <div class="extract-options">
                <button class="extract-option-btn" onclick="extractAllChaptersMP4()">
                    ğŸ“š ì±•í„°ë³„ MP4 ì¶”ì¶œ
                </button>
                <button class="extract-option-btn" onclick="extractAllScenesMP4()">
                    ğŸ¬ ì”¬ë³„ MP4 ì¶”ì¶œ
                </button>
                <button class="extract-option-btn" onclick="extractBookmarkedOnlyMP4()">
                    â­ ë¶ë§ˆí¬ë§Œ MP4 ì¶”ì¶œ
                </button>
                <button class="extract-option-btn" onclick="extractAllSentencesMP4()">
                    ğŸ“ ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4
                </button>
            </div>
            <div id="extractStatusMP4" class="extract-status"></div>
        </div>

        <!-- ìë™ ë²ˆì—­ ë©”ë‰´ -->
        <div class="translate-panel">
            <h3>ğŸŒ ìë™ ë²ˆì—­</h3>
            <div class="translate-options">
                <div id="translationInfo" style="margin-bottom: 10px; font-size: 0.9em; color: #cccccc;">
                    <!-- ë²ˆì—­ ìƒíƒœ ì •ë³´ê°€ ì—¬ê¸° í‘œì‹œë¨ -->
                </div>
                <button class="extract-option-btn" onclick="startTranslation()" id="translateBtn">
                    ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘
                </button>
                <div id="translationStatus" class="extract-status" style="display: none;"></div>
            </div>
        </div>

        <!-- VAD í•„í„° ë©”ë‰´ -->
        <div class="filter-panel">
            <h3>ğŸ™ï¸ ì˜¤ë””ì˜¤ í•„í„°</h3>
            <div class="filter-options">
                <label>
                    <input type="checkbox" id="vadFilter" onchange="toggleVADFilter()">
                    ìŒì„± í™œë™ ê°ì§€ (VAD) í•„í„°
                </label>
                <div class="filter-details" id="vadDetails" style="display: none;">
                    <div style="margin: 10px 0;">
                        <label>ë¯¼ê°ë„:</label>
                        <input type="range" id="vadThreshold" min="0.1" max="0.9" step="0.1" value="0.3" onchange="updateVADThreshold()">
                        <span id="vadThresholdValue">0.3</span>
                    </div>
                    <button class="extract-option-btn" onclick="applyVADFilter()" style="margin: 5px 0;">
                        ğŸ¯ VAD í•„í„° ì ìš©
                    </button>
                    <button class="extract-option-btn" onclick="createVADAudio()" style="margin: 5px 0;">
                        ğŸµ ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„±
                    </button>
                    <div id="vadStatus" style="font-size: 0.8em; color: #858585; margin-top: 5px;"></div>
                </div>
            </div>
        </div>
        
        <!-- ë¶ë§ˆí¬ëœ ë¬¸ì¥ -->
        <div class="bookmarked-panel">
            <h3>â­ ë¶ë§ˆí¬ëœ ë¬¸ì¥</h3>
            <div id="bookmarkedList"></div>
        </div>
    </div>
    
    <!-- Whisper ëª¨ë‹¬ -->
    <div id="whisperModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ¤ Whisper ìë§‰ ìƒì„±</h3>
                <button class="modal-close" onclick="closeModal('whisperModal')">&times;</button>
            </div>
            <div class="modal-form">
                <div>
                    <label>ëª¨ë¸ ì„ íƒ:</label>
                    <select id="modalModelSelect">
                        <option value="tiny">âš¡ Tiny (ë¹ ë¦„, ë‚®ì€ ì •í™•ë„)</option>
                        <option value="small">ğŸ”¹ Small (ë³´í†µ ì†ë„, ë³´í†µ ì •í™•ë„)</option>
                        <option value="medium" selected>ğŸ”¸ Medium (ëŠë¦¼, ë†’ì€ ì •í™•ë„)</option>
                    </select>
                </div>
                <div>
                    <label>êµ¬ì¡° í…œí”Œë¦¿:</label>
                    <select id="modalTemplateSelect">
                        <option value="auto">ğŸ¤– ìë™ ê°ì§€</option>
                        <option value="toeic_lc" selected>ğŸ“š TOEIC LC (Part 1-4)</option>
                        <option value="toeic_rc">ğŸ“– TOEIC RC (Part 5-7)</option>
                        <option value="general">ğŸ“ ì¼ë°˜ ê°•ì˜</option>
                        <option value="conversation">ğŸ’¬ ëŒ€í™”/ì¸í„°ë·°</option>
                        <option value="audiobook">ğŸ“š ì˜¤ë””ì˜¤ë¶</option>
                        <option value="manual">âš™ï¸ ìˆ˜ë™ ì„¤ì •</option>
                    </select>
                </div>
                <button onclick="startModalWhisper()">ğŸ¤ Whisper ìƒì„± ì‹œì‘</button>
            </div>
        </div>
    </div>
    
    <!-- SRT ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="srtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“„ SRT ìë§‰ ì—…ë¡œë“œ</h3>
                <button class="modal-close" onclick="closeModal('srtModal')">&times;</button>
            </div>
            <div class="modal-form">
                <div>
                    <label>SRT íŒŒì¼ ì„ íƒ:</label>
                    <input type="file" id="modalSrtFileInput" accept=".srt">
                    <div style="font-size: 0.8em; color: #858585; margin-top: 5px;">
                        ìë§‰ íŒŒì¼ (.srt) í˜•ì‹ìœ¼ë¡œ ì‹œê°„ ì •ë³´ì™€ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤
                    </div>
                </div>
                <button class="srt-btn" onclick="startModalSrtUpload()">ğŸ“„ SRT ì—…ë¡œë“œ ì‹œì‘</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentMedia = null;
        let sentences = [];
        let audioPlayer = null;
        let videoPlayer = null;
        let currentPlayer = null; // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ í”Œë ˆì´ì–´
        let currentSentenceIndex = -1;
        let currentSubtitleSentence = null; // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ìë§‰ì˜ ë¬¸ì¥ ì •ë³´
        let translationInterval = null;
        let uploadedMediaId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            audioPlayer = document.getElementById('audioPlayer');
            videoPlayer = document.getElementById('videoPlayer');
            
            // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì‹œê°„ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸
            videoPlayer.addEventListener('timeupdate', updateVideoSubtitles);
            
            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            setupDragAndDrop();
            
            // ê²€ìƒ‰ ì…ë ¥ ì²˜ë¦¬
            document.getElementById('searchInput').addEventListener('input', handleSearchInput);
            
            // ë¯¸ë””ì–´ ëª©ë¡ ë¡œë“œ
            loadMediaList();
            
            // ì´ˆê¸° ìƒíƒœ: ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ, ë‹¤ë¥¸ ì„¹ì…˜ë“¤ ìˆ¨ê¹€
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('processingOptions').style.display = 'none';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('subtitleGenerationMenu').style.display = 'none';
            
            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ë¡œë“œ (ê°œë°œìš©)
            // loadSimulationData();
        });
        
        function setupDragAndDrop() {
            const uploadArea = document.querySelector('.upload-area');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì²˜ë¦¬
                    const file = files[0];
                    const supportedFormats = /\.(mp3|wav|m4a|ogg|mp4|avi|mov|mkv|webm|flv)$/i;
                    
                    if (supportedFormats.test(file.name)) {
                        handleFileUpload({ target: { files: [file] } });
                    } else {
                        const statusEl = document.getElementById('uploadStatus');
                        statusEl.innerHTML = `âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹: ${file.name}`;
                    }
                }
            }
        }
        
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const statusEl = document.getElementById('uploadStatus');
            const file = files[0];
            
            // íŒŒì¼ íƒ€ì… í™•ì¸
            const isVideo = /\.(mp4|avi|mov|mkv|webm|flv)$/i.test(file.name);
            const isAudio = /\.(mp3|wav|m4a|ogg)$/i.test(file.name);
            
            if (isVideo) {
                statusEl.innerHTML = `ğŸ¬ ì˜ìƒ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            } else if (isAudio) {
                statusEl.innerHTML = `ğŸµ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            } else {
                statusEl.innerHTML = `ğŸ“ íŒŒì¼ ì—…ë¡œë“œ ì¤‘... (${file.name})`;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // íŒŒì¼ í¬ê¸° í‘œì‹œë§Œ (ì œí•œ ì—†ìŒ)
            // if (file.size > 500 * 1024 * 1024) {
            //     statusEl.innerHTML = `âŒ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (${Math.round(file.size / 1024 / 1024)}MB). ìµœëŒ€ 500MBê¹Œì§€ ì§€ì›ë©ë‹ˆë‹¤.`;
            //     return;
            // }
            
            statusEl.innerHTML += ` (${Math.round(file.size / 1024 / 1024)}MB)`;
            
            // AbortControllerë¡œ íƒ€ì„ì•„ì›ƒ ì œì–´
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort();
                statusEl.innerHTML = `âŒ ì—…ë¡œë“œ íƒ€ì„ì•„ì›ƒ (10ë¶„ ì œí•œ): ${file.name}`;
            }, 10 * 60 * 1000); // 10ë¶„ íƒ€ì„ì•„ì›ƒ
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                console.log('Upload response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('Upload server error response:', errorData);
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (isVideo) {
                        statusEl.innerHTML = `âœ… ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ (ì˜¤ë””ì˜¤ ì¶”ì¶œë¨): ${file.name}`;
                    } else {
                        statusEl.innerHTML = `âœ… ì—…ë¡œë“œ ì™„ë£Œ: ${file.name}`;
                    }
                    
                    // ì—…ë¡œë“œëœ ë¯¸ë””ì–´ ID ì €ì¥
                    uploadedMediaId = data.media_id;
                    
                    // í”Œë ˆì´ì–´ì— íŒŒì¼ ë¡œë“œ (ì˜ìƒ/ì˜¤ë””ì˜¤ êµ¬ë¶„)
                    const mediaTitle = document.getElementById('mediaTitle');
                    const mediaPlayerDiv = document.querySelector('.media-player');
                    
                    // ì˜ìƒ íŒŒì¼ í™•ì¸
                    const videoExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm', 'flv'];
                    const fileExt = data.filename.toLowerCase().split('.').pop();
                    const isVideo = videoExtensions.includes(fileExt);
                    
                    if (isVideo) {
                        // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                        videoPlayer.src = `/api/audio/${data.filename}`;
                        videoPlayer.style.display = 'block';
                        audioPlayer.style.display = 'none';
                        currentPlayer = videoPlayer;
                    } else {
                        // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                        audioPlayer.src = `/api/audio/${data.filename}`;
                        audioPlayer.style.display = 'block';
                        videoPlayer.style.display = 'none';
                        currentPlayer = audioPlayer;
                    }
                    
                    mediaTitle.textContent = data.original_filename;
                    mediaPlayerDiv.style.display = 'block';
                    
                    console.log(`Media loaded: ${data.original_filename}`);
                    
                    // ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ
                    document.getElementById('processingOptions').style.display = 'block';
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                } else {
                    if (isVideo && data.error.includes('extract audio')) {
                        statusEl.innerHTML = `âŒ ì˜ìƒì—ì„œ ì˜¤ë””ì˜¤ ì¶”ì¶œ ì‹¤íŒ¨: ${file.name}`;
                    } else {
                        statusEl.innerHTML = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${file.name} - ${data.error}`;
                    }
                    console.error('Upload error:', data.error);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Upload error:', error);
                
                if (error.name === 'AbortError') {
                    statusEl.innerHTML = `âŒ ì—…ë¡œë“œ íƒ€ì„ì•„ì›ƒ: ${file.name}`;
                } else if (error.message.includes('Failed to fetch')) {
                    statusEl.innerHTML = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ì—°ê²° ì¤‘ë‹¨): ${file.name}. íŒŒì¼ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì„œë²„ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
                } else {
                    statusEl.innerHTML = `âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
            });
        }
        
        // ìƒˆë¡œìš´ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        function processWithWhisper() {
            if (!uploadedMediaId) {
                alert('ë¨¼ì € ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }
            
            const model = document.getElementById('modelSelect').value;
            const template = document.getElementById('templateSelect').value;
            const statusEl = document.getElementById('processingStatus');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ¤ Whisper ì²˜ë¦¬ ì‹œì‘ ì¤‘... (ëª¨ë¸: ${model}, í…œí”Œë¦¿: ${template})`;
            
            fetch(`/api/media/${uploadedMediaId}/process-whisper`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    model: model,
                    template: template
                })
            })
            .then(response => {
                console.log('Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('Server error response:', errorData);
                        
                        // ì²˜ë¦¬ ì¤‘ì¸ ë¯¸ë””ì–´ì¸ ê²½ìš° ê°•ì œ ì¬ì‹œì‘ ì˜µì…˜ ì œê³µ
                        if (errorData.can_force_restart) {
                            if (confirm('ë¯¸ë””ì–´ê°€ í˜„ì¬ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ê°•ì œë¡œ ì¬ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                // ê°•ì œ ì¬ì‹œì‘ìœ¼ë¡œ ë‹¤ì‹œ ìš”ì²­
                                return fetch(`/api/media/${uploadedMediaId}/process-whisper`, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                        model: model,
                                        template: template,
                                        force_restart: true
                                    })
                                }).then(response => response.json());
                            } else {
                                throw new Error('ì²˜ë¦¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        }
                        
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    currentMedia = uploadedMediaId;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `ğŸ¤ Whisper ì²˜ë¦¬ ì¤‘... ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.`;
                    }
                    
                    // ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    monitorProcessingStatus();
                } else {
                    statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${data.error}`;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `âŒ ìë§‰ ìƒì„± ì‹¤íŒ¨: ${data.error}`;
                    }
                }
            })
            .catch(error => {
                console.error('Whisper processing error:', error);
                statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                
                // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                const generationStatusEl = document.getElementById('generationStatus');
                if (generationStatusEl) {
                    generationStatusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                }
            });
        }
        
        function uploadSentences() {
            if (!uploadedMediaId) {
                alert('ë¨¼ì € ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }
            
            const srtFile = document.getElementById('srtFileInput').files[0];
            if (!srtFile) {
                alert('SRT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            
            const statusEl = document.getElementById('processingStatus');
            const formData = new FormData();
            formData.append('file', srtFile);
            formData.append('template', 'manual');
            
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì²˜ë¦¬ ì¤‘...`;
            
            fetch(`/api/media/${uploadedMediaId}/upload-sentences`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('SRT Upload Response status:', response.status, response.statusText);
                if (!response.ok) {
                    return response.json().then(errorData => {
                        console.error('SRT Upload Server error response:', errorData);
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    currentMedia = uploadedMediaId;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ`;
                    }
                    
                    // ì²˜ë¦¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
                    monitorProcessingStatus();
                } else {
                    statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${data.error}`;
                    
                    // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                    const generationStatusEl = document.getElementById('generationStatus');
                    if (generationStatusEl) {
                        generationStatusEl.innerHTML = `âŒ SRT ì—…ë¡œë“œ ì‹¤íŒ¨: ${data.error}`;
                    }
                }
            })
            .catch(error => {
                console.error('Sentence upload error:', error);
                statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
                
                // ìë§‰ ìƒì„± ìƒíƒœ ì˜¤ë¥˜ í‘œì‹œ
                const generationStatusEl = document.getElementById('generationStatus');
                if (generationStatusEl) {
                    generationStatusEl.innerHTML = `âŒ SRT ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`;
                }
            });
        }
        
        function monitorProcessingStatus() {
            const statusEl = document.getElementById('processingStatus');
            
            const interval = setInterval(() => {
                fetch(`/api/media/${uploadedMediaId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.processed && data.sentence_count > 0) {
                            clearInterval(interval);
                            statusEl.innerHTML = `âœ… ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥ ìƒì„±ë¨`;
                            
                            // ë¬¸ì¥ ë¡œë“œ ë° í‘œì‹œ
                            loadGroupedSentences(uploadedMediaId);
                            checkTranslationStatus();
                            
                            // ì²˜ë¦¬ ì˜µì…˜ ìˆ¨ê¸°ê¸°
                            document.getElementById('processingOptions').style.display = 'none';
                        } else if (data.status === 'processing' && data.current_sentence) {
                            statusEl.innerHTML = `ğŸ”„ ${data.current_sentence}`;
                        } else if (data.status === 'error') {
                            clearInterval(interval);
                            statusEl.innerHTML = `âŒ ì²˜ë¦¬ ì˜¤ë¥˜: ${data.current_sentence}`;
                        }
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                    });
            }, 2000);
        }
        
        function checkProcessingStatus(mediaId, filename) {
            const statusEl = document.getElementById('uploadStatus');
            let checkCount = 0;
            let lastSentenceCount = 0;
            
            const interval = setInterval(() => {
                checkCount++;
                
                fetch(`/api/media/${mediaId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.processed && data.sentence_count > 0) {
                            clearInterval(interval);
                            
                            // ìµœì¢… ë¬¸ì¥ ë¡œë“œ
                            if (mediaId === currentMedia) {
                                loadMediaSentences(mediaId);
                            }
                            
                            console.log(`${filename}: ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥ ì¶”ì¶œ`);
                            
                            if (statusEl) {
                                statusEl.innerHTML = `${filename}: ì²˜ë¦¬ ì™„ë£Œ! ${data.sentence_count}ê°œ ë¬¸ì¥`;
                            }
                        } else {
                            // ì‹¤ì‹œê°„ ë¬¸ì¥ ì—…ë°ì´íŠ¸
                            if (data.sentence_count > lastSentenceCount) {
                                lastSentenceCount = data.sentence_count;
                                
                                // ìƒˆë¡œìš´ ë¬¸ì¥ì´ ì¶”ê°€ë˜ë©´ ì¦‰ì‹œ í™”ë©´ ì—…ë°ì´íŠ¸
                                if (mediaId === currentMedia) {
                                    loadMediaSentences(mediaId);
                                }
                            }
                            
                            // ì²˜ë¦¬ ì¤‘ ìƒíƒœ í‘œì‹œ (í˜„ì¬ ë¬¸ì¥ í¬í•¨)
                            if (statusEl) {
                                const dots = '.'.repeat((checkCount % 3) + 1);
                                
                                // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë¬¸ì¥ í‘œì‹œ
                                if (data.current_sentence && data.current_sentence.trim()) {
                                    statusEl.innerHTML = `
                                        <div>${filename} (${data.status || 'ì²˜ë¦¬ ì¤‘'})${dots}</div>
                                        <div style="font-size: 0.85em; color: #aaa; margin-top: 3px;">${data.current_sentence}</div>
                                        <div style="font-size: 0.8em; color: #888;">${data.sentence_count}ê°œ ë¬¸ì¥ ì™„ë£Œ</div>
                                    `;
                                } else if (data.sentence_count > 0) {
                                    statusEl.innerHTML = `${filename}: ${data.sentence_count}ê°œ ë¬¸ì¥ ì¶”ì¶œë¨${dots}`;
                                } else {
                                    statusEl.innerHTML = `${filename} ì²˜ë¦¬ ì¤‘${dots}`;
                                }
                            }
                            
                            // 30ë¶„ í›„ íƒ€ì„ì•„ì›ƒ (ëŒ€ìš©ëŸ‰ íŒŒì¼ ê³ ë ¤)
                            if (checkCount > 1800) {  // 30ë¶„
                                clearInterval(interval);
                                if (statusEl) {
                                    statusEl.innerHTML = `${filename}: ì²˜ë¦¬ ì‹œê°„ ì´ˆê³¼ (30ë¶„)`;
                                }
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                        if (statusEl) {
                            statusEl.innerHTML = `${filename}: ìƒíƒœ í™•ì¸ ì˜¤ë¥˜`;
                        }
                        clearInterval(interval);
                    });
            }, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸ (ë” ë¹ ë¥¸ ì—…ë°ì´íŠ¸)
        }
        
        function loadMediaList() {
            console.log('Loading media list...');
            fetch('/api/media')
                .then(response => {
                    console.log('Media API response:', response.status);
                    return response.json();
                })
                .then(media => {
                    console.log('Media data:', media);
                    const listEl = document.getElementById('mediaList');
                    if (!listEl) {
                        console.error('mediaList element not found!');
                        return;
                    }
                    
                    if (media.length === 0) {
                        listEl.innerHTML = '<div style="color: #858585; padding: 10px;">ì—…ë¡œë“œëœ ë¯¸ë””ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    } else {
                        listEl.innerHTML = media.map(m => {
                            // UUID ì œê±°: UUIDëŠ” 36ìë¦¬ (8-4-4-4-12) í˜•íƒœì´ë¯€ë¡œ ì²« 37ì(UUID + _)ë¥¼ ì œê±°
                            const displayName = m.filename.includes('_') ? 
                                m.filename.substring(m.filename.indexOf('_') + 1) : 
                                m.filename;
                            
                            return `
                            <div class="media-item" onclick="loadMediaSentences(${m.id})" data-media-id="${m.id}">
                                <div style="font-weight: bold;" title="${displayName}">${displayName}</div>
                                <div style="font-size: 0.8em; color: #858585;">
                                    ${m.createdAt ? new Date(m.createdAt).toLocaleDateString() : ''}
                                </div>
                                <button class="delete-btn" onclick="deleteMedia(${m.id}, event)" 
                                        style="position: absolute; right: 5px; top: 5px; background: #d32f2f; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                    âœ•
                                </button>
                            </div>
                            `;
                        }).join('');
                    }
                    console.log(`Media list updated: ${media.length} items`);
                })
                .catch(error => {
                    console.error('Failed to load media list:', error);
                    const listEl = document.getElementById('mediaList');
                    if (listEl) {
                        listEl.innerHTML = '<div style="color: #ff6b6b;">ë¯¸ë””ì–´ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨</div>';
                    }
                });
        }
        
        function showUploadSection() {
            // ì—…ë¡œë“œ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('uploadSection').style.display = 'block';
            
            // ì²˜ë¦¬ ì˜µì…˜, ê²€ìƒ‰ ì„¹ì…˜, ìë§‰ ìƒì„± ë©”ë‰´ ìˆ¨ê¸°ê¸°
            document.getElementById('processingOptions').style.display = 'none';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('subtitleGenerationMenu').style.display = 'none';
            
            // ë¯¸ë””ì–´ í”Œë ˆì´ì–´ ìˆ¨ê¸°ê¸°
            document.querySelector('.media-player').style.display = 'none';
            
            // ë¬¸ì¥ ëª©ë¡ ìˆ¨ê¸°ê¸°
            document.getElementById('sentenceList').innerHTML = '';
            document.getElementById('bookmarkedList').innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            
            // ë¯¸ë””ì–´ ì„ íƒ í•´ì œ
            document.querySelectorAll('.media-item').forEach(item => {
                item.classList.remove('active');
            });
            
            currentMedia = null;
            console.log('Upload section shown');
        }
        
        function showWhisperOptions() {
            // Whisper ëª¨ë‹¬ ë„ìš°ê¸°
            document.getElementById('whisperModal').style.display = 'block';
        }
        
        function showSrtUpload() {
            // SRT ì—…ë¡œë“œ ëª¨ë‹¬ ë„ìš°ê¸°
            document.getElementById('srtModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function startModalWhisper() {
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!currentMedia) {
                alert('ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ì—ì„œ ì„ íƒëœ ê°’ë“¤ ê°€ì ¸ì˜¤ê¸°
            const model = document.getElementById('modalModelSelect').value;
            const template = document.getElementById('modalTemplateSelect').value;
            
            // uploadedMediaId ì„¤ì •
            uploadedMediaId = currentMedia;
            
            // ê¸°ì¡´ í”„ë¡œì„¸ì‹± ì˜µì…˜ì˜ select ê°’ë“¤ ì„¤ì •
            document.getElementById('modelSelect').value = model;
            document.getElementById('templateSelect').value = template;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('whisperModal');
            
            // ìë§‰ ìƒì„± ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ¤ Whisper ìë§‰ ìƒì„± ì¤‘... (ëª¨ë¸: ${model})`;
            
            // ê¸°ì¡´ Whisper ì²˜ë¦¬ í•¨ìˆ˜ í˜¸ì¶œ
            processWithWhisper();
        }
        
        function startModalSrtUpload() {
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ê°€ ìˆëŠ”ì§€ í™•ì¸
            if (!currentMedia) {
                alert('ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ëª¨ë‹¬ì—ì„œ ì„ íƒëœ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
            const fileInput = document.getElementById('modalSrtFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('SRT íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // uploadedMediaId ì„¤ì •
            uploadedMediaId = currentMedia;
            
            // ê¸°ì¡´ SRT íŒŒì¼ inputì— íŒŒì¼ ì„¤ì •
            const originalFileInput = document.getElementById('srtFileInput');
            originalFileInput.files = fileInput.files;
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeModal('srtModal');
            
            // ìë§‰ ìƒì„± ìƒíƒœ í‘œì‹œ
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = `ğŸ“„ SRT íŒŒì¼ ì—…ë¡œë“œ ì¤‘...`;
            
            // ê¸°ì¡´ SRT ì—…ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
            uploadSentences();
        }
        
        // ë¹„ë””ì˜¤ ìë§‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateVideoSubtitles() {
            const videoSubtitlesDiv = document.getElementById('videoSubtitles');
            const currentSubtitleDiv = document.getElementById('currentSubtitle');
            
            if (videoPlayer.style.display === 'none' || !sentences || sentences.length === 0) {
                return;
            }
            
            const currentTime = videoPlayer.currentTime;
            let currentSubtitle = '';
            
            // í˜„ì¬ ì‹œê°„ì— í•´ë‹¹í•˜ëŠ” ë¬¸ì¥ ì°¾ê¸°
            for (let sentence of sentences) {
                if (currentTime >= sentence.startTime && currentTime <= sentence.endTime) {
                    currentSubtitle = sentence.english;
                    if (sentence.korean) {
                        currentSubtitle += `\n${sentence.korean}`;
                    }
                    currentSubtitleSentence = sentence; // í˜„ì¬ ìë§‰ ë¬¸ì¥ ì €ì¥
                    break;
                }
            }
            
            // ìë§‰ í‘œì‹œ
            if (currentSubtitle) {
                videoSubtitlesDiv.style.display = 'block';
                currentSubtitleDiv.innerHTML = currentSubtitle.replace(/\n/g, '<br>');
                // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateSubtitleBookmarkButton();
            } else {
                currentSubtitleDiv.innerHTML = '';
                currentSubtitleSentence = null;
            }
        }
        
        // ìë§‰ ë¶ë§ˆí¬ í† ê¸€ í•¨ìˆ˜
        function toggleSubtitleBookmark() {
            if (!currentSubtitleSentence) return;
            
            const sentenceElement = document.querySelector(`[data-sentence-id="${currentSubtitleSentence.id}"]`);
            if (sentenceElement) {
                sentenceElement.click(); // ê¸°ì¡´ toggleBookmark í•¨ìˆ˜ í™œìš©
            }
        }
        
        // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateSubtitleBookmarkButton() {
            const btn = document.getElementById('subtitleBookmarkBtn');
            if (!btn || !currentSubtitleSentence) return;
            
            const sentenceElement = document.querySelector(`[data-sentence-id="${currentSubtitleSentence.id}"]`);
            if (sentenceElement && sentenceElement.classList.contains('bookmarked')) {
                btn.innerHTML = 'â˜…';
                btn.style.background = '#ff9800';
                btn.style.color = '#ffffff';
            } else {
                btn.innerHTML = 'â˜†';
                btn.style.background = '#333333';
                btn.style.color = '#cccccc';
            }
        }
        
        // ìë§‰ ì‚­ì œ í•¨ìˆ˜
        function deleteSubtitles() {
            if (!currentMedia) {
                alert('ë¯¸ë””ì–´ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('ì •ë§ë¡œ ì´ ë¯¸ë””ì–´ì˜ ëª¨ë“  ìë§‰ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œ í›„ ìë§‰ì„ ë‹¤ì‹œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            const statusEl = document.getElementById('generationStatus');
            statusEl.style.display = 'block';
            statusEl.innerHTML = 'ğŸ—‘ï¸ ìë§‰ ì‚­ì œ ì¤‘...';
            
            fetch(`/api/media/${currentMedia}/subtitles`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`Server error: ${errorData.error || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = 'âœ… ìë§‰ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ìë§‰ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    
                    // ë¬¸ì¥ ëª©ë¡ ì´ˆê¸°í™”
                    document.getElementById('sentenceList').innerHTML = '';
                    sentences = [];
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                    
                    // 5ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                } else {
                    statusEl.innerHTML = `âŒ ìë§‰ ì‚­ì œ ì‹¤íŒ¨: ${data.error}`;
                }
            })
            .catch(error => {
                console.error('Delete subtitles error:', error);
                statusEl.innerHTML = `âŒ ìë§‰ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
            });
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const whisperModal = document.getElementById('whisperModal');
            const srtModal = document.getElementById('srtModal');
            
            if (event.target == whisperModal) {
                whisperModal.style.display = 'none';
            }
            if (event.target == srtModal) {
                srtModal.style.display = 'none';
            }
        }
        
        function loadMediaSentences(mediaId) {
            currentMedia = mediaId;
            
            // ì—…ë¡œë“œ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('uploadSection').style.display = 'none';
            
            // ê²€ìƒ‰ ì„¹ì…˜ê³¼ ìë§‰ ìƒì„± ë©”ë‰´ í‘œì‹œ
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('subtitleGenerationMenu').style.display = 'block';
            
            // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ ê°•ì¡°
            document.querySelectorAll('.media-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.mediaId == mediaId) {
                    item.classList.add('active');
                }
            });
            
            // ë¯¸ë””ì–´ ì •ë³´ ë¡œë“œ (íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸°)
            fetch('/api/media')
                .then(response => response.json())
                .then(mediaList => {
                    const media = mediaList.find(m => m.id == mediaId);
                    if (media) {
                        // í”Œë ˆì´ì–´ì— íŒŒì¼ ë¡œë“œ (ì˜ìƒ/ì˜¤ë””ì˜¤ êµ¬ë¶„)
                        const mediaTitle = document.getElementById('mediaTitle');
                        const mediaPlayerDiv = document.querySelector('.media-player');
                        
                        // ì˜ìƒ íŒŒì¼ í™•ì¸
                        const videoExtensions = ['mp4', 'avi', 'mov', 'mkv', 'webm', 'flv'];
                        const fileExt = media.filename.toLowerCase().split('.').pop();
                        const isVideoFile = videoExtensions.includes(fileExt);
                        
                        if (isVideoFile) {
                            // ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                            videoPlayer.src = `/api/audio/${media.filename}`;
                            videoPlayer.style.display = 'block';
                            audioPlayer.style.display = 'none';
                            document.getElementById('videoSubtitles').style.display = 'block';
                            currentPlayer = videoPlayer;
                        } else {
                            // ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ ì‚¬ìš©
                            audioPlayer.src = `/api/audio/${media.filename}`;
                            audioPlayer.style.display = 'block';
                            videoPlayer.style.display = 'none';
                            document.getElementById('videoSubtitles').style.display = 'none';
                            currentPlayer = audioPlayer;
                        }
                        
                        mediaTitle.textContent = media.filename;
                        mediaPlayerDiv.style.display = 'block';
                        
                        // ë¯¸ë””ì–´ ìƒíƒœì— ë”°ë¼ ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ ì—¬ë¶€ ê²°ì •
                        const processingOptions = document.getElementById('processingOptions');
                        
                        if (media.status === 'uploaded' || media.status === 'error' || (isVideoFile && media.status === 'completed')) {
                            // ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë¯¸ë””ì–´ ë˜ëŠ” ì˜ìƒ íŒŒì¼ì€ ì²˜ë¦¬ ì˜µì…˜ í‘œì‹œ
                            processingOptions.style.display = 'block';
                            uploadedMediaId = media.id; // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
                        } else {
                            // ì´ë¯¸ ì²˜ë¦¬ëœ ì˜¤ë””ì˜¤ íŒŒì¼ì€ ì²˜ë¦¬ ì˜µì…˜ ìˆ¨ê¹€
                            processingOptions.style.display = 'none';
                        }
                        
                        console.log(`Loaded audio: ${media.filename}, status: ${media.status}`);
                    }
                })
                .catch(error => {
                    console.error('Failed to load media info:', error);
                });
            
            // ì±•í„° êµ¬ì¡° ë¡œë“œ
            fetch(`/api/media/${mediaId}/chapters`)
                .then(response => response.json())
                .then(chapters => {
                    displayChapters(chapters);
                })
                .catch(error => {
                    console.error('Failed to load chapters:', error);
                });
            
            // ê·¸ë£¹í™”ëœ ë¬¸ì¥ ë¡œë“œ
            fetch(`/api/media/${mediaId}/sentences-grouped`)
                .then(response => response.json())
                .then(chapters => {
                    displayGroupedSentences(chapters);
                    console.log(`Loaded ${chapters.length} chapters with scenes and sentences`);
                })
                .catch(error => {
                    console.error('Failed to load grouped sentences:', error);
                });
            
            // ë²ˆì—­ ìƒíƒœ í™•ì¸
            checkTranslationStatus();
        }
        
        function loadGroupedSentences(mediaId) {
            // ê·¸ë£¹í™”ëœ ë¬¸ì¥ ë¡œë“œ
            fetch(`/api/media/${mediaId}/sentences-grouped`)
                .then(response => response.json())
                .then(chapters => {
                    displayGroupedSentences(chapters);
                    console.log(`Loaded ${chapters.length} chapters with scenes and sentences`);
                })
                .catch(error => {
                    console.error('Failed to load grouped sentences:', error);
                });
        }
        
        function displayChapters(chapters) {
            const chapterListEl = document.getElementById('chapterList');
            const chapterContentEl = document.getElementById('chapterContent');
            
            if (chapters.length === 0) {
                chapterListEl.style.display = 'none';
                return;
            }
            
            chapterListEl.style.display = 'block';
            
            let html = '';
            chapters.forEach(chapter => {
                html += `<div class="chapter-item">
                    <strong>${chapter.title}</strong> (${chapter.startTime.toFixed(1)}s - ${chapter.endTime.toFixed(1)}s)
                    <div>${chapter.scene_count}ê°œ ì”¬</div>
                `;
                
                chapter.scenes.forEach(scene => {
                    html += `<div class="scene-item">
                        ${scene.title} (${scene.sentence_count}ê°œ ë¬¸ì¥)
                    </div>`;
                });
                
                html += '</div>';
            });
            
            chapterContentEl.innerHTML = html;
        }
        
        function loadSimulationData() {
            // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
            sentences = [
                {
                    id: 1,
                    english: "What are you doing?",
                    korean: "ë­ í•˜ê³  ìˆì–´?",
                    start_time: 0,
                    end_time: 2,
                    bookmark: false
                },
                {
                    id: 2,
                    english: "I'm learning English with this amazing tool.",
                    korean: "ì´ ë©‹ì§„ ë„êµ¬ë¡œ ì˜ì–´ë¥¼ ê³µë¶€í•˜ê³  ìˆì–´ìš”.",
                    start_time: 2,
                    end_time: 5,
                    bookmark: false
                },
                {
                    id: 3,
                    english: "Can you help me with my pronunciation?",
                    korean: "ë°œìŒ ë„ì™€ì¤„ ìˆ˜ ìˆì–´?",
                    start_time: 5,
                    end_time: 8,
                    bookmark: false
                }
            ];
            
            displaySentences();
        }
        
        function generateSentences() {
            // ì‹¤ì œë¡œëŠ” Whisper API í˜¸ì¶œ
            loadSimulationData();
        }
        
        function displayGroupedSentences(chapters) {
            const listEl = document.getElementById('sentenceList');
            listEl.innerHTML = '';
            
            // ì „ì—­ sentences ë°°ì—´ ì´ˆê¸°í™”
            sentences = [];
            let globalIndex = 0;
            
            console.log('displayGroupedSentences called with:', chapters);

            chapters.forEach((chapter, chapterIndex) => {
                // ì±•í„° ì„¹ì…˜ ìƒì„±
                const chapterSection = document.createElement('div');
                chapterSection.className = 'chapter-section';
                chapterSection.dataset.chapterId = chapter.id;
                
                // ì±•í„° í—¤ë”
                const chapterHeader = document.createElement('div');
                chapterHeader.className = 'chapter-header';
                chapterHeader.innerHTML = `
                    <div>
                        <div class="chapter-title">ğŸ“š ${chapter.title}</div>
                        <div class="chapter-info">${chapter.startTime?.toFixed(1) || 0}s - ${chapter.endTime?.toFixed(1) || 0}s</div>
                    </div>
                    <div class="chapter-info">
                        ${chapter.scenes?.length || 0}ê°œ ì”¬
                        <button class="chapter-extract-btn" onclick="extractChapter(${chapter.id}, event)">MP3</button>
                        <button class="chapter-extract-btn" onclick="extractChapterMP4(${chapter.id}, event)" style="background: #2563eb;">MP4</button>
                        <span class="collapse-icon">â–¼</span>
                    </div>
                `;
                
                // ì±•í„° ì ‘ê¸°/í¼ì¹˜ê¸°
                chapterHeader.onclick = function(e) {
                    // MP3 ì¶”ì¶œ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° ë¬´ì‹œ
                    if (e.target.classList.contains('chapter-extract-btn')) {
                        return;
                    }
                    
                    const content = chapterSection.querySelector('.chapter-content');
                    const icon = chapterHeader.querySelector('.collapse-icon');
                    if (content.style.display === 'none') {
                        content.style.display = 'block';
                        icon.textContent = 'â–¼';
                        chapterSection.classList.remove('collapsed');
                    } else {
                        content.style.display = 'none';
                        icon.textContent = 'â–¶';
                        chapterSection.classList.add('collapsed');
                    }
                };
                
                chapterSection.appendChild(chapterHeader);
                
                // ì±•í„° ë‚´ìš©
                const chapterContent = document.createElement('div');
                chapterContent.className = 'chapter-content';
                
                // ì”¬ë“¤ ì²˜ë¦¬
                chapter.scenes?.forEach((scene, sceneIndex) => {
                    const sceneStartIndex = globalIndex; // ì´ ì”¬ì˜ ì‹œì‘ ì¸ë±ìŠ¤ ì €ì¥
                    
                    const sceneSection = document.createElement('div');
                    sceneSection.className = 'scene-section';
                    sceneSection.dataset.sceneId = scene.id;
                    
                    // ì”¬ í—¤ë”
                    const sceneHeader = document.createElement('div');
                    sceneHeader.className = 'scene-header';
                    sceneHeader.innerHTML = `
                        <div>
                            <div class="scene-title">ğŸ¬ ${scene.title}</div>
                            <div class="scene-info">${scene.startTime?.toFixed(1) || 0}s - ${scene.endTime?.toFixed(1) || 0}s</div>
                        </div>
                        <div class="scene-info">
                            ${scene.sentences?.length || 0}ê°œ ë¬¸ì¥
                            <button class="scene-extract-btn" onclick="extractScene(${scene.id}, event)">MP3</button>
                            <button class="scene-extract-btn" onclick="extractSceneMP4(${scene.id}, event)" style="background: #2563eb;">MP4</button>
                            <span class="collapse-icon">â–¼</span>
                        </div>
                    `;
                    
                    // ì”¬ ì ‘ê¸°/í¼ì¹˜ê¸° ë° ì”¬ìœ¼ë¡œ ì´ë™
                    sceneHeader.onclick = function(e) {
                        // MP3 ì¶”ì¶œ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° ë¬´ì‹œ
                        if (e.target.classList.contains('scene-extract-btn')) {
                            return;
                        }
                        
                        // ì ‘ê¸°/í¼ì¹˜ê¸° ì•„ì´ì½˜ì„ í´ë¦­í•œ ê²½ìš°
                        if (e.target.classList.contains('collapse-icon') || e.target.closest('.collapse-icon')) {
                            const content = sceneSection.querySelector('.scene-content');
                            const icon = sceneHeader.querySelector('.collapse-icon');
                            if (content.style.display === 'none') {
                                content.style.display = 'block';
                                icon.textContent = 'â–¼';
                                sceneSection.classList.remove('collapsed');
                            } else {
                                content.style.display = 'none';
                                icon.textContent = 'â–¶';
                                sceneSection.classList.add('collapsed');
                            }
                        } else {
                            // ì”¬ ì œëª©ì„ í´ë¦­í•œ ê²½ìš° - í•´ë‹¹ ì”¬ìœ¼ë¡œ ì´ë™
                            jumpToScene(scene, sceneStartIndex);
                        }
                    };
                    
                    sceneSection.appendChild(sceneHeader);
                    
                    // ì”¬ ë‚´ìš© (ë¬¸ì¥ë“¤)
                    const sceneContent = document.createElement('div');
                    sceneContent.className = 'scene-content';
                    
                    scene.sentences?.forEach((sentence, sentenceIndex) => {
                        // ë¬¸ì¥ ë°ì´í„° ì •ê·œí™” (startTime/endTime í•„ë“œ í†µì¼)
                        const normalizedSentence = {
                            ...sentence,
                            startTime: sentence.startTime || sentence.start_time || 0,
                            endTime: sentence.endTime || sentence.end_time || 0
                        };
                        
                        // ì „ì—­ sentences ë°°ì—´ì— ì¶”ê°€
                        sentences.push(normalizedSentence);
                        
                        const sentenceEl = document.createElement('div');
                        sentenceEl.className = 'sentence-item' + (sentence.bookmark ? ' bookmarked' : '');
                        sentenceEl.dataset.index = globalIndex;
                        sentenceEl.dataset.sentenceId = sentence.id;
                        
                        sentenceEl.innerHTML = `
                            <span class="sentence-number">${sentence.order}.</span>
                            <span class="sentence-text">${sentence.english}</span>
                            <span class="sentence-korean">${sentence.korean || ''}</span>
                            <div style="font-size: 0.7em; color: #666; margin-top: 3px;">
                                ${sentence.startTime?.toFixed(1) || 0}s - ${sentence.endTime?.toFixed(1) || 0}s
                            </div>
                            <button class="bookmark-btn" onclick="toggleBookmark(${globalIndex}, event)">â˜…</button>
                            <button class="extract-btn" onclick="extractMP3(${globalIndex}, event)">MP3</button>
                            <button class="extract-btn" onclick="extractMP4(${globalIndex}, event)" style="background: #2563eb;">MP4</button>
                        `;

                        sentenceEl.onclick = (function(index, sentenceData) {
                            return function(e) {
                                if (!e.target.classList.contains('bookmark-btn') && 
                                    !e.target.classList.contains('extract-btn')) {
                                    console.log('Sentence clicked:', index, sentenceData.english);
                                    playSentence(index);
                                }
                            };
                        })(globalIndex, normalizedSentence);
                        
                        // í˜¸ë²„ íš¨ê³¼ ê°œì„ 
                        sentenceEl.addEventListener('mouseenter', function() {
                            this.style.cursor = 'pointer';
                        });

                        sceneContent.appendChild(sentenceEl);
                        globalIndex++;
                    });
                    
                    sceneSection.appendChild(sceneContent);
                    chapterContent.appendChild(sceneSection);
                });
                
                chapterSection.appendChild(chapterContent);
                listEl.appendChild(chapterSection);
            });

            console.log(`Loaded ${sentences.length} sentences`);
            updateBookmarkedList();
        }
        
        function displaySentences() {
            const listEl = document.getElementById('sentenceList');
            listEl.innerHTML = '';
            
            sentences.forEach((sentence, index) => {
                const el = document.createElement('div');
                el.className = 'sentence-item' + (sentence.bookmark ? ' bookmarked' : '');
                el.dataset.index = index;
                
                el.innerHTML = `
                    <span class="sentence-number">${sentence.id || sentence.order}.</span>
                    <span class="sentence-text">${sentence.english}</span>
                    <span class="sentence-korean">${sentence.korean || ''}</span>
                    <div style="font-size: 0.7em; color: #666; margin-top: 3px;">
                        ${sentence.chapter_title || ''} > ${sentence.scene_title || ''} 
                        (${sentence.startTime?.toFixed(1) || 0}s - ${sentence.endTime?.toFixed(1) || 0}s)
                    </div>
                    <button class="bookmark-btn" onclick="toggleBookmark(${index}, event)">â˜…</button>
                    <button class="extract-btn" onclick="extractMP3(${index}, event)">MP3</button>
                    <button class="extract-btn" onclick="extractMP4(${index}, event)" style="background: #2563eb;">MP4</button>
                `;
                
                el.onclick = function(e) {
                    if (!e.target.classList.contains('bookmark-btn') && 
                        !e.target.classList.contains('extract-btn')) {
                        playSentence(index);
                    }
                };
                
                listEl.appendChild(el);
            });
            
            updateBookmarkedList();
        }
        
        function playSentence(index) {
            const sentence = sentences[index];
            console.log('playSentence called:', index, sentence);
            
            if (currentPlayer && sentence) {
                const startTime = sentence.startTime || sentence.start_time || 0;
                const endTime = sentence.endTime || sentence.end_time || startTime + 3;
                
                console.log('Playing:', startTime, '-', endTime);
                
                currentPlayer.currentTime = startTime;
                currentPlayer.play().then(() => {
                    console.log('Media started playing');
                }).catch(error => {
                    console.error('Media play error:', error);
                });
                
                // ì¢…ë£Œ ì‹œê°„ì— ì¼ì‹œì •ì§€
                const checkTime = () => {
                    if (currentPlayer.currentTime >= endTime) {
                        currentPlayer.pause();
                        clearInterval(timeCheckInterval);
                        console.log('Media stopped at:', currentPlayer.currentTime);
                    }
                };
                
                const timeCheckInterval = setInterval(checkTime, 100);
                
                // ìµœëŒ€ ì¬ìƒ ì‹œê°„ ì œí•œ
                setTimeout(() => {
                    clearInterval(timeCheckInterval);
                }, (endTime - startTime + 2) * 1000);
                
                currentSentenceIndex = index;
                
                // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ë¬¸ì¥ ê°•ì¡°
                document.querySelectorAll('.sentence-item').forEach(item => {
                    item.classList.remove('playing');
                });
                document.querySelector(`[data-index="${index}"]`)?.classList.add('playing');
            } else {
                console.error('Cannot play:', {currentPlayer, sentence});
            }
        }
        
        function jumpToScene(scene, startingIndex) {
            console.log('jumpToScene called:', scene.title, startingIndex);
            
            if (!scene.sentences || scene.sentences.length === 0) {
                console.log('No sentences in scene');
                return;
            }
            
            // í•´ë‹¹ ì”¬ì˜ ì²« ë²ˆì§¸ ë¬¸ì¥ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            const firstSentenceEl = document.querySelector(`[data-index="${startingIndex}"]`);
            if (firstSentenceEl) {
                firstSentenceEl.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // ì ì‹œ ê°•ì¡° í‘œì‹œ
                firstSentenceEl.classList.add('highlighted');
                setTimeout(() => {
                    firstSentenceEl.classList.remove('highlighted');
                }, 2000);
            }
            
            // ì”¬ì˜ ì²« ë²ˆì§¸ ë¬¸ì¥ ì¬ìƒ
            if (currentPlayer && scene.sentences[0]) {
                const firstSentence = scene.sentences[0];
                const startTime = firstSentence.startTime || firstSentence.start_time || 0;
                
                currentPlayer.currentTime = startTime;
                console.log(`Jumped to scene "${scene.title}" at ${startTime}s`);
            }
        }
        
        // MP3 ì¶”ì¶œ ê¸°ëŠ¥ë“¤
        function extractChapter(chapterId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting chapter:', chapterId);
            updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/chapter/${chapterId}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì±•í„° MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì±•í„° MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractScene(sceneId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting scene:', sceneId);
            updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/scene/${sceneId}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì”¬ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì”¬ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractChapterMP4(chapterId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting chapter MP4:', chapterId);
            updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/chapter/${chapterId}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì±•í„° MP4 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractSceneMP4(sceneId, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            console.log('Extracting scene MP4:', sceneId);
            updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/scene/${sceneId}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ì”¬ MP4 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ì”¬ MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllChapters() {
            if (!currentMedia) return;
            
            console.log('Extracting all chapters');
            updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-chapters`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ëª¨ë“  ì±•í„° MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllScenes() {
            if (!currentMedia) return;
            
            console.log('Extracting all scenes');
            updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-scenes`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ëª¨ë“  ì”¬ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractBookmarkedOnly() {
            if (!currentMedia) return;
            
            console.log('Extracting bookmarked sentences');
            updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-bookmarked`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatus(`ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì™„ë£Œ: <a href="${data.download_url}" download>ZIP ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatus('ë¶ë§ˆí¬ ë¬¸ì¥ MP3 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        // MP4 ì¶”ì¶œ í•¨ìˆ˜ë“¤
        function extractAllChaptersMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all chapters as MP4');
            updateExtractStatusMP4('ëª¨ë“  ì±•í„° MP4 ì¶”ì¶œ ì¤‘...');
            
            // ê° ì±•í„°ë³„ë¡œ ìˆœì°¨ ì²˜ë¦¬
            fetch(`/api/media/${currentMedia}/chapters`)
            .then(response => response.json())
            .then(chapters => {
                if (chapters.length === 0) {
                    updateExtractStatusMP4('ì¶”ì¶œí•  ì±•í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                Promise.all(chapters.map(chapter => 
                    fetch(`/api/media/${currentMedia}/chapter/${chapter.id}/extract-mp4`, {
                        method: 'POST'
                    }).then(response => response.json())
                )).then(results => {
                    const successCount = results.filter(r => r.success).length;
                    updateExtractStatusMP4(`ì±•í„° MP4 ì¶”ì¶œ ì™„ë£Œ: ${successCount}/${chapters.length}ê°œ`);
                }).catch(error => {
                    console.error('Extract error:', error);
                    updateExtractStatusMP4('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                });
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ì±•í„° MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllScenesMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all scenes as MP4');
            updateExtractStatusMP4('ëª¨ë“  ì”¬ MP4 ì¶”ì¶œ ì¤‘...');
            
            // ê° ì”¬ë³„ë¡œ ìˆœì°¨ ì²˜ë¦¬ - êµ¬í˜„ í•„ìš”ì‹œ ì¶”ê°€
            updateExtractStatusMP4('ì”¬ MP4 ì¶”ì¶œ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘...');
        }
        
        function extractBookmarkedOnlyMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting bookmarked sentences as MP4');
            updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-bookmarked-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatusMP4(`ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                } else {
                    updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ë¶ë§ˆí¬ ë¬¸ì¥ MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function extractAllSentencesMP4() {
            if (!currentMedia) return;
            
            console.log('Extracting all sentences as MP4');
            updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/extract-all-sentences-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateExtractStatusMP4(`ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                } else {
                    updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Extract error:', error);
                updateExtractStatusMP4('ì „ì²´ ë¬¸ì¥ ë¶„í•  MP4 ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function updateExtractStatusMP4(message, progress = null) {
            const statusEl = document.getElementById('extractStatusMP4');
            if (statusEl) {
                statusEl.innerHTML = message;
                
                // ì§„í–‰ë¥  ë°” í‘œì‹œ
                if (progress !== null) {
                    const progressBar = `
                        <div style="width: 100%; background-color: #333; border-radius: 5px; margin-top: 5px;">
                            <div style="width: ${progress}%; background-color: #007acc; height: 5px; border-radius: 5px;"></div>
                        </div>
                    `;
                    statusEl.innerHTML += progressBar;
                }
            }
        }
        
        function updateExtractStatus(message, progress = null) {
            const statusEl = document.getElementById('extractStatus');
            if (statusEl) {
                statusEl.innerHTML = message;
                
                // ì§„í–‰ë¥  ë°” í‘œì‹œ
                if (progress !== null) {
                    let progressBar = statusEl.querySelector('.progress-bar');
                    if (!progressBar && progress >= 0) {
                        progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        const progressFill = document.createElement('div');
                        progressFill.className = 'progress-fill';
                        progressBar.appendChild(progressFill);
                        statusEl.appendChild(progressBar);
                    }
                    
                    if (progressBar) {
                        const progressFill = progressBar.querySelector('.progress-fill');
                        if (progressFill) {
                            progressFill.style.width = `${Math.min(100, Math.max(0, progress))}%`;
                        }
                        
                        // ì™„ë£Œì‹œ ì§„í–‰ë¥  ë°” ì œê±°
                        if (progress >= 100) {
                            setTimeout(() => {
                                if (progressBar) progressBar.remove();
                            }, 1000);
                        }
                    }
                }
            }
        }
        
        function simulateProgress(statusMessage, duration = 3000) {
            let progress = 0;
            const interval = 100;
            const increment = (100 / duration) * interval;
            
            const progressInterval = setInterval(() => {
                progress += increment;
                updateExtractStatus(statusMessage, progress);
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, interval);
            
            return progressInterval;
        }
        
        // VAD í•„í„° ê¸°ëŠ¥
        let vadFilterData = null;
        
        function toggleVADFilter() {
            const vadFilter = document.getElementById('vadFilter');
            const vadDetails = document.getElementById('vadDetails');
            
            if (vadFilter.checked) {
                vadDetails.style.display = 'block';
                console.log('VAD filter enabled');
            } else {
                vadDetails.style.display = 'none';
                console.log('VAD filter disabled');
                vadFilterData = null;
                // ì›ë³¸ ë¬¸ì¥ í‘œì‹œë¡œ ë³µì›
                if (currentMedia) {
                    loadGroupedSentences(currentMedia);
                }
            }
        }
        
        function updateVADThreshold() {
            const threshold = document.getElementById('vadThreshold').value;
            document.getElementById('vadThresholdValue').textContent = threshold;
        }
        
        function applyVADFilter() {
            if (!currentMedia) return;
            
            const threshold = parseFloat(document.getElementById('vadThreshold').value);
            updateVADStatus('VAD í•„í„° ë¶„ì„ ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/vad-filter`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold: threshold})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    vadFilterData = data;
                    updateVADStatus(`ë¶„ì„ ì™„ë£Œ: ìŒì„± ${data.voice_sentences}ê°œ, ë¬´ìŒ ${data.silence_sentences}ê°œ`);
                    console.log('VAD filter applied:', data);
                    
                    // ë¬¸ì¥ í‘œì‹œ ì—…ë°ì´íŠ¸ (VAD ê²°ê³¼ ë°˜ì˜)
                    applyVADVisualization();
                } else {
                    updateVADStatus('VAD í•„í„° ì ìš© ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('VAD filter error:', error);
                updateVADStatus('VAD í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function createVADAudio() {
            if (!currentMedia) return;
            
            updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì¤‘...');
            
            fetch(`/api/media/${currentMedia}/create-vad-audio`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateVADStatus(`ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì™„ë£Œ: <a href="${data.download_url}" download>ë‹¤ìš´ë¡œë“œ</a>`);
                } else {
                    updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('VAD audio creation error:', error);
                updateVADStatus('ë¬´ìŒ ì œê±° ì˜¤ë””ì˜¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
            });
        }
        
        function updateVADStatus(message) {
            const statusEl = document.getElementById('vadStatus');
            if (statusEl) {
                statusEl.innerHTML = message;
            }
        }
        
        // ë²ˆì—­ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function checkTranslationStatus() {
            if (!currentMedia) return;
            
            fetch(`/api/media/${currentMedia}/translation-status`)
                .then(response => response.json())
                .then(data => {
                    const infoEl = document.getElementById('translationInfo');
                    const btnEl = document.getElementById('translateBtn');
                    
                    if (data.total === 0) {
                        infoEl.innerHTML = 'ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                        btnEl.disabled = true;
                        return;
                    }
                    
                    const percentage = Math.round((data.translated / data.total) * 100);
                    infoEl.innerHTML = `
                        <div>ì „ì²´: ${data.total}ê°œ ë¬¸ì¥</div>
                        <div>ë²ˆì—­ë¨: ${data.translated}ê°œ (${percentage}%)</div>
                        <div>ë¯¸ë²ˆì—­: ${data.untranslated}ê°œ</div>
                    `;
                    
                    if (data.untranslated === 0) {
                        btnEl.textContent = 'âœ… ë²ˆì—­ ì™„ë£Œ';
                        btnEl.disabled = true;
                    } else if (data.status === 'translating') {
                        btnEl.textContent = 'ğŸ”„ ë²ˆì—­ ì¤‘...';
                        btnEl.disabled = true;
                        document.getElementById('translationStatus').style.display = 'block';
                        document.getElementById('translationStatus').innerHTML = data.current || 'ë²ˆì—­ ì§„í–‰ ì¤‘...';
                    } else {
                        btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
                        btnEl.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Translation status error:', error);
                });
        }
        
        function startTranslation() {
            if (!currentMedia) return;
            
            const btnEl = document.getElementById('translateBtn');
            const statusEl = document.getElementById('translationStatus');
            
            btnEl.disabled = true;
            btnEl.textContent = 'ğŸ”„ ë²ˆì—­ ì‹œì‘ ì¤‘...';
            statusEl.style.display = 'block';
            statusEl.innerHTML = 'ë²ˆì—­ì„ ì‹œì‘í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
            
            fetch(`/api/media/${currentMedia}/translate`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `âœ… ${data.message}`;
                    
                    // ë²ˆì—­ ì§„í–‰ ìƒíƒœ ëª¨ë‹ˆí„°ë§
                    translationInterval = setInterval(checkTranslationProgress, 2000);
                    
                    // ë¬¸ì¥ ë‹¤ì‹œ ë¡œë“œ
                    setTimeout(() => {
                        loadGroupedSentences(currentMedia);
                    }, 1000);
                } else {
                    statusEl.innerHTML = `âŒ ë²ˆì—­ ì‹¤íŒ¨: ${data.error}`;
                    btnEl.disabled = false;
                    btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
                }
            })
            .catch(error => {
                console.error('Translation error:', error);
                statusEl.innerHTML = 'âŒ ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                btnEl.disabled = false;
                btnEl.textContent = 'ğŸ”„ ìë™ ë²ˆì—­ ì‹œì‘';
            });
        }
        
        function checkTranslationProgress() {
            if (!currentMedia) {
                clearInterval(translationInterval);
                return;
            }
            
            fetch(`/api/media/${currentMedia}/translation-status`)
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('translationStatus');
                    
                    if (data.status === 'translating' && data.current) {
                        statusEl.innerHTML = data.current;
                    } else if (data.untranslated === 0) {
                        clearInterval(translationInterval);
                        statusEl.innerHTML = 'âœ… ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!';
                        checkTranslationStatus();
                        
                        // ë¬¸ì¥ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë²ˆì—­ í‘œì‹œ
                        loadGroupedSentences(currentMedia);
                    }
                })
                .catch(error => {
                    console.error('Progress check error:', error);
                    clearInterval(translationInterval);
                });
        }
        
        function applyVADVisualization() {
            if (!vadFilterData) return;
            
            // ë¬¸ì¥ ìš”ì†Œë“¤ì— VAD ê²°ê³¼ ì‹œê°í™”
            document.querySelectorAll('.sentence-item').forEach(sentenceEl => {
                const index = parseInt(sentenceEl.dataset.index);
                const sentence = sentences[index];
                
                if (sentence && sentence.vad_ratio !== undefined) {
                    if (sentence.vad_filtered) {
                        // ìŒì„± êµ¬ê°„ - ê°•ì¡° í‘œì‹œ
                        sentenceEl.style.borderLeft = '3px solid #4CAF50';
                        sentenceEl.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
                    } else {
                        // ë¬´ìŒ êµ¬ê°„ - íë¦¬ê²Œ í‘œì‹œ
                        sentenceEl.style.borderLeft = '3px solid #757575';
                        sentenceEl.style.backgroundColor = 'rgba(117, 117, 117, 0.1)';
                        sentenceEl.style.opacity = '0.6';
                    }
                    
                    // VAD ë¹„ìœ¨ í‘œì‹œ
                    const vadInfo = document.createElement('div');
                    vadInfo.className = 'vad-info';
                    vadInfo.style.fontSize = '0.7em';
                    vadInfo.style.color = sentence.vad_filtered ? '#4CAF50' : '#757575';
                    vadInfo.textContent = `ìŒì„±: ${(sentence.vad_ratio * 100).toFixed(0)}%`;
                    sentenceEl.appendChild(vadInfo);
                }
            });
        }
        
        function toggleBookmark(index, event) {
            event.stopPropagation();
            if (!currentMedia) return;
            
            const sentence = sentences[index];
            console.log('toggleBookmark called:', index, sentence);
            
            if (!sentence || !sentence.id) {
                console.error('No sentence ID found:', sentence);
                return;
            }
            
            fetch(`/api/media/${currentMedia}/sentences/${sentence.id}/bookmark`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sentences[index].bookmark = data.bookmark ? 1 : 0;
                    
                    // ë¶ë§ˆí¬ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                    const sentenceEl = document.querySelector(`[data-index="${index}"]`);
                    if (sentenceEl) {
                        if (data.bookmark) {
                            sentenceEl.classList.add('bookmarked');
                        } else {
                            sentenceEl.classList.remove('bookmarked');
                        }
                    }
                    
                    updateBookmarkedList();
                }
            })
            .catch(error => {
                console.error('Bookmark toggle error:', error);
            });
        }
        
        function updateBookmarkedList() {
            const bookmarkedEl = document.getElementById('bookmarkedList');
            const bookmarked = sentences.filter(s => s.bookmark);
            
            if (bookmarked.length === 0) {
                bookmarkedEl.innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                bookmarkedEl.innerHTML = bookmarked.map(s => 
                    `<div class="bookmarked-item">${s.id}. ${s.english}</div>`
                ).join('');
            }
        }
        
        function repeatCurrent() {
            if (currentSentenceIndex >= 0) {
                playSentence(currentSentenceIndex);
            }
        }
        
        function playBookmarked() {
            const bookmarked = sentences.filter(s => s.bookmark);
            if (bookmarked.length > 0) {
                let index = 0;
                
                function playNext() {
                    if (index < bookmarked.length) {
                        const sentenceIndex = sentences.findIndex(s => s.id === bookmarked[index].id);
                        playSentence(sentenceIndex);
                        index++;
                        setTimeout(playNext, 3000); // 3ì´ˆ ê°„ê²©
                    }
                }
                
                playNext();
            }
        }
        
        function extractMP3(index, event) {
            event.stopPropagation();
            const sentence = sentences[index];
            
            if (!currentMedia || !sentence.id) {
                alert('ë¬¸ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ì¶”ì¶œì¤‘...';
            btn.disabled = true;
            
            fetch(`/api/sentence/${currentMedia}/${sentence.id}/extract-mp3`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
                    const a = document.createElement('a');
                    a.href = data.download_url;
                    a.download = data.filename;
                    a.click();
                    
                    console.log(`MP3 ì¶”ì¶œ ì™„ë£Œ: ${data.filename}`);
                } else {
                    console.error('MP3 ì¶”ì¶œ ì‹¤íŒ¨:', data.error);
                }
            })
            .catch(error => {
                console.error('MP3 ì¶”ì¶œ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
        
        function extractMP4(index, event) {
            event.stopPropagation();
            const sentence = sentences[index];
            
            if (!currentMedia || !sentence.id) {
                alert('ë¬¸ì¥ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'ì¶”ì¶œì¤‘...';
            btn.disabled = true;
            
            fetch(`/api/sentence/${currentMedia}/${sentence.id}/extract-mp4`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`MP4 ì¶”ì¶œ ì™„ë£Œ: ${data.output_path}`);
                    alert(`MP4 íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${data.output_path}`);
                } else {
                    console.error('MP4 ì¶”ì¶œ ì‹¤íŒ¨:', data.error);
                }
            })
            .catch(error => {
                console.error('MP4 ì¶”ì¶œ ì˜¤ë¥˜:', error);
            })
            .finally(() => {
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                btn.textContent = originalText;
                btn.disabled = false;
            });
        }
        
        function exportBookmarks() {
            const bookmarked = sentences.filter(s => s.bookmark);
            if (bookmarked.length === 0) {
                alert('ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const content = bookmarked.map(s => `${s.id}. ${s.english}\n${s.korean}`).join('\n\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bookmarked_sentences.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        let searchTimeout = null;
        
        function handleSearchInput(event) {
            const query = event.target.value.trim();
            const resultsEl = document.getElementById('searchResults');
            
            // ì´ì „ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (query.length < 3) {
                resultsEl.innerHTML = '';
                showAllSentences();
                return;
            }
            
            // 300ms ì§€ì—° í›„ ê²€ìƒ‰ ì‹¤í–‰
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }
        
        function performSearch(query) {
            const resultsEl = document.getElementById('searchResults');
            
            if (!sentences || sentences.length === 0) {
                resultsEl.innerHTML = 'ê²€ìƒ‰í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ì˜ì–´ì™€ í•œêµ­ì–´ì—ì„œ ê²€ìƒ‰
            const matches = sentences.filter(sentence => {
                const englishMatch = sentence.english && sentence.english.toLowerCase().includes(query.toLowerCase());
                const koreanMatch = sentence.korean && sentence.korean.includes(query);
                return englishMatch || koreanMatch;
            });
            
            if (matches.length === 0) {
                resultsEl.innerHTML = `"${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                hideAllSentences();
                return;
            }
            
            resultsEl.innerHTML = `${matches.length}ê°œ ë¬¸ì¥ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            
            // ë§¤ì¹­ëœ ë¬¸ì¥ë§Œ í‘œì‹œ
            highlightSearchResults(matches, query);
        }
        
        function highlightSearchResults(matches, query) {
            // ëª¨ë“  ë¬¸ì¥ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.style.display = 'none';
            });
            
            // ë§¤ì¹­ëœ ë¬¸ì¥ë§Œ í‘œì‹œí•˜ê³  í•˜ì´ë¼ì´íŠ¸
            matches.forEach(match => {
                const sentenceEl = document.querySelector(`[data-sentence-id="${match.id}"]`);
                if (sentenceEl) {
                    sentenceEl.style.display = 'block';
                    
                    // ê²€ìƒ‰ì–´ í•˜ì´ë¼ì´íŠ¸
                    const englishEl = sentenceEl.querySelector('.sentence-text');
                    const koreanEl = sentenceEl.querySelector('.sentence-korean');
                    
                    if (englishEl) {
                        const highlightedEnglish = highlightText(match.english, query);
                        englishEl.innerHTML = highlightedEnglish;
                    }
                    
                    if (koreanEl && match.korean) {
                        const highlightedKorean = highlightText(match.korean, query);
                        koreanEl.innerHTML = highlightedKorean;
                    }
                    
                    // ë¶€ëª¨ ì±•í„°/ì”¬ë„ í‘œì‹œ
                    let parent = sentenceEl.closest('.scene-section');
                    while (parent) {
                        parent.style.display = 'block';
                        const content = parent.querySelector('.scene-content, .chapter-content');
                        if (content) content.style.display = 'block';
                        parent = parent.closest('.chapter-section');
                    }
                }
            });
        }
        
        function highlightText(text, query) {
            if (!text || !query) return text;
            
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffd700; color: #000;">$1</mark>');
        }
        
        function showAllSentences() {
            document.querySelectorAll('.sentence-item, .scene-section, .chapter-section').forEach(item => {
                item.style.display = 'block';
            });
            
            // ì›ë³¸ í…ìŠ¤íŠ¸ ë³µì›
            sentences.forEach(sentence => {
                const sentenceEl = document.querySelector(`[data-sentence-id="${sentence.id}"]`);
                if (sentenceEl) {
                    const englishEl = sentenceEl.querySelector('.sentence-text');
                    const koreanEl = sentenceEl.querySelector('.sentence-korean');
                    
                    if (englishEl) englishEl.innerHTML = sentence.english;
                    if (koreanEl) koreanEl.innerHTML = sentence.korean || '';
                }
            });
        }
        
        function hideAllSentences() {
            document.querySelectorAll('.sentence-item').forEach(item => {
                item.style.display = 'none';
            });
        }
        
        function deleteMedia(mediaId, event) {
            event.stopPropagation();
            
            if (!confirm('ì •ë§ë¡œ ì´ ë¯¸ë””ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ë¬¸ì¥ê³¼ ë¶ë§ˆí¬ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }
            
            fetch(`/api/media/${mediaId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // í˜„ì¬ ì„ íƒëœ ë¯¸ë””ì–´ì¸ ê²½ìš° ì´ˆê¸°í™”
                    if (currentMedia == mediaId) {
                        currentMedia = null;
                        document.querySelector('.media-player').style.display = 'none';
                        document.getElementById('sentenceList').innerHTML = '';
                        document.getElementById('bookmarkedList').innerHTML = '<p style="color: #858585;">ë¶ë§ˆí¬ëœ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        document.getElementById('processingOptions').style.display = 'none';
                        document.getElementById('searchSection').style.display = 'none';
                        document.getElementById('subtitleGenerationMenu').style.display = 'none';
                        document.getElementById('uploadSection').style.display = 'block';
                    }
                    
                    // ë¯¸ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    loadMediaList();
                    
                    console.log('Media deleted successfully');
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
    </script>
</body>
</html>